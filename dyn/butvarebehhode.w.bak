&ANALYZE-SUSPEND _VERSION-NUMBER AB_v10r12 GUI
/* Procedure Description
"Basic Window Template

Use this template to create a new window. Alter this default template or create new ones to accomodate your needs for different default sizes and/or attributes."
*/
&ANALYZE-RESUME
/* Connected Databases 
          skotex           PROGRESS
*/
&Scoped-define WINDOW-NAME C-Win
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CUSTOM _DEFINITIONS C-Win 
/*********************************************************************
* Copyright (C) 2001 by Progress Software Corporation ("PSC"),       *
* 14 Oak Park, Bedford, MA 01730, and other contributors as listed   *
* below.  All Rights Reserved.                                       *
*                                                                    *
* The Initial Developer of the Original Code is PSC.  The Original   *
* Code is Progress IDE code released to open source December 1, 2000.*
*                                                                    *
* The contents of this file are subject to the Possenet Public       *
* License Version 1.0 (the "License"); you may not use this file     *
* except in compliance with the License.  A copy of the License is   *
* available as of the date of this notice at                         *
* http://www.possenet.org/license.html                               *
*                                                                    *
* Software distributed under the License is distributed on an "AS IS"*
* basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. You*
* should refer to the License for the specific language governing    *
* rights and limitations under the License.                          *
*                                                                    *
* Contributors:                                                      *
*                                                                    *
*********************************************************************/
/*------------------------------------------------------------------------

  File: 

  Description: 

  Input Parameters:
      <none>

  Output Parameters:
      <none>

  Author: 

  Created: 

------------------------------------------------------------------------*/
/*          This .W file was created with the Progress AppBuilder.      */
/*----------------------------------------------------------------------*/

/* Create an unnamed pool to store all the widgets created 
     by this procedure. This is a good default which assures
     that this procedure's triggers and internal procedures 
     will execute in this procedure's storage, and that proper
     cleanup will occur on deletion of the procedure. */

CREATE WIDGET-POOL.

/* ***************************  Definitions  ************************** */

/* Parameters Definitions ---                                           */

/* Local Variable Definitions ---                                       */
{incl/ean13bc.i}

DEF VAR bOK                    AS LOG    NO-UNDO.
DEF VAR ix                     AS INT    NO-UNDO.
DEF VAR iReturn                AS INT    NO-UNDO.
DEF VAR bHKinst                AS LOG    NO-UNDO.
DEF VAR cCL                    AS CHAR   NO-UNDO.
DEF VAR bAlleTrans             AS LOG    NO-UNDO.

DEF VAR iStartWeek             AS INT    NO-UNDO.
DEF VAR iEndWeek               AS INT    NO-UNDO.
DEF VAR cButikkListe           AS CHAR   NO-UNDO INIT "174,260".
DEF VAR cStrListe              AS CHAR   NO-UNDO INIT "XS,S,M,L,XL,XXL".
DEF VAR iBestVarebeh           AS INT    NO-UNDO INIT 1. /* Vareh.bok type bestilling */
                              
DEF VAR hToolbar               AS HANDLE NO-UNDO.
DEF VAR hUpdToolbar            AS HANDLE NO-UNDO.
DEF VAR hBestHodeToolbar       AS HANDLE NO-UNDO.
DEF VAR hRegStatTransToolbar   AS HANDLE NO-UNDO.
DEF VAR hBrowseListe           AS HANDLE NO-UNDO.
DEF VAR cBrwListFlds           AS CHAR   NO-UNDO.
DEF VAR cBrwListJoin           AS CHAR   NO-UNDO.
DEF VAR hBrowseLinje           AS HANDLE NO-UNDO.
DEF VAR hBrowseBestHode        AS HANDLE NO-UNDO.
DEF VAR hBrowseAndreBest       AS HANDLE NO-UNDO.
DEF VAR hBrowseRegStat         AS HANDLE NO-UNDO.
DEF VAR hBrowseRegStatTrans    AS HANDLE NO-UNDO.
DEF VAR hFieldMap              AS HANDLE NO-UNDO.
DEF VAR hFieldMapLinje         AS HANDLE NO-UNDO.
DEF VAR hFieldMapBestHode      AS HANDLE NO-UNDO.
DEF VAR hFieldMapRegStat       AS HANDLE NO-UNDO.
DEF VAR hFieldMapRegStatTrans  AS HANDLE NO-UNDO.
DEF VAR hBuffLinje             AS HANDLE NO-UNDO.
DEF VAR hSearchListe           AS HANDLE NO-UNDO.
DEF VAR hSearchLinje           AS HANDLE NO-UNDO.
DEF VAR hWindow                AS HANDLE NO-UNDO.
DEF VAR hColumn                AS HANDLE NO-UNDO.
DEF VAR hNavVarebehToolBar     AS HANDLE NO-UNDO.
DEF VAR hLagerBestButton       AS HANDLE NO-UNDO.
DEF VAR hEtikettVindu          AS HANDLE NO-UNDO.

DEF VAR wArtBasRecid           AS RECID  NO-UNDO.

DEF VAR cCurrSelectBuffer      AS CHAR   NO-UNDO.
DEF VAR iSelectorSourcCount    AS INT    NO-UNDO.
DEF VAR cHuvGrAvdelingList     AS CHAR   NO-UNDO.
DEF VAR cVarGrHuvGrList        AS CHAR   NO-UNDO.
DEF VAR cLevBasRowIdList       AS CHAR   NO-UNDO.
DEF VAR cLevBasIdList          AS CHAR   NO-UNDO.
DEF VAR cAvdelingRowIdList     AS CHAR   NO-UNDO.
DEF VAR cAvdelingIdList        AS CHAR   NO-UNDO.
DEF VAR cHuvGrRowIdList        AS CHAR   NO-UNDO.
DEF VAR cHuvGrIdList           AS CHAR   NO-UNDO.
DEF VAR cVarGrRowIdList        AS CHAR   NO-UNDO.
DEF VAR cVarGrIdList           AS CHAR   NO-UNDO.
DEF VAR cButikerRowIdList      AS CHAR   NO-UNDO.
DEF VAR cButikerIdList         AS CHAR   NO-UNDO.
DEF VAR bNewArt                AS LOG    NO-UNDO.
DEF VAR bAlt-S                 AS LOG    NO-UNDO.
DEF VAR cInitPrisProfil        AS CHAR   NO-UNDO.
DEF VAR cBestTypeDesc          AS CHAR   NO-UNDO.
DEF VAR cInnlevTypeDesc        AS CHAR   NO-UNDO.
DEF VAR cAlle                  AS CHAR   NO-UNDO.
DEF VAR cKode                  AS CHAR   NO-UNDO.
DEF VAR cTmpKode               AS CHAR   NO-UNDO.
DEF VAR cTekst                 AS CHAR   NO-UNDO.
DEF VAR cVPILevKortNavnLevNr   AS CHAR   NO-UNDO.

DEF VAR cAdgang                AS CHAR   NO-UNDO.
DEF VAR hTLdet                 AS HANDLE NO-UNDO.
DEF VAR hVisBilde              AS HANDLE NO-UNDO.
DEF VAR hArtikkelkort          AS HANDLE NO-UNDO.
DEF VAR hArtikkelKopi          AS HANDLE NO-UNDO.
DEF VAR hBufArtStr             AS HANDLE NO-UNDO.
                              
DEF VAR iTab                   AS INT    NO-UNDO.
                              
DEF VAR cState                 AS CHAR   NO-UNDO.
DEF VAR cVarebehRowIdList      AS CHAR   NO-UNDO.
DEF VAR cVarebehIdList         AS CHAR   NO-UNDO.
                              
DEF VAR hUtvalg                AS HANDLE NO-UNDO.
DEF VAR bUtvalgIsMaster        AS LOG    NO-UNDO.
DEF VAR cBtnUtvalgHandles      AS CHAR   NO-UNDO.
DEF VAR cBtnHentUtvalgHandles  AS CHAR   NO-UNDO.
DEF VAR fArtikkelNr            AS DEC    NO-UNDO.
DEF VAR rRowIdLinje            AS ROWID  NO-UNDO.
DEF VAR cBildeKatalog          AS CHAR   NO-UNDO.
DEF VAR cVarebehLinjeJoin      AS CHAR   NO-UNDO.
DEF VAR cAktivitetJoin         AS CHAR   NO-UNDO.
DEF VAR cBestHodeJoin          AS CHAR   NO-UNDO.
DEF VAR cVarebehLBuffAndFlds   AS CHAR   NO-UNDO.
DEF VAR cVarebehLinjeThodeJoin AS CHAR   NO-UNDO.
DEF VAR cVarebehLinjeTransJoin AS CHAR   NO-UNDO.
DEF VAR hKalkyleButton         AS HANDLE NO-UNDO.
DEF VAR hStrekkodeButton       AS HANDLE NO-UNDO.

DEF VAR hStrekkode             AS HANDLE NO-UNDO.

DEF VAR cStatFieldHandles      AS CHAR   NO-UNDO.
DEF VAR cStatFieldNames        AS CHAR   NO-UNDO.
DEF VAR cStatFieldPrefixList   AS CHAR   NO-UNDO.
DEF VAR cPrefixedStatFields    AS CHAR   NO-UNDO.
DEF VAR cBestViewFields        AS CHAR   NO-UNDO.
DEF VAR cInnlevViewFields      AS CHAR   NO-UNDO.
DEF VAR cModellFarge           AS CHAR   NO-UNDO.
DEF VAR cModellArtList         AS CHAR   NO-UNDO.
DEF VAR iModIdx                AS INT    NO-UNDO.

DEFINE STREAM Stream1.

DEF TEMP-TABLE ttBildeData
    FIELD BildNr    AS INT
    FIELD Teller    AS INT
    FIELD RawData   AS RAW
    FIELD RowIdent  AS CHAR
    .
DEF VAR hBufBildeData AS HANDLE.
hBufBildeData = BUFFER ttBildeData:HANDLE.

DEF TEMP-TABLE ttVarebehLinjeTrans NO-UNDO
    FIELD VarebehNr    AS DEC
    FIELD ArtikkelNr   AS DEC
    FIELD ButikkNr     AS INT
    FIELD kode         AS CHAR.
DEF VAR httVarebehLinjeTrans AS HANDLE NO-UNDO.
httVarebehLinjeTrans = BUFFER ttVarebehLinjeTrans:HANDLE:TABLE-HANDLE.

DEF TEMP-TABLE TT_VareBehBestLinje NO-UNDO LIKE VareBehBestLinje RCODE-INFORMATION.
DEF VAR hBufftt_varebehbestlinje AS HANDLE NO-UNDO.
hBufftt_varebehbestlinje = BUFFER tt_VarebehBestLinje:HANDLE.

DEF TEMP-TABLE ttSort
    FIELD iSeq    AS INT
    FIELD cValue  AS CHAR.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&ANALYZE-SUSPEND _UIB-PREPROCESSOR-BLOCK 

/* ********************  Preprocessor Definitions  ******************** */

&Scoped-define PROCEDURE-TYPE Window
&Scoped-define DB-AWARE no

/* Name of first Frame and/or Browse and/or first Query                 */
&Scoped-define FRAME-NAME DEFAULT-FRAME

/* Internal Tables (found by Frame, Query & Browse Queries)             */
&Scoped-define INTERNAL-TABLES VareBehHode

/* Definitions for FRAME frmFilter                                      */
&Scoped-define QUERY-STRING-frmFilter FOR EACH VareBehHode SHARE-LOCK
&Scoped-define OPEN-QUERY-frmFilter OPEN QUERY frmFilter FOR EACH VareBehHode SHARE-LOCK.
&Scoped-define TABLES-IN-QUERY-frmFilter VareBehHode
&Scoped-define FIRST-TABLE-IN-QUERY-frmFilter VareBehHode


/* Standard List Definitions                                            */
&Scoped-Define ENABLED-OBJECTS rectToolBar rectUpdToolbar rectVarebeh ~
VarebehNr VarebehBeskrivelse Beskrivelse MesseNr MesseBeskrivelse KortNavn 
&Scoped-Define DISPLAYED-OBJECTS VarebehNr VarebehBeskrivelse VarebehType ~
Beskrivelse MesseNr MesseBeskrivelse ProfilNr KortNavn 

/* Custom List Definitions                                              */
/* List-1,List-2,List-3,List-4,List-5,List-6                            */

/* _UIB-PREPROCESSOR-BLOCK-END */
&ANALYZE-RESUME


/* ************************  Function Prototypes ********************** */

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD FiksStorl C-Win 
FUNCTION FiksStorl RETURNS CHARACTER
  ( input wStorl as char )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD FreezeWin C-Win 
FUNCTION FreezeWin RETURNS LOGICAL
  ( INPUT ibFreeze AS LOG )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD getArtNr C-Win 
FUNCTION getArtNr RETURNS DECIMAL
  ( /* parameter-definitions */ )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD getLevNr C-Win 
FUNCTION getLevNr RETURNS CHARACTER
  ( /* parameter-definitions */ )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD getStorl C-Win 
FUNCTION getStorl RETURNS CHARACTER
  ( /* parameter-definitions */ )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD getVarebehNr C-Win 
FUNCTION getVarebehNr RETURNS DECIMAL
  ( /* parameter-definitions */ )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD InitUtvalgToVarebeh C-Win 
FUNCTION InitUtvalgToVarebeh RETURNS LOGICAL
  ( INPUT ihUtvalg         AS HANDLE,
    INPUT ibUtvalgIsMaster AS LOG )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD Registrerat C-Win 
FUNCTION Registrerat RETURNS LOGICAL
  ( INPUT ipRow AS INTEGER )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD SetTabStrip C-Win 
FUNCTION SetTabStrip RETURNS LOGICAL
  ( /* parameter-definitions */ )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD SettHentUtvalgSensitive C-Win 
FUNCTION SettHentUtvalgSensitive RETURNS LOGICAL
  ( INPUT ibSensitive AS LOG )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD SettLevUkeEllerDag C-Win 
FUNCTION SettLevUkeEllerDag RETURNS LOGICAL
  ( /* parameter-definitions */ )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD SettUtvalgSensitive C-Win 
FUNCTION SettUtvalgSensitive RETURNS LOGICAL
  ( INPUT ibSensitive AS LOG )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD SkrivEtikett C-Win 
FUNCTION SkrivEtikett RETURNS LOGICAL
  ( INPUT icListe AS CHAR )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD TabStripChanged C-Win 
FUNCTION TabStripChanged RETURNS LOGICAL
  ( INPUT iiTab AS INT )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD UtvalgIsMaster C-Win 
FUNCTION UtvalgIsMaster RETURNS LOGICAL
  ( /* parameter-definitions */ )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION-FORWARD ViewStat C-Win 
FUNCTION ViewStat RETURNS LOGICAL
  ( INPUT ibView AS LOG )  FORWARD.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


/* ***********************  Control Definitions  ********************** */

/* Define the widget handle for the window                              */
DEFINE VAR C-Win AS WIDGET-HANDLE NO-UNDO.

/* Definitions of handles for OCX Containers                            */
DEFINE VARIABLE Grid AS WIDGET-HANDLE NO-UNDO.
DEFINE VARIABLE chGrid AS COMPONENT-HANDLE NO-UNDO.
DEFINE VARIABLE IMAGE-Sko AS WIDGET-HANDLE NO-UNDO.
DEFINE VARIABLE chIMAGE-Sko AS COMPONENT-HANDLE NO-UNDO.
DEFINE VARIABLE TabStrip AS WIDGET-HANDLE NO-UNDO.
DEFINE VARIABLE chTabStrip AS COMPONENT-HANDLE NO-UNDO.

/* Definitions of the field level widgets                               */
DEFINE VARIABLE Beskrivelse AS CHARACTER FORMAT "X(30)" 
     VIEW-AS FILL-IN 
     SIZE 21.6 BY 1.

DEFINE VARIABLE KortNavn AS CHARACTER FORMAT "X(15)" 
     VIEW-AS FILL-IN 
     SIZE 16.2 BY 1.

DEFINE VARIABLE MesseBeskrivelse AS CHARACTER FORMAT "X(40)" 
     VIEW-AS FILL-IN 
     SIZE 20 BY 1.

DEFINE VARIABLE MesseNr AS DECIMAL FORMAT ">>>>>>>9" INITIAL 0 
     LABEL "Messe" 
     VIEW-AS FILL-IN 
     SIZE 13.2 BY 1.

DEFINE VARIABLE ProfilNr AS INTEGER FORMAT "zz9" INITIAL 0 
     LABEL "Prisprofil" 
     VIEW-AS FILL-IN 
     SIZE 6.2 BY 1.

DEFINE VARIABLE VarebehBeskrivelse AS CHARACTER FORMAT "X(40)" 
     VIEW-AS FILL-IN 
     SIZE 22.8 BY 1.

DEFINE VARIABLE VarebehNr AS DECIMAL FORMAT ">>>>>>>>>>>>9" INITIAL 0 
     LABEL "Vareh." 
     VIEW-AS FILL-IN 
     SIZE 16.2 BY 1.

DEFINE VARIABLE VarebehType AS INTEGER FORMAT ">>9" INITIAL 0 
     LABEL "Type" 
     VIEW-AS FILL-IN 
     SIZE 4.2 BY 1.

DEFINE RECTANGLE rectNavVarebeh
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 31.8 BY 1.19.

DEFINE RECTANGLE rectToolBar
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 9.2 BY 1.19.

DEFINE RECTANGLE rectUpdToolbar
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 16.6 BY 1.19.

DEFINE RECTANGLE rectVarebeh
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 200 BY 1.52.

DEFINE BUTTON btnButikker 
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE BUTTON btnSokMesseNr  NO-FOCUS
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE BUTTON btnSokProfilNr  NO-FOCUS
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE VARIABLE VarebehNotat AS CHARACTER 
     VIEW-AS EDITOR SCROLLBAR-VERTICAL
     SIZE 60 BY 10.19 NO-UNDO.

DEFINE VARIABLE ButikkListe AS CHARACTER FORMAT "X(60)" 
     LABEL "Butikkliste" 
     VIEW-AS FILL-IN 
     SIZE 55 BY 1.

DEFINE VARIABLE EkstRef AS CHARACTER FORMAT "X(60)" 
     LABEL "Ekst.referanse" 
     VIEW-AS FILL-IN 
     SIZE 60 BY 1.

DEFINE VARIABLE OppdatAv AS CHARACTER FORMAT "X(15)" 
     VIEW-AS FILL-IN 
     SIZE 17 BY 1.

DEFINE VARIABLE OppdatDato AS DATE FORMAT "99/99/99" 
     LABEL "Dato/BrukerId" 
     VIEW-AS FILL-IN 
     SIZE 13.2 BY 1.

DEFINE RECTANGLE RECT-1
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 65 BY 1.43.

DEFINE VARIABLE Oppdatert AS LOGICAL INITIAL no 
     LABEL "Oppdatert" 
     VIEW-AS TOGGLE-BOX
     SIZE 16 BY .81 NO-UNDO.

DEFINE BUTTON btnBlankFilter 
     LABEL "Blank filter" 
     SIZE 15 BY 1.14.

DEFINE BUTTON btnLev-2 
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE BUTTON btnSokFiltMesseNr  NO-FOCUS
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE BUTTON btnSokFiltProfilNr  NO-FOCUS
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE VARIABLE cmbVarebehType AS CHARACTER FORMAT "X(256)":U 
     LABEL "Type" 
     VIEW-AS COMBO-BOX INNER-LINES 5
     LIST-ITEM-PAIRS "Alle","Alle",
                     "Bestilling","Bestilling",
                     "Varemottak","Varemottak"
     DROP-DOWN-LIST
     SIZE 18 BY 1 NO-UNDO.

DEFINE VARIABLE fi-cEkstRef AS CHARACTER FORMAT "X(20)" 
     LABEL "Ekst.referanse" 
     VIEW-AS FILL-IN 
     SIZE 22 BY 1.

DEFINE VARIABLE fi-cVarebehBeskrivelse AS CHARACTER FORMAT "X(40)" 
     LABEL "Beskrivelse" 
     VIEW-AS FILL-IN 
     SIZE 42 BY 1.

DEFINE VARIABLE fi-fMesseNr AS DECIMAL FORMAT ">>>>>>>9" INITIAL 0 
     LABEL "MesseNr" 
     VIEW-AS FILL-IN 
     SIZE 13.2 BY 1.

DEFINE VARIABLE fi-fProfilNr AS INTEGER FORMAT "zz9" INITIAL 0 
     LABEL "Prisprofil" 
     VIEW-AS FILL-IN 
     SIZE 13.2 BY 1.

DEFINE VARIABLE fi-fVarebehNr AS DECIMAL FORMAT ">>>>>>>9":U INITIAL 0 
     LABEL "Vareh.nr" 
     VIEW-AS FILL-IN 
     SIZE 17 BY 1 NO-UNDO.

DEFINE VARIABLE ListeSokLevNamn AS CHARACTER FORMAT "X(256)":U 
     VIEW-AS FILL-IN 
     SIZE 32 BY 1 NO-UNDO.

DEFINE VARIABLE ListeSokLevNr AS INTEGER FORMAT "zzzzz9" INITIAL 0 
     LABEL "Leverandør" 
     VIEW-AS FILL-IN 
     SIZE 10.4 BY 1.

DEFINE BUTTON btnAvdeling 
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE BUTTON btnBlankLinjeFilter 
     LABEL "Blank filter" 
     SIZE 15 BY 1.1.

DEFINE BUTTON btnHuvGr 
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE BUTTON btnLev 
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE BUTTON btnSplitBarY 
     IMAGE-UP FILE "bmp/tabdown.bmp":U NO-FOCUS FLAT-BUTTON
     LABEL "Button 1" 
     SIZE 197.6 BY .48.

DEFINE BUTTON btnVarGr 
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE BUTTON btnVarGr-2 
     LABEL "..." 
     SIZE 4.4 BY 1.

DEFINE BUTTON button-slett 
     LABEL "Slett rad" 
     SIZE 15 BY 1.14.

DEFINE VARIABLE fi-cAndreBestLabel AS CHARACTER FORMAT "X(256)":U INITIAL "Andre aktive bestillinger for artikkel:" 
      VIEW-AS TEXT 
     SIZE 34 BY .62 NO-UNDO.

DEFINE VARIABLE Kode AS CHARACTER FORMAT "X(20)" 
     LABEL "Strekkode" 
     VIEW-AS FILL-IN 
     SIZE 23.4 BY 1.

DEFINE VARIABLE LevUke AS INTEGER FORMAT ">>>>>9" INITIAL 0 
     LABEL "Levuke" 
     VIEW-AS FILL-IN 
     SIZE 10.4 BY 1.

DEFINE VARIABLE sokAktBeskrivelse AS CHARACTER FORMAT "X(256)":U 
     VIEW-AS FILL-IN 
     SIZE 32 BY 1 NO-UNDO.

DEFINE VARIABLE sokAktNr AS INTEGER FORMAT "zzzzz9" INITIAL 0 
     LABEL "Aktivitet" 
     VIEW-AS FILL-IN 
     SIZE 10.4 BY 1.

DEFINE VARIABLE sokAvdelingNavn AS CHARACTER FORMAT "X(256)":U 
     VIEW-AS FILL-IN 
     SIZE 32 BY 1 NO-UNDO.

DEFINE VARIABLE sokAvdelingNr AS INTEGER FORMAT "zzzzz9" INITIAL 0 
     LABEL "Avdeling" 
     VIEW-AS FILL-IN 
     SIZE 10.4 BY 1.

DEFINE VARIABLE sokBeskr AS CHARACTER FORMAT "X(256)":U 
     LABEL "Art.navn" 
     VIEW-AS FILL-IN 
     SIZE 43 BY 1 NO-UNDO.

DEFINE VARIABLE sokFraEdato AS DATE FORMAT "99/99/99":U 
     LABEL "Endret dato" 
     VIEW-AS FILL-IN 
     SIZE 14.6 BY 1 NO-UNDO.

DEFINE VARIABLE sokFraRegDatoBestInnl AS DATE FORMAT "99/99/99" 
     LABEL "Reg.dato, bestillinger og varemottak. NB bestemmer beregning av sum pr art" 
     VIEW-AS FILL-IN 
     SIZE 14.6 BY 1.

DEFINE VARIABLE sokFraVPIdato AS DATE FORMAT "99/99/99":U 
     LABEL "VPI dato" 
     VIEW-AS FILL-IN 
     SIZE 14.6 BY 1 NO-UNDO.

DEFINE VARIABLE sokHg AS INTEGER FORMAT "zzzzz9" INITIAL 0 
     LABEL "Hovedgruppe" 
     VIEW-AS FILL-IN 
     SIZE 10.4 BY 1.

DEFINE VARIABLE sokHgBeskr AS CHARACTER FORMAT "X(256)":U 
     VIEW-AS FILL-IN 
     SIZE 32 BY 1 NO-UNDO.

DEFINE VARIABLE sokLevNamn AS CHARACTER FORMAT "X(256)":U 
     VIEW-AS FILL-IN 
     SIZE 32 BY 1 NO-UNDO.

DEFINE VARIABLE sokLevNr AS INTEGER FORMAT "zzzzz9" INITIAL 0 
     LABEL "Leverandør" 
     VIEW-AS FILL-IN 
     SIZE 10.4 BY 1.

DEFINE VARIABLE sokLinjeMerknad AS CHARACTER FORMAT "X(256)":U 
     LABEL "Merknad" 
     VIEW-AS FILL-IN 
     SIZE 43 BY 1 NO-UNDO.

DEFINE VARIABLE sokTilEdato AS DATE FORMAT "99/99/99":U 
     VIEW-AS FILL-IN 
     SIZE 14.6 BY 1 NO-UNDO.

DEFINE VARIABLE sokTilRegDatoBestInnl AS DATE FORMAT "99/99/99" 
     VIEW-AS FILL-IN 
     SIZE 14.6 BY 1.

DEFINE VARIABLE sokTilVPIdato AS DATE FORMAT "99/99/99":U 
     VIEW-AS FILL-IN 
     SIZE 14.6 BY 1 NO-UNDO.

DEFINE VARIABLE sokVg AS INTEGER FORMAT "zzzzz9" INITIAL 0 
     LABEL "Varegruppe" 
     VIEW-AS FILL-IN 
     SIZE 10.4 BY 1.

DEFINE VARIABLE sokVgBeskr AS CHARACTER FORMAT "X(256)":U 
     VIEW-AS FILL-IN 
     SIZE 32 BY 1 NO-UNDO.

DEFINE VARIABLE SumPris AS DECIMAL FORMAT "->,>>>,>>9":U INITIAL 0 
     LABEL "Total pris" 
     VIEW-AS FILL-IN 
     SIZE 17.4 BY 1 NO-UNDO.

DEFINE VARIABLE SumVarekost AS DECIMAL FORMAT "->,>>>,>>9":U INITIAL 0 
     LABEL "Total varekost" 
     VIEW-AS FILL-IN 
     SIZE 17.4 BY 1 NO-UNDO.

DEFINE RECTANGLE rectBestHodeToolbar
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 18 BY 1.19.

DEFINE RECTANGLE rectBrowseLinje
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 198 BY 9.05.

DEFINE RECTANGLE RectBrowseSearchLinje
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 22 BY 1.19.

DEFINE RECTANGLE rectBrwAndreBest
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 82.2 BY 4.19.

DEFINE RECTANGLE rectBrwBestHode
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 114 BY 4.19.

DEFINE RECTANGLE rectStatFields
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 196.4 BY 1.67.

DEFINE VARIABLE tbRepeat AS LOGICAL INITIAL no 
     LABEL "Gjenta ALT-S" 
     VIEW-AS TOGGLE-BOX
     SIZE 16.8 BY .81 TOOLTIP "Gjenta søk etter artikkel automatisk når en registrering er ferdig" NO-UNDO.

DEFINE VARIABLE tbUpdateStat AS LOGICAL INITIAL no 
     LABEL "Vis statistikk" 
     VIEW-AS TOGGLE-BOX
     SIZE 16 BY .67 NO-UNDO.

DEFINE RECTANGLE rectBrowseListe
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 198 BY 21.91.

DEFINE RECTANGLE RectBrowseSearchListe
     EDGE-PIXELS 2 GRAPHIC-EDGE  NO-FILL 
     SIZE 22 BY 1.19.

/* Query definitions                                                    */
&ANALYZE-SUSPEND
DEFINE QUERY frmFilter FOR 
      VareBehHode SCROLLING.
&ANALYZE-RESUME

/* ************************  Frame Definitions  *********************** */

DEFINE FRAME DEFAULT-FRAME
     VarebehNr AT ROW 2.81 COL 9.8 COLON-ALIGNED HELP
          "Varebehnummer"
     VarebehBeskrivelse AT ROW 2.81 COL 26.2 COLON-ALIGNED HELP
          "Kort beskrivelse av Varebehen" NO-LABEL
     VarebehType AT ROW 2.81 COL 55.8 COLON-ALIGNED HELP
          "Varebehtype"
     Beskrivelse AT ROW 2.81 COL 60 COLON-ALIGNED HELP
          "Kort beskrivelse av Varebehtypen" NO-LABEL
     MesseNr AT ROW 2.81 COL 90.8 COLON-ALIGNED HELP
          "Messenummer"
     MesseBeskrivelse AT ROW 2.81 COL 104.2 COLON-ALIGNED HELP
          "Navn eller kort beskrivelse av messen." NO-LABEL
     ProfilNr AT ROW 2.81 COL 134 COLON-ALIGNED HELP
          "Prisprofil"
     KortNavn AT ROW 2.81 COL 140.4 COLON-ALIGNED HELP
          "Kort betegnelse på prisprofilen" NO-LABEL
     rectToolBar AT ROW 1.14 COL 191
     rectUpdToolbar AT ROW 1.14 COL 1.4
     rectVarebeh AT ROW 2.57 COL 1
     rectNavVarebeh AT ROW 1.14 COL 159
    WITH 1 DOWN NO-BOX KEEP-TAB-ORDER OVERLAY 
         SIDE-LABELS NO-UNDERLINE THREE-D 
         AT COL 1 ROW 1
         SIZE 200.2 BY 32.91.

DEFINE FRAME frmLinje
     tbUpdateStat AT ROW 27.33 COL 4
     sokAvdelingNr AT ROW 1.05 COL 16 COLON-ALIGNED HELP
          "Varegruppe"
     sokAvdelingNavn AT ROW 1.05 COL 26.8 COLON-ALIGNED NO-LABEL
     btnSplitBarY AT ROW 21.76 COL 1.4
     sokHg AT ROW 2.1 COL 16 COLON-ALIGNED HELP
          "Varegruppe"
     sokHgBeskr AT ROW 2.14 COL 26.8 COLON-ALIGNED NO-LABEL
     sokVg AT ROW 3.19 COL 16 COLON-ALIGNED HELP
          "Varegruppe"
     sokVgBeskr AT ROW 3.19 COL 26.8 COLON-ALIGNED NO-LABEL
     sokAktNr AT ROW 4.29 COL 16 COLON-ALIGNED HELP
          "Varegruppe"
     sokAktBeskrivelse AT ROW 4.29 COL 26.8 COLON-ALIGNED NO-LABEL
     sokLevNr AT ROW 1.1 COL 76.4 COLON-ALIGNED HELP
          "Varegruppe"
     sokLevNamn AT ROW 1.1 COL 87.2 COLON-ALIGNED NO-LABEL
     sokBeskr AT ROW 2.14 COL 76.4 COLON-ALIGNED
     sokLinjeMerknad AT ROW 3.19 COL 76.4 COLON-ALIGNED
     sokFraEdato AT ROW 1.14 COL 138 COLON-ALIGNED
     sokTilEdato AT ROW 1.14 COL 153 COLON-ALIGNED NO-LABEL
     sokFraVPIdato AT ROW 2.24 COL 138 COLON-ALIGNED
     sokTilVPIdato AT ROW 2.24 COL 153 COLON-ALIGNED NO-LABEL
     sokFraRegDatoBestInnl AT ROW 4.33 COL 138 COLON-ALIGNED HELP
          "Dato da posten ble registrert i registeret"
     sokTilRegDatoBestInnl AT ROW 4.33 COL 153 COLON-ALIGNED HELP
          "Dato da posten ble registrert i registeret" NO-LABEL
     btnAvdeling AT ROW 1.1 COL 61.2 NO-TAB-STOP 
     Kode AT ROW 5.67 COL 33.8 COLON-ALIGNED HELP
          "Strekkode inklusive sjekksiffer."
     btnHuvGr AT ROW 2.14 COL 61.2 NO-TAB-STOP 
     SumVarekost AT ROW 27.81 COL 49.6 COLON-ALIGNED
     btnVarGr AT ROW 3.19 COL 61.2 NO-TAB-STOP 
     SumPris AT ROW 27.81 COL 77.8 COLON-ALIGNED
     btnVarGr-2 AT ROW 4.29 COL 61.2 NO-TAB-STOP 
     LevUke AT ROW 16.24 COL 102 COLON-ALIGNED
     btnBlankLinjeFilter AT ROW 5.76 COL 155
     tbRepeat AT ROW 16.33 COL 180.2
     button-slett AT ROW 22.52 COL 183
     btnLev AT ROW 1.14 COL 121.6 NO-TAB-STOP 
     fi-cAndreBestLabel AT ROW 16.48 COL 115 COLON-ALIGNED NO-LABEL
     RectBrowseSearchLinje AT ROW 5.62 COL 2
     rectBrowseLinje AT ROW 6.95 COL 1
     rectBrwBestHode AT ROW 17.48 COL 1
     rectBrwAndreBest AT ROW 17.48 COL 115.8
     rectBestHodeToolbar AT ROW 16.14 COL 2
     rectStatFields AT ROW 27.48 COL 1.6
    WITH 1 DOWN NO-BOX KEEP-TAB-ORDER OVERLAY 
         SIDE-LABELS NO-UNDERLINE THREE-D 
         AT COL 2 ROW 5.48
         SCROLLABLE SIZE 198 BY 28.14.

DEFINE FRAME frmFilter
     btnSokFiltMesseNr AT ROW 3.52 COL 37.8 NO-TAB-STOP 
     cmbVarebehType AT ROW 1.24 COL 22.6 COLON-ALIGNED
     fi-fVarebehNr AT ROW 2.33 COL 22.6 COLON-ALIGNED
     fi-fMesseNr AT ROW 3.48 COL 22.6 COLON-ALIGNED HELP
          "Messenummer"
     fi-fProfilNr AT ROW 4.57 COL 22.6 COLON-ALIGNED HELP
          "Prisprofil"
     fi-cVarebehBeskrivelse AT ROW 1.24 COL 62 COLON-ALIGNED HELP
          "Kort beskrivelse av Varebehen"
     fi-cEkstRef AT ROW 2.33 COL 62 COLON-ALIGNED HELP
          "Ekstern referanse til pakkseddel, ordre o.l."
     ListeSokLevNr AT ROW 3.43 COL 62 COLON-ALIGNED HELP
          "Varegruppe"
     btnLev-2 AT ROW 3.43 COL 74.6 NO-TAB-STOP 
     ListeSokLevNamn AT ROW 3.43 COL 77.2 COLON-ALIGNED NO-LABEL
     btnBlankFilter AT ROW 3.14 COL 142
     btnSokFiltProfilNr AT ROW 4.67 COL 37.8 NO-TAB-STOP 
    WITH 1 DOWN NO-BOX KEEP-TAB-ORDER OVERLAY 
         SIDE-LABELS NO-UNDERLINE THREE-D 
         AT COL 2 ROW 5.43
         SCROLLABLE SIZE 198 BY 4.86.

DEFINE FRAME frmListe
     rectBrowseListe AT ROW 2.43 COL 1
     RectBrowseSearchListe AT ROW 1.1 COL 1
    WITH 1 DOWN NO-BOX KEEP-TAB-ORDER OVERLAY 
         SIDE-LABELS NO-UNDERLINE THREE-D 
         AT COL 2 ROW 10.24
         SCROLLABLE SIZE 198 BY 23.38.

DEFINE FRAME frmDetalj
     btnSokMesseNr AT ROW 7.62 COL 34.4 NO-TAB-STOP 
     VarebehNr AT ROW 1.24 COL 19 COLON-ALIGNED HELP
          "Varebehnummer"
          LABEL "Vareh.Nr" FORMAT ">>>>>>>>>>>>9"
          VIEW-AS FILL-IN 
          SIZE 20.2 BY 1
     OppdatDato AT ROW 1.48 COL 122.6 COLON-ALIGNED
     OppdatAv AT ROW 1.48 COL 136.6 COLON-ALIGNED NO-LABEL
     Oppdatert AT ROW 1.62 COL 93.4 HELP
          "Varebeh er oppdatert"
     VarebehType AT ROW 2.33 COL 19 COLON-ALIGNED HELP
          "Varebehtype"
          LABEL "Vareh.type" FORMAT "zz9"
          VIEW-AS FILL-IN 
          SIZE 6.2 BY 1
     Beskrivelse AT ROW 2.33 COL 25.8 COLON-ALIGNED HELP
          "Kort beskrivelse av Varebehtypen" NO-LABEL FORMAT "X(30)"
          VIEW-AS FILL-IN 
          SIZE 36.2 BY 1
     ButikkListe AT ROW 3.38 COL 19 COLON-ALIGNED
     btnButikker AT ROW 3.38 COL 76.4 NO-TAB-STOP 
     ProfilNr AT ROW 4.43 COL 19 COLON-ALIGNED HELP
          "Prisprofil"
          LABEL "Prisprofil" FORMAT "zz9"
          VIEW-AS FILL-IN 
          SIZE 6.2 BY 1
     KortNavn AT ROW 4.43 COL 29.8 COLON-ALIGNED HELP
          "Kort betegnelse på prisprofilen" NO-LABEL FORMAT "X(15)"
          VIEW-AS FILL-IN 
          SIZE 32.2 BY 1
     VarebehBeskrivelse AT ROW 5.48 COL 19 COLON-ALIGNED HELP
          "Kort beskrivelse av Varebehen"
          LABEL "Beskrivelse" FORMAT "X(40)"
          VIEW-AS FILL-IN 
          SIZE 60 BY 1
     EkstRef AT ROW 6.52 COL 19 COLON-ALIGNED HELP
          "Ekstern referanse"
     MesseNr AT ROW 7.62 COL 19 COLON-ALIGNED HELP
          "Messenummer"
          LABEL "MesseNr" FORMAT ">>>>>>>9"
          VIEW-AS FILL-IN 
          SIZE 13.2 BY 1
     MesseBeskrivelse AT ROW 7.62 COL 37 COLON-ALIGNED HELP
          "Navn eller kort beskrivelse av messen." NO-LABEL FORMAT "X(40)"
          VIEW-AS FILL-IN 
          SIZE 42 BY 1
     VarebehNotat AT ROW 8.76 COL 21 NO-LABEL
     btnSokProfilNr AT ROW 4.43 COL 27.2 NO-TAB-STOP 
     RECT-1 AT ROW 1.24 COL 92
    WITH 1 DOWN NO-BOX KEEP-TAB-ORDER OVERLAY 
         SIDE-LABELS NO-UNDERLINE THREE-D 
         AT COL 2 ROW 5.48
         SCROLLABLE SIZE 198 BY 28.14.


/* *********************** Procedure Settings ************************ */

&ANALYZE-SUSPEND _PROCEDURE-SETTINGS
/* Settings for THIS-PROCEDURE
   Type: Window Template
   Allow: Basic,Browse,DB-Fields,Window,Query
   Other Settings: COMPILE
 */
&ANALYZE-RESUME _END-PROCEDURE-SETTINGS

/* *************************  Create Window  ************************** */

&ANALYZE-SUSPEND _CREATE-WINDOW
IF SESSION:DISPLAY-TYPE = "GUI":U THEN
  CREATE WINDOW C-Win ASSIGN
         HIDDEN             = YES
         TITLE              = "Varehåndtering"
         HEIGHT             = 32.81
         WIDTH              = 200.4
         MAX-HEIGHT         = 57.14
         MAX-WIDTH          = 320
         VIRTUAL-HEIGHT     = 57.14
         VIRTUAL-WIDTH      = 320
         RESIZE             = yes
         SCROLL-BARS        = no
         STATUS-AREA        = yes
         BGCOLOR            = ?
         FGCOLOR            = ?
         KEEP-FRAME-Z-ORDER = yes
         THREE-D            = yes
         MESSAGE-AREA       = no
         SENSITIVE          = yes.
ELSE {&WINDOW-NAME} = CURRENT-WINDOW.
/* END WINDOW DEFINITION                                                */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CUSTOM _INCLUDED-LIB C-Win 
/* ************************* Included-Libraries *********************** */

{incl/devmode.i}
{incl/CustDevMode.i}

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME




/* ***********  Runtime Attributes and AppBuilder Settings  *********** */

&ANALYZE-SUSPEND _RUN-TIME-ATTRIBUTES
/* SETTINGS FOR WINDOW C-Win
  NOT-VISIBLE,,RUN-PERSISTENT                                           */
/* REPARENT FRAME */
ASSIGN FRAME frmDetalj:FRAME = FRAME DEFAULT-FRAME:HANDLE
       FRAME frmFilter:FRAME = FRAME DEFAULT-FRAME:HANDLE
       FRAME frmLinje:FRAME = FRAME DEFAULT-FRAME:HANDLE
       FRAME frmListe:FRAME = FRAME DEFAULT-FRAME:HANDLE.

/* SETTINGS FOR FRAME DEFAULT-FRAME
                                                                        */
ASSIGN 
       Beskrivelse:READ-ONLY IN FRAME DEFAULT-FRAME        = TRUE.

ASSIGN 
       KortNavn:READ-ONLY IN FRAME DEFAULT-FRAME        = TRUE.

ASSIGN 
       MesseBeskrivelse:READ-ONLY IN FRAME DEFAULT-FRAME        = TRUE.

ASSIGN 
       MesseNr:READ-ONLY IN FRAME DEFAULT-FRAME        = TRUE.

/* SETTINGS FOR FILL-IN ProfilNr IN FRAME DEFAULT-FRAME
   NO-ENABLE                                                            */
/* SETTINGS FOR RECTANGLE rectNavVarebeh IN FRAME DEFAULT-FRAME
   NO-ENABLE                                                            */
ASSIGN 
       rectNavVarebeh:HIDDEN IN FRAME DEFAULT-FRAME           = TRUE.

ASSIGN 
       VarebehBeskrivelse:READ-ONLY IN FRAME DEFAULT-FRAME        = TRUE.

ASSIGN 
       VarebehNr:READ-ONLY IN FRAME DEFAULT-FRAME        = TRUE.

/* SETTINGS FOR FILL-IN VarebehType IN FRAME DEFAULT-FRAME
   NO-ENABLE                                                            */
/* SETTINGS FOR FRAME frmDetalj
                                                                        */
ASSIGN 
       FRAME frmDetalj:HEIGHT           = 28.14
       FRAME frmDetalj:WIDTH            = 198.

ASSIGN 
       Beskrivelse:READ-ONLY IN FRAME frmDetalj        = TRUE.

ASSIGN 
       KortNavn:READ-ONLY IN FRAME frmDetalj        = TRUE.

/* SETTINGS FOR FILL-IN MesseBeskrivelse IN FRAME frmDetalj
   NO-ENABLE                                                            */
/* SETTINGS FOR FILL-IN OppdatAv IN FRAME frmDetalj
   NO-ENABLE                                                            */
/* SETTINGS FOR FILL-IN OppdatDato IN FRAME frmDetalj
   NO-ENABLE                                                            */
ASSIGN 
       VarebehNotat:RETURN-INSERTED IN FRAME frmDetalj  = TRUE.

/* SETTINGS FOR FILL-IN VarebehNr IN FRAME frmDetalj
   NO-ENABLE                                                            */
/* SETTINGS FOR FRAME frmFilter
   L-To-R,COLUMNS                                                       */
ASSIGN 
       FRAME frmFilter:HEIGHT           = 4.86
       FRAME frmFilter:WIDTH            = 198.

/* SETTINGS FOR FILL-IN ListeSokLevNamn IN FRAME frmFilter
   NO-ENABLE                                                            */
/* SETTINGS FOR FRAME frmLinje
   Custom                                                               */
ASSIGN 
       FRAME frmLinje:HEIGHT           = 28.14
       FRAME frmLinje:WIDTH            = 198.

ASSIGN 
       btnSplitBarY:MOVABLE IN FRAME frmLinje          = TRUE.

/* SETTINGS FOR BUTTON button-slett IN FRAME frmLinje
   NO-ENABLE                                                            */
ASSIGN 
       button-slett:HIDDEN IN FRAME frmLinje           = TRUE.

/* SETTINGS FOR FRAME frmListe
                                                                        */
ASSIGN 
       FRAME frmListe:HEIGHT           = 23.38
       FRAME frmListe:WIDTH            = 198.

IF SESSION:DISPLAY-TYPE = "GUI":U AND VALID-HANDLE(C-Win)
THEN C-Win:HIDDEN = yes.

/* _RUN-TIME-ATTRIBUTES-END */
&ANALYZE-RESUME


/* Setting information for Queries and Browse Widgets fields            */

&ANALYZE-SUSPEND _QUERY-BLOCK FRAME DEFAULT-FRAME
/* Query rebuild information for FRAME DEFAULT-FRAME
     _Options          = "SHARE-LOCK KEEP-EMPTY"
     _Query            is NOT OPENED
*/  /* FRAME DEFAULT-FRAME */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _QUERY-BLOCK FRAME frmDetalj
/* Query rebuild information for FRAME frmDetalj
     _Options          = "SHARE-LOCK KEEP-EMPTY"
     _Query            is NOT OPENED
*/  /* FRAME frmDetalj */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _QUERY-BLOCK FRAME frmFilter
/* Query rebuild information for FRAME frmFilter
     _TblList          = "SkoTex.VareBehHode"
     _Query            is OPENED
*/  /* FRAME frmFilter */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _QUERY-BLOCK FRAME frmLinje
/* Query rebuild information for FRAME frmLinje
     _Options          = "SHARE-LOCK KEEP-EMPTY"
     _Query            is NOT OPENED
*/  /* FRAME frmLinje */
&ANALYZE-RESUME

 


/* **********************  Create OCX Containers  ********************** */

&ANALYZE-SUSPEND _CREATE-DYNAMIC

&IF "{&OPSYS}" = "WIN32":U AND "{&WINDOW-SYSTEM}" NE "TTY":U &THEN

CREATE CONTROL-FRAME TabStrip ASSIGN
       FRAME           = FRAME DEFAULT-FRAME:HANDLE
       ROW             = 4.33
       COLUMN          = 1
       HEIGHT          = 29.48
       WIDTH           = 200
       HIDDEN          = no
       SENSITIVE       = yes.

CREATE CONTROL-FRAME IMAGE-Sko ASSIGN
       FRAME           = FRAME frmLinje:HANDLE
       ROW             = 1.05
       COLUMN          = 171.4
       HEIGHT          = 4.81
       WIDTH           = 27
       HIDDEN          = no
       SENSITIVE       = yes.

CREATE CONTROL-FRAME Grid ASSIGN
       FRAME           = FRAME frmLinje:HANDLE
       ROW             = 22.43
       COLUMN          = 2
       HEIGHT          = 4.71
       WIDTH           = 196
       HIDDEN          = no
       SENSITIVE       = yes.
      TabStrip:NAME = "TabStrip":U .
/* TabStrip OCXINFO:CREATE-CONTROL from: {1EFB6596-857C-11D1-B16A-00C0F0283628} type: TabStrip */
      IMAGE-Sko:NAME = "IMAGE-Sko":U .
/* IMAGE-Sko OCXINFO:CREATE-CONTROL from: {9A93B740-C96B-11D0-8883-444553540000} type: Picbuf */
      Grid:NAME = "Grid":U .
/* Grid OCXINFO:CREATE-CONTROL from: {C0A63B86-4B21-11d3-BD95-D426EF2C7949} type: VSFlexGrid */
      TabStrip:MOVE-AFTER(KortNavn:HANDLE IN FRAME DEFAULT-FRAME).
      IMAGE-Sko:MOVE-AFTER(btnBlankLinjeFilter:HANDLE IN FRAME frmLinje).
      Grid:MOVE-AFTER(button-slett:HANDLE IN FRAME frmLinje).

&ENDIF

&ANALYZE-RESUME /* End of _CREATE-DYNAMIC */


/* ************************  Control Triggers  ************************ */

&Scoped-define SELF-NAME C-Win
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL C-Win C-Win
ON END-ERROR OF C-Win /* Varehåndtering */
OR ENDKEY OF {&WINDOW-NAME} ANYWHERE DO:
  /* This case occurs when the user presses the "Esc" key.
     In a persistently run window, just ignore this.  If we did not, the
     application would exit. */
  IF THIS-PROCEDURE:PERSISTENT THEN RETURN NO-APPLY.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL C-Win C-Win
ON WINDOW-CLOSE OF C-Win /* Varehåndtering */
DO:
  /* This event will close the window and terminate the procedure.  */
  APPLY "CLOSE":U TO THIS-PROCEDURE.
  RETURN NO-APPLY.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL C-Win C-Win
ON WINDOW-RESIZED OF C-Win /* Varehåndtering */
DO:
  DEF VAR rRowid AS ROWID NO-UNDO.
  IF hFieldMap:AVAIL THEN rRowId = hFieldMap:ROWID.

  DYNAMIC-FUNCTION("setWidgetResize",THIS-PROCEDURE:CURRENT-WINDOW,THIS-PROCEDURE:CURRENT-WINDOW,"Resize","").

  IF NOT hFieldMap:AVAIL AND rRowid NE ? THEN
    hFieldMap:FIND-BY-ROWID(rRowid).

  CASE iTab:
    WHEN 1 THEN DO:
      FRAME frmFilter:MOVE-TO-TOP().
      FRAME frmListe:MOVE-TO-TOP().
    END.
    WHEN 2 THEN
      FRAME frmDetalj:MOVE-TO-TOP().
    WHEN 3 THEN 
      FRAME frmLinje:MOVE-TO-TOP().
  END CASE.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmLinje
&Scoped-define SELF-NAME btnAvdeling
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnAvdeling C-Win
ON CHOOSE OF btnAvdeling IN FRAME frmLinje /* ... */
DO:
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
  RUN JBoxDSelector.w (THIS-PROCEDURE,0,
                      "Avdeling;AvdelingNr;AvdelingNavn",
                      "where true",
                      INPUT-OUTPUT cAvdelingRowIdList,
                      "AvdelingNr",
                      INPUT-OUTPUT cAvdelingIdList,
                      "","",
                      OUTPUT bOK).
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.

  IF bOk THEN DO:
    IF NUM-ENTRIES(cAvdelingRowidList) > 1 THEN 
      ASSIGN sokAvdelingNr:SCREEN-VALUE   = "0"
             sokAvdelingNavn:SCREEN-VALUE = STRING(NUM-ENTRIES(cAvdelingRowidList)) + " av " +
                                       STRING(iSelectorSourcCount)
                                       .
    ELSE
      ASSIGN sokAvdelingNr:SCREEN-VALUE   = cAvdelingIdList
             sokAvdelingNavn:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","Avdeling;AvdelingNavn","WHERE AvdelingNr = " + sokAvdelingNr:SCREEN-VALUE).
    RUN OpenQuery.
  END.

END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmFilter
&Scoped-define SELF-NAME btnBlankFilter
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnBlankFilter C-Win
ON CHOOSE OF btnBlankFilter IN FRAME frmFilter /* Blank filter */
DO:
  ASSIGN
      cmbVarebehType:SCREEN-VALUE = "0"
      fi-fVarebehNr:SCREEN-VALUE = ""
      fi-fProfilNr:SCREEN-VALUE = ""
      fi-fMesseNr:SCREEN-VALUE = ""
      fi-cVarebehBeskrivelse:SCREEN-VALUE = ""
      ListeSokLevNr:SCREEN-VALUE = ""
      ListeSokLevNamn:SCREEN-VALUE = ""
      .
   RUN OpenQuery.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmLinje
&Scoped-define SELF-NAME btnBlankLinjeFilter
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnBlankLinjeFilter C-Win
ON CHOOSE OF btnBlankLinjeFilter IN FRAME frmLinje /* Blank filter */
DO:
  ASSIGN sokAvdelingNavn:SCREEN-VALUE   = ""
         sokAvdelingNr:SCREEN-VALUE     = "0" 
         sokHg:SCREEN-VALUE             = "0" 
         sokHgBeskr:SCREEN-VALUE        = "" 
         sokVg:SCREEN-VALUE             = "0" 
         sokVgBeskr:SCREEN-VALUE        = ""
         sokLevNr:SCREEN-VALUE          = "0"
         sokLevNamn:SCREEN-VALUE        = ""
         sokBeskr:SCREEN-VALUE          = ""
         sokAktNr:SCREEN-VALUE          = "0"
         sokAktBeskrivelse:SCREEN-VALUE = ""
         sokFraEdato:SCREEN-VALUE       = ?
         sokTilEdato:SCREEN-VALUE       = ?
         sokFraVPIdato:SCREEN-VALUE     = ?
         sokTilVPIdato:SCREEN-VALUE     = ?
         sokFraRegDatoBestInnl:SCREEN-VALUE = ?
         sokTilRegDatoBestInnl:SCREEN-VALUE = ?
         .
   RUN OpenQuery.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmDetalj
&Scoped-define SELF-NAME btnButikker
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnButikker C-Win
ON CHOOSE OF btnButikker IN FRAME frmDetalj /* ... */
DO:
  RUN VelgButikker("edit",OUTPUT bOk).
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmLinje
&Scoped-define SELF-NAME btnHuvGr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnHuvGr C-Win
ON CHOOSE OF btnHuvGr IN FRAME frmLinje /* ... */
DO:

  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
  RUN JBoxSelector.w (THIS-PROCEDURE,0,
                      "HuvGr;Hg;HgBeskr,Avdeling;AvdelingNr;AvdelingNavn",
                      "where true, first Avdeling OF HuvGr NO-LOCK " + 
                         (IF cAvdelingRowIdList NE "" THEN
                            "WHERE CAN-DO('" + cAvdelingRowIdList + "',STRING(ROWID(Avdeling)))"
                          ELSE ""),
                      INPUT-OUTPUT cHuvGrRowIdList,
                      "Hg",
                      INPUT-OUTPUT cHuvGrIdList,
                      "","",
                      OUTPUT bOK).
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.


  IF bOk THEN DO:
    IF NUM-ENTRIES(cHuvGrRowidList) > 1 THEN 
      ASSIGN sokHg:SCREEN-VALUE   = "0"
             sokHgBeskr:SCREEN-VALUE = STRING(NUM-ENTRIES(cHuvGrRowidList)) + " av " +
                                       STRING(iSelectorSourcCount)
                                       .
    ELSE
      ASSIGN sokHg:SCREEN-VALUE   = cHuvGrIdList
             sokHgBeskr:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","HuvGr;HgBeskr","WHERE Hg = " + sokHg:SCREEN-VALUE).
    RUN OpenQuery.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME btnLev
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnLev C-Win
ON CHOOSE OF btnLev IN FRAME frmLinje /* ... */
DO:
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
  RUN JBoxSelector.w (THIS-PROCEDURE,0,
                      "LevBas;levnr;levnamn;KjedeAvtale|Kjedeavtale|J/N",
                      "where true",
                      INPUT-OUTPUT cLevBasRowIdList,
                      "Levnr",
                      INPUT-OUTPUT cLevBasIdList,
                      "","",
                      OUTPUT bOK).
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.

  IF bOk THEN DO:
    IF NUM-ENTRIES(cLevBasRowidList) > 1 THEN 
      ASSIGN sokLevNr:SCREEN-VALUE   = "0"
             sokLevNamn:SCREEN-VALUE = STRING(NUM-ENTRIES(cLevBasRowidList)) + " av " +
                                       STRING(iSelectorSourcCount)
                                       .
    ELSE
      ASSIGN sokLevNr:SCREEN-VALUE   = cLevBasIdList
             sokLevNamn:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","LevBas;LevNamn","WHERE LevNr = " + sokLevNr:SCREEN-VALUE).
    RUN OpenQuery.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmFilter
&Scoped-define SELF-NAME btnLev-2
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnLev-2 C-Win
ON CHOOSE OF btnLev-2 IN FRAME frmFilter /* ... */
DO:
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
  RUN JBoxSelector.w (THIS-PROCEDURE,0,
                      "LevBas;levnr;levnamn;KjedeAvtale|Kjedeavtale|J/N",
                      "where true",
                      INPUT-OUTPUT cLevBasRowIdList,
                      "Levnr",
                      INPUT-OUTPUT cLevBasIdList,
                      "","",
                      OUTPUT bOK).
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.

  IF bOk THEN DO:
    IF NUM-ENTRIES(cLevBasRowidList) > 1 THEN 
      DYNAMIC-FUNCTION("DoMessage",0,0,"Kan bare søke på en leverandør her","","").
    ELSE DO:
      ASSIGN ListeSokLevNr:SCREEN-VALUE   = cLevBasIdList
             ListeSokLevNamn:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","LevBas;LevNamn","WHERE LevNr = " + ListeSokLevNr:SCREEN-VALUE).
      RUN OpenQuery.
    END.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME btnSokFiltMesseNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnSokFiltMesseNr C-Win
ON CHOOSE OF btnSokFiltMesseNr IN FRAME frmFilter /* ... */
OR F10 OF MesseNr
DO:
  DEF VAR cLookupValue AS CHAR NO-UNDO.

  /* Syntaks: Param1: <Tabell>;<Felt>;<Felt>...,<Tabell>;<Felt>;<Felt>...              */
  /*          Param2: <Where sats> m/Join                                              */
  /*          Param3: <Returfelt1>[;<Returfelt2>;......],<Filterfelt1>[;<Filterfelt2>] (Settes i cLookupValue) */
  /* Kalkulerte felt kan også benyttes, label, format o.l..       */
  cLookupValue = "MesseNr".
  RUN JBoxDLookup.w ("Messe;MesseNr;MesseBeskrivelse","where true",INPUT-OUTPUT cLookupValue).

  IF cLookupValue NE "" THEN 
  DO:
    fi-fMesseNr:SCREEN-VALUE = cLookupValue.
    RUN OpenQuery.
  END.
  
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME btnSokFiltProfilNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnSokFiltProfilNr C-Win
ON CHOOSE OF btnSokFiltProfilNr IN FRAME frmFilter /* ... */
OR F10 OF ProfilNr
DO:
  DEF VAR cLookupValue AS CHAR NO-UNDO.

  /* Syntaks: Param1: <Tabell>;<Felt>;<Felt>...,<Tabell>;<Felt>;<Felt>...              */
  /*          Param2: <Where sats> m/Join                                              */
  /*          Param3: <Returfelt1>[;<Returfelt2>;......],<Filterfelt1>[;<Filterfelt2>] (Settes i cLookupValue) */
  /* Kalkulerte felt kan også benyttes, label, format o.l..       */
  cLookupValue = "ProfilNr".
  RUN JBoxDLookup.w ("PrisProfil;ProfilNr;KortNavn","where true",INPUT-OUTPUT cLookupValue).

  IF cLookupValue NE "" THEN 
  DO:
    fi-fProfilNr:SCREEN-VALUE = cLookupValue.
    RUN OpenQuery.
  END.
  
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmDetalj
&Scoped-define SELF-NAME btnSokMesseNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnSokMesseNr C-Win
ON CHOOSE OF btnSokMesseNr IN FRAME frmDetalj /* ... */
OR F10 OF MesseNr
DO:
  DEF VAR cLookupValue AS CHAR NO-UNDO.

  /* Syntaks: Param1: <Tabell>;<Felt>;<Felt>...,<Tabell>;<Felt>;<Felt>...              */
  /*          Param2: <Where sats> m/Join                                              */
  /*          Param3: <Returfelt1>[;<Returfelt2>;......],<Filterfelt1>[;<Filterfelt2>] (Settes i cLookupValue) */
  /* Kalkulerte felt kan også benyttes, label, format o.l..       */
  cLookupValue = "MesseNr".
  RUN JBoxDLookup.w ("Messe;MesseNr;MesseBeskrivelse","where true",INPUT-OUTPUT cLookupValue).

  IF cLookupValue NE "" THEN 
  DO:
    MesseNr:SCREEN-VALUE = cLookupValue.
    APPLY "ANY-PRINTABLE":U TO MesseNr.
    APPLY "TAB":U TO MesseNr.
  END.
  
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME btnSokProfilNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnSokProfilNr C-Win
ON CHOOSE OF btnSokProfilNr IN FRAME frmDetalj /* ... */
OR F10 OF ProfilNr
DO:
  DEF VAR cLookupValue AS CHAR NO-UNDO.

  /* Syntaks: Param1: <Tabell>;<Felt>;<Felt>...,<Tabell>;<Felt>;<Felt>...              */
  /*          Param2: <Where sats> m/Join                                              */
  /*          Param3: <Returfelt1>[;<Returfelt2>;......],<Filterfelt1>[;<Filterfelt2>] (Settes i cLookupValue) */
  /* Kalkulerte felt kan også benyttes, label, format o.l..       */
  cLookupValue = "ProfilNr".
  RUN JBoxDLookup.w ("PrisProfil;ProfilNr;KortNavn","where true",INPUT-OUTPUT cLookupValue).

  IF cLookupValue NE "" THEN 
  DO:
    ProfilNr:SCREEN-VALUE = cLookupValue.
    APPLY "ANY-PRINTABLE":U TO ProfilNr.
    APPLY "TAB":U TO ProfilNr.
  END.
  
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmLinje
&Scoped-define SELF-NAME btnSplitBarY
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnSplitBarY C-Win
ON END-MOVE OF btnSplitBarY IN FRAME frmLinje /* Button 1 */
DO:
/*   DYNAMIC-FUNCTION("setNoResizeY",  THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmLinje:HANDLE, "IMAGE-Sko,brwLinje,rectBrowseLinje,rectBestHodeToolbar").  */
  DYNAMIC-FUNCTION("setSplitBarY" ,THIS-PROCEDURE:CURRENT-WINDOW, btnSplitBarY:HANDLE IN FRAME frmLinje,NO).
/*   DYNAMIC-FUNCTION("setNoResizeY",  THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmLinje:HANDLE, "IMAGE-Sko,brwLinje,rectBrowseLinje,brwBestHode,rectBrwBestHode,rectBestHodeToolbar"). */
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME btnVarGr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnVarGr C-Win
ON CHOOSE OF btnVarGr IN FRAME frmLinje /* ... */
DO:
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
  RUN JBoxSelector.w (THIS-PROCEDURE,0,
                      "VarGr;Vg;VgBeskr,HuvGr;Hg;HgBeskr",
                      "where true, first HuvGr OF VarGr NO-LOCK " + 
                         (IF cHuvGrRowIdList NE "" THEN
                            "WHERE CAN-DO('" + cHuvGrRowIdList + "',STRING(ROWID(HuvGr)))"
                          ELSE ""),
                      INPUT-OUTPUT cVarGrRowIdList,
                      "Vg",
                      INPUT-OUTPUT cVarGrIdList,
                      "","",
                      OUTPUT bOK).
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.


  IF bOk THEN DO:
    IF NUM-ENTRIES(cVarGrRowidList) > 1 THEN 
      ASSIGN sokVG:SCREEN-VALUE      = "0"
             sokVGBeskr:SCREEN-VALUE = STRING(NUM-ENTRIES(cVarGrRowidList)) + " av " +
                                       STRING(iSelectorSourcCount)
                                       .
    ELSE
      ASSIGN sokVG:SCREEN-VALUE   = cVarGrIdList
             sokVGBeskr:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","VarGr;VgBeskr","WHERE Vg = " + sokVG:SCREEN-VALUE).
    RUN OpenQuery.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME btnVarGr-2
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL btnVarGr-2 C-Win
ON CHOOSE OF btnVarGr-2 IN FRAME frmLinje /* ... */
DO:
  DEF VAR cLookupValue AS CHAR NO-UNDO.

  cLookupValue = "AktNr;Beskrivelse".

  IF sokVg:SCREEN-VALUE NE "0" THEN 
    RUN JBoxDLookup.w ("VgAkt;Vg,Aktivitet;AktNr;Beskrivelse", 
                       "WHERE Vg = " + sokVg:SCREEN-VALUE + ",first Aktivitet OF VgAkt",
                       INPUT-OUTPUT cLookupValue).
  ELSE
    RUN JBoxDLookup.w ("Aktivitet;AktNr;Beskrivelse", 
                       "where true", 
                       INPUT-OUTPUT cLookupValue).

  IF cLookupValue NE "" THEN DO:      
    ASSIGN sokAktNr:SCREEN-VALUE          = ENTRY(1,cLookupValue,"|")
           sokAktBeskrivelse:SCREEN-VALUE = ENTRY(2,cLookupValue,"|")
           .
    RUN OpenQuery.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME button-slett
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL button-slett C-Win
ON CHOOSE OF button-slett IN FRAME frmLinje /* Slett rad */
DO:  
  DEF VAR iCount AS INTE NO-UNDO.
  chGrid:TextMatrix(chGrid:ROW,1) = "0 ".
  DO iCount = 2 TO chGrid:Cols - 1:
      chGrid:TextMatrix(chGrid:ROW,iCount) = " ".
  END.
  ASSIGN chGrid:COL = chGrid:FixedCols.
  APPLY "any-printable" TO LevUke IN FRAME frmLinje.
  APPLY "ENTRY" TO Grid.
  RETURN NO-APPLY.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmFilter
&Scoped-define SELF-NAME cmbVarebehType
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL cmbVarebehType C-Win
ON VALUE-CHANGED OF cmbVarebehType IN FRAME frmFilter /* Type */
DO:
  RUN OpenQuery.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME fi-cEkstRef
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL fi-cEkstRef C-Win
ON LEAVE OF fi-cEkstRef IN FRAME frmFilter /* Ekst.referanse */
OR "TAB":U OF fi-cEkstRef
DO:
  RUN OpenQuery.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME fi-cVarebehBeskrivelse
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL fi-cVarebehBeskrivelse C-Win
ON RETURN OF fi-cVarebehBeskrivelse IN FRAME frmFilter /* Beskrivelse */
OR "TAB":U OF fi-cVarebehBeskrivelse
DO:
  RUN OpenQuery.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME fi-fMesseNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL fi-fMesseNr C-Win
ON RETURN OF fi-fMesseNr IN FRAME frmFilter /* MesseNr */
OR "TAB":U OF fi-fMesseNr
DO:
  RUN OpenQuery.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME fi-fProfilNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL fi-fProfilNr C-Win
ON RETURN OF fi-fProfilNr IN FRAME frmFilter /* Prisprofil */
OR "TAB":U OF fi-fProfilNr
DO:
  RUN OpenQuery.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME fi-fVarebehNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL fi-fVarebehNr C-Win
ON RETURN OF fi-fVarebehNr IN FRAME frmFilter /* Vareh.nr */
OR TAB OF fi-fVarebehNr DO:
  RUN OpenQuery.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmLinje
&Scoped-define SELF-NAME Grid
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL Grid C-Win OCX.KeyPress
PROCEDURE Grid.VSFlexGrid.KeyPress .
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  Required for OCX.
    KeyAscii
  Notes:       
------------------------------------------------------------------------------*/
DEFINE INPUT-OUTPUT PARAMETER p-KeyAscii AS INTEGER NO-UNDO.
DEFINE VARIABLE               wCentralValue AS INTE    NO-UNDO.
DEFINE VARIABLE               wCellValue    AS INTE    NO-UNDO.
DEFINE VARIABLE               wDiff         AS INTE    NO-UNDO.
/* ASSIGN FI-Liminn:HIDDEN IN FRAME {&FRAME-NAME} = TRUE. */

IF hFieldMap:BUFFER-FIELD("VarebehType"):BUFFER-VALUE = iBestVarebeh
   OR hFieldMapBestHode:BUFFER-FIELD("BestNr"):BUFFER-VALUE = 0 THEN
  APPLY "any-printable" TO LevUke IN FRAME frmLinje.

IF p-KeyAscii = 13 THEN DO:

    IF  chGrid:Col = chGrid:Cols - 1 AND 
        chGrid:ROW = chGrid:Rows - 1 THEN DO:
      APPLY "ENTRY" TO hLagerBestButton.
    END.
    ELSE IF chGrid:Col = chGrid:Cols - 1 THEN DO:
        chGrid:SELECT(chGrid:ROW + 1,2).
        wdiff = chGrid:CellLeft.
    END.
    ELSE DO:
      ASSIGN chGrid:Col = chGrid:Col + 1.
      wdiff = chGrid:CellLeft.
    END.
    RETURN NO-APPLY.
END.
IF p-KeyAscii = 13 AND chGrid:Col = chGrid:Cols - 1 THEN DO:
    APPLY "ENTRY" TO hLagerBestButton.
    RETURN NO-APPLY.
END.
IF p-KeyAscii = 8 OR (p-KeyAscii >= 43 AND p-KeyAscii <= 45) OR
                     (p-KeyAscii >= 48 AND p-KeyAscii <= 57)     THEN DO:
    IF p-KeyAscii = 8 OR p-KeyAscii = 44 THEN DO:
        IF INT(chGrid:Text) = 0 THEN
            RETURN NO-APPLY.
        ASSIGN wDiff = INT(chGrid:Text)
               chGrid:Text = 
             SUBSTR(chGrid:Text,1,LENGTH(chGrid:Text) - 2) + " ".
        ASSIGN wDiff = INT(chGrid:Text) - wDiff.
    END.
    ELSE IF p-KeyAscii = 43 THEN DO: /* + */
        IF INT(chGrid:Text) + 1 > 9999 THEN
            RETURN NO-APPLY.
        ASSIGN chGrid:Text = STRING(INT(chGrid:Text) + 1) + " "
               wDiff = 1.
    END.
    ELSE IF p-KeyAscii = 45 THEN DO: /* - */
/*         IF INT(chGrid:Text) = 0 THEN  */
/*             RETURN NO-APPLY.          */
        ASSIGN chGrid:Text =
            IF INT(chGrid:Text) - 1 = 0 THEN
                "" 
            ELSE            
                STRING(INT(chGrid:Text) - 1) + " ".
        ASSIGN wDiff = -1.
    END.
    ELSE IF p-KeyAscii > 48 OR (chGrid:Text > "" AND p-KeyAscii = 48) THEN DO:
        IF INT(chGrid:Text) * 10 + p-KeyAscii - 48 > 9999 THEN
            chGrid:Text.
        ELSE DO:
            ASSIGN wDiff = (INT(chGrid:Text) * 10 + p-KeyAscii - 48) - INT(chGrid:Text)
                   chGrid:Text = STRING(INT(chGrid:Text) * 10 + p-KeyAscii - 48) + " ".
        END.
    END.
/*     RUN ChangeFri IN hWindow (chGrid:Col - chGrid:FixedCols + 1,wDiff). */
    ASSIGN chGrid:TextMatrix(chGrid:ROW,1) = STRING(INT(chGrid:TextMatrix(chGrid:ROW,1)) + wDiff) + " "
           BUTTON-Slett:SENSITIVE IN FRAME {&FRAME-NAME} = INT(chGrid:TextMatrix(chGrid:ROW,1)) > 0.
END.
ELSE
    RETURN NO-APPLY.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL Grid C-Win OCX.KeyUp
PROCEDURE Grid.VSFlexGrid.KeyUp .
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  Required for OCX.
    KeyCode
    Shift
  Notes:       
------------------------------------------------------------------------------*/
DEFINE INPUT-OUTPUT PARAMETER p-KeyCode AS INTEGER NO-UNDO.
DEFINE INPUT        PARAMETER p-Shift   AS INTEGER NO-UNDO.
    
IF p-KeyCode = 76 AND p-Shift = 4 THEN
  APPLY "CHOOSE" TO hLagerBestButton.
ELSE IF p-KeyCode = 84 AND p-Shift = 4 THEN
  APPLY "CHOOSE" TO hStrekkodeButton.
ELSE IF p-KeyCode = 89 AND p-Shift = 4 THEN
  APPLY "CHOOSE" TO hKalkyleButton.

RETURN NO-APPLY.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME IMAGE-Sko
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL IMAGE-Sko C-Win OCX.DblClick
PROCEDURE IMAGE-Sko.Picbuf.DblClick .
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  None required for OCX.
  Notes:       
------------------------------------------------------------------------------*/
IF hFieldMapLinje:AVAIL THEN DO:
  IF NOT VALID-HANDLE(hVisBilde) THEN
    RUN VisBilde.w PERSIST SET hVisBilde.
  
  RUN VisBilde IN hVisBilde (hFieldMapLinje:BUFFER-FIELD("BildNr"):BUFFER-VALUE).
END.
ELSE APPLY "close" TO hVisBilde.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME Kode
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL Kode C-Win
ON RETURN OF Kode IN FRAME frmLinje /* Strekkode */
DO:
  IF NOT hFieldMap:AVAIL THEN 
    hBrowseListe:SELECT-ROW(hBrowseListe:FOCUSED-ROW).
  Kode:SCREEN-VALUE = FILL("0",13 - LENGTH(Kode:SCREEN-VALUE)) + Kode:SCREEN-VALUE.
  bOK = hFieldMapLinje:FIND-FIRST("WHERE VarebehNr = " + STRING(hFieldMap:BUFFER-FIELD("VarebehNr"):BUFFER-VALUE) 
                                 + " AND ArtikkelNr = " + DYNAMIC-FUNCTION("getFieldValues","Strekkode","WHERE kode = '" + kode:SCREEN-VALUE + "'","ArtikkelNr")
                                  ,NO-LOCK) NO-ERROR.
  IF bOK THEN DO:
    hBrowseLinje:QUERY:REPOSITION-TO-ROWID(hFieldMapLinje:ROWID) NO-ERROR.
    IF NOT ERROR-STATUS:ERROR THEN DO:
      APPLY "value-changed" TO hBrowseLinje.
    END.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmFilter
&Scoped-define SELF-NAME ListeSokLevNamn
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL ListeSokLevNamn C-Win
ON RETURN OF ListeSokLevNamn IN FRAME frmFilter
OR TAB OF sokLevNamn DO:
  IF sokLevNamn:MODIFIED THEN DO: 
    ASSIGN cLevBasRowIdList = ""
           cLevBasIdList    = ""
           .
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME ListeSokLevNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL ListeSokLevNr C-Win
ON RETURN OF ListeSokLevNr IN FRAME frmFilter /* Leverandør */
OR TAB OF ListeSokLevnr DO:
  IF ListeSokLevnr:MODIFIED THEN DO:
    ListeSokLevNamn:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","LevBas;LevNamn","WHERE LevNr = " + ListeSokLevnr:SCREEN-VALUE).
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME DEFAULT-FRAME
&Scoped-define SELF-NAME MesseNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL MesseNr C-Win
ON RETURN OF MesseNr IN FRAME DEFAULT-FRAME /* Messe */
OR "TAB" OF MesseNr
DO:
  IF SELF:MODIFIED THEN
  DO:
      MesseBeskrivelse:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldValues","Messe",
                                              "WHERE MesseNr = '" + MesseNr:SCREEN-VALUE + "'","MesseBeskrivelse").  
      APPLY "ANY-PRINTABLE":U TO MesseNr.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmDetalj
&Scoped-define SELF-NAME MesseNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL MesseNr C-Win
ON RETURN OF MesseNr IN FRAME frmDetalj /* MesseNr */
OR "TAB" OF MesseNr
DO:
  IF SELF:MODIFIED THEN
  DO:
      MesseBeskrivelse:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldValues","Messe",
                                              "WHERE MesseNr = '" + MesseNr:SCREEN-VALUE + "'","MesseBeskrivelse").  
      APPLY "ANY-PRINTABLE":U TO MesseNr.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME Oppdatert
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL Oppdatert C-Win
ON VALUE-CHANGED OF Oppdatert IN FRAME frmDetalj /* Oppdatert */
DO:
  IF INPUT Oppdatert = TRUE THEN
      ASSIGN
      OppdatDato:SCREEN-VALUE = STRING(TODAY)
      OppdatAv:SCREEN-VALUE   = USERID("SkoTex")
      .
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME DEFAULT-FRAME
&Scoped-define SELF-NAME ProfilNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL ProfilNr C-Win
ON RETURN OF ProfilNr IN FRAME DEFAULT-FRAME /* Prisprofil */
OR "TAB" OF ProfilNr
DO:
  IF SELF:MODIFIED THEN
  DO:
      KortNavn:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldValues","PrisProfil",
                                              "WHERE ProfilNr = '" + ProfilNr:SCREEN-VALUE + "'","KortNavn").  
      APPLY "ANY-PRINTABLE":U TO ProfilNr.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmDetalj
&Scoped-define SELF-NAME ProfilNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL ProfilNr C-Win
ON RETURN OF ProfilNr IN FRAME frmDetalj /* Prisprofil */
OR "TAB" OF ProfilNr
DO:
  IF SELF:MODIFIED THEN
  DO:
      KortNavn:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldValues","PrisProfil",
                                              "WHERE ProfilNr = '" + ProfilNr:SCREEN-VALUE + "'","KortNavn").  
      APPLY "ANY-PRINTABLE":U TO ProfilNr.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmLinje
&Scoped-define SELF-NAME sokAktBeskrivelse
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokAktBeskrivelse C-Win
ON RETURN OF sokAktBeskrivelse IN FRAME frmLinje
OR TAB OF sokAktBeskrivelse DO:
  IF sokAktBeskrivelse:MODIFIED THEN DO:
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokAktNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokAktNr C-Win
ON RETURN OF sokAktNr IN FRAME frmLinje /* Aktivitet */
OR TAB OF sokAktNr DO:
  IF sokAktNr:MODIFIED THEN DO: 
    sokAktNr:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","Aktivitet;Beskrivelse","WHERE AktNr = " + sokAktNr:SCREEN-VALUE).
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokAvdelingNavn
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokAvdelingNavn C-Win
ON RETURN OF sokAvdelingNavn IN FRAME frmLinje
OR TAB OF sokAvdelingNavn DO:
  IF sokAvdelingNavn:MODIFIED THEN DO: 
    ASSIGN cAvdelingRowIdList = ""
           cAvdelingIdList    = ""
           .    
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokAvdelingNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokAvdelingNr C-Win
ON RETURN OF sokAvdelingNr IN FRAME frmLinje /* Avdeling */
OR TAB OF sokAvdelingNr DO:
  IF sokAvdelingNr:MODIFIED THEN DO:
    sokAvdelingNavn:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","Avdeling;AvdelingNavn","WHERE AvdelingNr = " + sokAvdelingNr:SCREEN-VALUE).
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokBeskr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokBeskr C-Win
ON RETURN OF sokBeskr IN FRAME frmLinje /* Art.navn */
OR TAB OF sokBeskr DO:
  IF sokBeskr:MODIFIED THEN DO:
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokFraEdato
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokFraEdato C-Win
ON RETURN OF sokFraEdato IN FRAME frmLinje /* Endret dato */
OR TAB OF sokFraEdato DO:
  IF SELF:MODIFIED THEN DO: 
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokFraRegDatoBestInnl
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokFraRegDatoBestInnl C-Win
ON RETURN OF sokFraRegDatoBestInnl IN FRAME frmLinje /* Reg.dato, bestillinger og varemottak. NB bestemmer beregning av sum pr art */
OR TAB OF sokFraRegDatoBestInnl DO:
  IF SELF:MODIFIED THEN DO: 
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokFraVPIdato
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokFraVPIdato C-Win
ON RETURN OF sokFraVPIdato IN FRAME frmLinje /* VPI dato */
OR TAB OF sokFraVPIdato DO:
  IF SELF:MODIFIED THEN DO:
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokHg
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokHg C-Win
ON RETURN OF sokHg IN FRAME frmLinje /* Hovedgruppe */
OR TAB OF sokHg DO:
  IF sokHg:MODIFIED THEN DO: 
    sokHgBeskr:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","HuvGr;HgBeskr","WHERE Hg = " + sokHg:SCREEN-VALUE).
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokHgBeskr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokHgBeskr C-Win
ON RETURN OF sokHgBeskr IN FRAME frmLinje
OR TAB OF sokHgBeskr DO:
  IF sokHgBeskr:MODIFIED THEN DO:
    ASSIGN cHuvGrRowIdList = ""
           cHuvGrIdList    = ""
           .
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokLevNamn
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokLevNamn C-Win
ON RETURN OF sokLevNamn IN FRAME frmLinje
OR TAB OF sokLevNamn DO:
  IF sokLevNamn:MODIFIED THEN DO: 
    ASSIGN cLevBasRowIdList = ""
           cLevBasIdList    = ""
           .
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokLevNr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokLevNr C-Win
ON RETURN OF sokLevNr IN FRAME frmLinje /* Leverandør */
OR TAB OF sokLevNr DO:
  IF sokLevNr:MODIFIED THEN DO:
    sokLevNamn:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","LevBas;LevNamn","WHERE LevNr = " + sokLevNr:SCREEN-VALUE).
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokLinjeMerknad
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokLinjeMerknad C-Win
ON RETURN OF sokLinjeMerknad IN FRAME frmLinje /* Merknad */
OR TAB OF sokLinjeMerknad DO:
  IF sokLinjeMerknad:MODIFIED THEN DO:
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokTilEdato
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokTilEdato C-Win
ON RETURN OF sokTilEdato IN FRAME frmLinje
OR TAB OF sokTilEdato DO:
  IF SELF:MODIFIED THEN DO:
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokTilRegDatoBestInnl
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokTilRegDatoBestInnl C-Win
ON RETURN OF sokTilRegDatoBestInnl IN FRAME frmLinje
OR TAB OF sokTilRegDatoBestInnl DO:
  IF SELF:MODIFIED THEN DO:
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokTilVPIdato
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokTilVPIdato C-Win
ON RETURN OF sokTilVPIdato IN FRAME frmLinje
OR TAB OF sokTilVPIdato DO:
  IF SELF:MODIFIED THEN DO:
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokVg
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokVg C-Win
ON RETURN OF sokVg IN FRAME frmLinje /* Varegruppe */
OR TAB OF sokVg DO:
  IF sokVg:MODIFIED THEN DO: 
    sokVgBeskr:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","VarGr;VgBeskr","WHERE Vg = " + sokVg:SCREEN-VALUE).
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define SELF-NAME sokVgBeskr
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL sokVgBeskr C-Win
ON RETURN OF sokVgBeskr IN FRAME frmLinje
OR TAB OF sokVgBeskr DO:
  IF sokVgBeskr:MODIFIED THEN DO:
    ASSIGN cVarGrRowIdList = ""
           cVarGrIdList    = ""
           .
    RUN OpenQuery.
    RETURN NO-APPLY.
  END.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME DEFAULT-FRAME
&Scoped-define SELF-NAME TabStrip
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL TabStrip C-Win OCX.MouseUp
PROCEDURE TabStrip.TabStrip.MouseUp .
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  Required for OCX.
    Button
    Shift
    x
    y
  Notes:       
------------------------------------------------------------------------------*/

  DEFINE INPUT PARAMETER p-Button AS INTEGER NO-UNDO.
  DEFINE INPUT PARAMETER p-Shift  AS INTEGER NO-UNDO.
  DEFINE INPUT PARAMETER p-x      AS INTEGER NO-UNDO.
  DEFINE INPUT PARAMETER p-y      AS INTEGER NO-UNDO.

  ASSIGN
      cState = DYNAMIC-FUNCTION('getToolbarState',hUpdToolBar)
      .
  IF CAN-DO('new,modified',cstate) THEN
  DO:
      MESSAGE "Du må lagre eller avbryte før tab kan byttes."
          VIEW-AS ALERT-BOX INFO BUTTONS OK.
      ASSIGN
          iTab = 2 + 10
          .
      TabStripChanged(iTab).
      RETURN NO-APPLY.
  END.

  TabStripChanged(INT(COM-SELF:SelectedItem:Index)).

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME frmLinje
&Scoped-define SELF-NAME tbUpdateStat
&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CONTROL tbUpdateStat C-Win
ON VALUE-CHANGED OF tbUpdateStat IN FRAME frmLinje /* Vis statistikk */
DO:
  DEF VAR hWidget AS HANDLE NO-UNDO.
  ASSIGN tbUpdateStat.

  DO ix = 1 TO NUM-ENTRIES(cStatFieldHandles):
    hWidget = WIDGET-HANDLE(ENTRY(ix,cStatFieldHandles)).
    ASSIGN hWidget:HIDDEN = IF tbUpdateStat THEN FALSE ELSE TRUE
           hWidget:SCREEN-VALUE = "".
  END.
  IF tbUpdateStat THEN RUN OpenQuery.
END.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


&Scoped-define FRAME-NAME DEFAULT-FRAME
&UNDEFINE SELF-NAME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _CUSTOM _MAIN-BLOCK C-Win 


/* ***************************  Main Block  *************************** */

/* Set CURRENT-WINDOW: this will parent dialog-boxes and frames.        */
ASSIGN CURRENT-WINDOW                = {&WINDOW-NAME} 
       THIS-PROCEDURE:CURRENT-WINDOW = {&WINDOW-NAME}
       hWindow                       = {&WINDOW-NAME}.

/* The CLOSE event can be used from inside or outside the procedure to  */
/* terminate it.                                                        */
ON CLOSE OF THIS-PROCEDURE DO:
  IF VALID-HANDLE(hEtikettVindu) THEN DO:
    MESSAGE "Vil du avslutte uten å skrive ut etikettene?"
            VIEW-AS ALERT-BOX WARNING BUTTONS OK-CANCEL UPDATE bOk.
    IF NOT bOK THEN RETURN NO-APPLY.
    ELSE APPLY "close" TO hEtikettVindu.
  END.
  IF NOT DYNAMIC-FUNCTION("DoCleanUpObjects",THIS-PROCEDURE:CURRENT-WINDOW) THEN
      RETURN NO-APPLY.
  DYNAMIC-FUNCTION("setCleanUpResize",THIS-PROCEDURE:CURRENT-WINDOW).
  IF VALID-HANDLE(hVisBilde) THEN APPLY "close" TO hVisBilde.
  IF VALID-HANDLE(hArtikkelkort) THEN APPLY "close" TO hArtikkelkort.
  IF VALID-HANDLE(hStrekkode) THEN APPLY "close" TO hStrekkode.
  IF VALID-HANDLE(hArtikkelKopi) THEN APPLY "close" TO hArtikkelKopi.

  IF bUtvalgIsMaster AND VALID-HANDLE(hUtvalg) THEN 
    RUN InvalidateHandle IN hUtvalg (THIS-PROCEDURE).
  ELSE IF NOT bUtvalgIsMaster AND VALID-HANDLE(hUtvalg) THEN
    APPLY "close" TO hUtvalg.

  PUBLISH "InvalidateHandle" (THIS-PROCEDURE).
  RUN disable_UI.
END.

{incl/wintrigg.i}

/* Best default for GUI applications is...                              */
PAUSE 0 BEFORE-HIDE.

ON F2,ALT-S OF hWindow ANYWHERE 
DO:
  IF iTab = 3 AND NOT Oppdatert:CHECKED IN FRAME frmDetalj THEN DO:
    RUN d-hsok.w (OUTPUT fArtikkelNr,"JA"). 
    IF fArtikkelNr = ? OR fArtikkelNr = 0 THEN 
      RETURN NO-APPLY.

    /* --- Henter artikkel fra VPI --- */
    ELSE IF fArtikkelNr < 0 AND fArtikkelNr <> ? THEN
    DO:
      ASSIGN
          cKode = RETURN-VALUE
          bOk   = TRUE 
          .

      cVPILevKortNavnLevNr = DYNAMIC-FUNCTION("getFieldValues","EkstVPILev","WHERE EkstVPILevNr = " + STRING(ABS(INT(fArtikkelNr))),"KortNavn,EkstVPILevNr").
      IF DYNAMIC-FUNCTION("DoMessage",0,1,
                          "Artikkel er ikke registrert i lokalt artikkelregister." + CHR(10) + CHR(10) +
                          (IF cVPILevKortNavnLevNr NE ? THEN "Den finnes i VPI register til " + ENTRY(1,cVPILevKortNavnLevNr,"|")
                           ELSE "* Ukjent VPI leverandør - " + STRING(ABS(INT(fArtikkelNr))) + " *") + CHR(10) +
                          "Skal oppslag gjøres mot VPI registeret?",
                          "","") = 1 THEN DO:

        IF cVPILevKortNavnLevNr NE ? THEN DO:
          /* Bytter søkebegrep hvis det er en strekkode. */
          IF DYNAMIC-FUNCTION("getFieldValues","VPIArtBas","WHERE EkstVPILevNr = " + ENTRY(2,cVPILevKortNavnLevNr,"|") 
                                                          + " AND VareNr = '" + cKode + "'","VareNr") = ? THEN DO:
            cTmpKode = DYNAMIC-FUNCTION("getFieldValues","VPIStrekkode","WHERE EkstVPILevNr = " + ENTRY(2,cVPILevKortNavnLevNr,"|")
                                                                    + " AND Kode = '" + cKode + "'","Varenr").
            IF cTmpKode NE ? THEN
              cKode = cTmpKode.
          END.
        END.
      END.
      ELSE RETURN NO-APPLY.

      /* Kaller søkerutine */
      RUN gvpiartbas.w (
        INPUT-OUTPUT cTekst, /* Returstreng - chr(1) separert */
        "EkstVPILevNr", /* Feltliste avgrensningsfelt (kommaseparert) */
        string(ABS(INT(fArtikkelNr))), /* Feltverdier (chr(1) sep) */ 
        cKode, /* Post markøren skal stå på */
        wArtBasRecid
        ).
      IF RETURN-VALUE = "AVBRYT" THEN
          RETURN NO-APPLY.
      IF NUM-ENTRIES(cTekst,CHR(1)) >= 3 THEN
      DO:
        fArtikkelNr = DEC(DYNAMIC-FUNCTION("getFieldValues","ArtBas","WHERE ArtikkelNr = DEC('" + ENTRY(3,cTekst,CHR(1)) + "')","ArtikkelNr")) NO-ERROR.
        IF fArtikkelNr = ? THEN RETURN NO-APPLY.
      END.
    END.
    /* --- VPI henting ferdig      --- */

    /* Hent evt andre artikkler i samme modell: */
    ELSE DO:
      cModellFarge = DYNAMIC-FUNCTION("getFieldValues","ArtBas","WHERE ArtikkelNr = " + STRING(fArtikkelNr),"ModellFarge").
      IF cModellFarge NE "0" AND cModellFarge NE ? THEN DO:
        cModellArtList = DYNAMIC-FUNCTION("getFieldList","ArtBas;ArtikkelNr",
                                          "WHERE ArtBas.ModellFarge = " + cModellFarge
                                        + "  AND ArtBas.ArtikkelNr NE " + STRING(fArtikkelNr)).
        IF NUM-ENTRIES(cModellArtList,"|") > 0 THEN DO:
          IF DYNAMIC-FUNCTION("DoMessage",0,4,"Det finnes andre artikler med samme modell. Vil du også hente disse?","","") = 6 THEN
            DO iModIdx = 1 TO NUM-ENTRIES(cModellArtList,"|"):
              RUN NyArtBas (DEC(ENTRY(iModIdx,cModellArtList,"|"))).
            END.
        END.
      END.
    END.

    DO:
      RUN NyArtBas (fArtikkelNr).
      bAlt-S = TRUE.
    END.
  END.
  ELSE
    RETURN NO-APPLY.
END.

ON 'ctrl-S':U OF hWindow ANYWHERE DO: 
  IF iTab = 3 THEN DO:
    DYNAMIC-FUNCTION("DoLockWindow",THIS-PROCEDURE:CURRENT-WINDOW).
    APPLY "return".
    DYNAMIC-FUNCTION("setCurrentObject",hUpdToolBar).
    RUN NextRecord.
    DYNAMIC-FUNCTION("DoLockWindow",?).
  END.
  ELSE
    RETURN NO-APPLY.
END.

ON 'ctrl-P':U OF hWindow ANYWHERE DO: 
  IF iTab = 3 THEN DO:
    DYNAMIC-FUNCTION("DoLockWindow",THIS-PROCEDURE:CURRENT-WINDOW).
    APPLY "return".
    DYNAMIC-FUNCTION("setCurrentObject",hUpdToolBar).
    RUN PrevRecord.
    DYNAMIC-FUNCTION("DoLockWindow",?).
  END.
  ELSE
    RETURN NO-APPLY.
END.

ON 'alt-p':U OF hWindow ANYWHERE DO: 
  IF iTab = 3 AND VALID-HANDLE(hEtikettVindu) THEN 
    RUN SkrivUt IN hEtikettVindu.
  ELSE RETURN NO-APPLY.
END.
ON 'alt-q':U OF hWindow ANYWHERE DO: 
  IF iTab = 3 AND VALID-HANDLE(hEtikettVindu) THEN 
    RUN Avslutt IN hEtikettVindu.
  ELSE RETURN NO-APPLY.
END.


ON 'alt-b' OF hWindow ANYWHERE DO: 
  IF iTab = 3 AND hFieldMap:AVAIL  AND NOT Oppdatert:CHECKED IN FRAME frmDetalj THEN DO:
/*   IF iTab = 3 AND hFieldMap:AVAIL AND hFieldMap:BUFFER-FIELD("VarebehType"):BUFFER-VALUE = iBestVarebeh THEN DO: */
    DYNAMIC-FUNCTION("setCurrentObject",hBestHodeToolbar).
    RUN NewRecord.
  END.
  ELSE RETURN NO-APPLY.
END.
/* ON 'alt-i' OF hWindow ANYWHERE DO:                                                                                */
/*   IF iTab = 3 AND hFieldMap:AVAIL AND hFieldMap:BUFFER-FIELD("VarebehType"):BUFFER-VALUE NE iBestVarebeh THEN DO: */
/*     DYNAMIC-FUNCTION("setCurrentObject",hBestHodeToolbar).                                                        */
/*     RUN NewRecord.                                                                                                */
/*   END.                                                                                                            */
/*   ELSE RETURN NO-APPLY.                                                                                           */
/* END.                                                                                                              */


/* Now enable the interface and wait for the exit condition.            */
/* (NOTE: handle ERROR and END-KEY so cleanup code will always fire.    */
MAIN-BLOCK:
DO ON ERROR   UNDO MAIN-BLOCK, LEAVE MAIN-BLOCK
   ON END-KEY UNDO MAIN-BLOCK, LEAVE MAIN-BLOCK:

  DYNAMIC-FUNCTION("DoLockWindow",THIS-PROCEDURE:CURRENT-WINDOW).
  {lng.i}
  RUN enable_UI.
  RUN InitWindow.
  DYNAMIC-FUNCTION("DoLockWindow",?).

  IF NOT THIS-PROCEDURE:PERSISTENT THEN
    WAIT-FOR CLOSE OF THIS-PROCEDURE.
END.


ON 'default-action':U OF hBrowseListe
DO:
  TabStripChanged(12).

  DO WITH FRAME frmDetalj:
    APPLY "Entry" TO VarebehBeskrivelse.            .
  END.
END.

ON 'default-action':U OF hBrowseLinje
  RUN Artikkelkort.

ON 'alt-a':U OF FRAME frmLinje ANYWHERE
  RUN Artikkelkort.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME


/* **********************  Internal Procedures  *********************** */

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE ArtBasEndret C-Win 
PROCEDURE ArtBasEndret :
/*------------------------------------------------------------------------------
  Purpose:    Fange endring av artikkelegenskaper 
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT PARAM ifArtikkelnr AS DEC NO-UNDO.

DYNAMIC-FUNCTION("runproc","update_varebeh_from_artbas.p",
                           STRING(ifArtikkelnr) + "," + 
                           STRING(hFieldMap:BUFFER-FIELD("VarebehNr"):BUFFER-VALUE),
                           ?).

DYNAMIC-FUNCTION("refreshRowids",hBrowseLinje,hFieldMapLinje:BUFFER-FIELD("RowIdent1"):BUFFER-VALUE).
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE Artikkelkort C-Win 
PROCEDURE Artikkelkort :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
IF NOT VALID-HANDLE(hArtikkelkort) THEN
  RUN w-vartkor.w  PERSIST SET hArtikkelkort (DYNAMIC-FUNCTION("getRecId","ArtBas",hFieldMapLinje:BUFFER-FIELD("RowIdent2"):BUFFER-VALUE), "ENDRE," + STRING(THIS-PROCEDURE)).
ELSE
  RUN ByttArtikkel IN hArtikkelkort (hFieldMapLinje:BUFFER-FIELD("ArtikkelNr"):BUFFER-VALUE).

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE BildeGrid C-Win 
PROCEDURE BildeGrid :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF VAR cArtNrList    AS CHAR NO-UNDO.

iReturn = DYNAMIC-FUNCTION("DoMessage",0,1,"Bekreft overføring av &1 artikler til bildegrid","",
                 IF hBrowseLinje:NUM-SELECTED-ROWS > 0 THEN
                   STRING(hBrowseLinje:NUM-SELECTED-ROWS)
                 ELSE
                   DYNAMIC-FUNCTION("getAttribute",hBrowseLinje,"TotalCount")
                 ).
IF iReturn = 2 THEN RETURN.

IF hBrowseLinje:NUM-SELECTED-ROWS > 0 THEN DO:
  DO ix = 1 TO hBrowseLinje:NUM-SELECTED-ROWS:
    IF hBrowseLinje:FETCH-SELECTED-ROW(ix) THEN
      cArtNrList = cArtNrList + STRING(hFieldMapLinje:BUFFER-FIELD("ArtikkelNr"):BUFFER-VALUE) + ",".
  END.
  RUN DynBildeGrid.p (hFieldMapLinje:TABLE-HANDLE,"FOR EACH Varebehlinje WHERE CAN-DO('" + TRIM(cArtNrList,",") + "',STRING(ArtikkelNr))","Artikkelnr").
END.
ELSE RUN DynBildeGrid.p (hFieldMapLinje:TABLE-HANDLE,"FOR EACH Varebehlinje","Artikkelnr").

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE BildeTilDisk C-Win 
PROCEDURE BildeTilDisk :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEFINE INPUT-OUTPUT PARAMETER cBildeFil AS CHARACTER  NO-UNDO.

DEFINE VARIABLE rawData    AS RAW        NO-UNDO.
DEFINE VARIABLE cRowIdent1 AS CHARACTER  NO-UNDO.
DEFINE VARIABLE cRowIdent2 AS CHARACTER  NO-UNDO.
DEFINE VARIABLE cTellerStr AS CHARACTER  NO-UNDO.
DEFINE VARIABLE iBildeNr   AS INTEGER    NO-UNDO.

IF NOT hFieldMapLinje:AVAIL THEN RETURN.

iBildeNr = hFieldMapLinje:BUFFER-FIELD("BildNr"):BUFFER-VALUE.
IF iBildeNr = ? OR iBildeNr = 0 THEN
  ASSIGN cBildeFil = "".
ELSE DO:
  ASSIGN cTellerStr = " AND Teller " +
    IF ENTRY(NUM-ENTRIES(cBildeFil,"/"),cBildeFil,"/") BEGINS "mini" THEN
       ">= 200" ELSE "< 200".

  EMPTY TEMP-TABLE ttBildeData.

  DYNAMIC-FUNCTION("getTempTable","jbserv_getTempTable.p","BildeData|WHERE Bildnr = " + STRING(iBildeNr) + cTellerStr,hBufBildeData).

  LENGTH(rawData) = 30000.

  FIND FIRST ttBildeData NO-ERROR.
  IF NOT AVAIL ttBildeData THEN DO:
    cBildeFil = "".
    RETURN.
  END.

  ASSIGN rawData    = ttBildeData.RawData
         cRowIdent1 = ttBildeData.RowIdent.
  IF rawData = ? THEN DO:
    cBildeFil = "".
    RETURN.
  END.
  ELSE DO:
    OUTPUT STREAM Stream1 TO VALUE(cBildeFil) NO-MAP NO-CONVERT.
    PUT STREAM Stream1 CONTROL rawData.
    HENT:
    REPEAT:
      FIND NEXT ttBildeData.
      IF cRowIdent1 = ttBildeData.RowIdent THEN
        LEAVE HENT.
      ASSIGN cRowIdent1 = ttBildeData.RowIdent
             rawData    = ttBildeData.RawData.
      IF rawData = ? THEN
        LEAVE HENT.
      PUT STREAM Stream1 CONTROL rawData.
    END.
    OUTPUT STREAM Stream1 CLOSE.
  END.
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE control_load C-Win  _CONTROL-LOAD
PROCEDURE control_load :
/*------------------------------------------------------------------------------
  Purpose:     Load the OCXs    
  Parameters:  <none>
  Notes:       Here we load, initialize and make visible the 
               OCXs in the interface.                        
------------------------------------------------------------------------------*/

&IF "{&OPSYS}" = "WIN32":U AND "{&WINDOW-SYSTEM}" NE "TTY":U &THEN
DEFINE VARIABLE UIB_S    AS LOGICAL    NO-UNDO.
DEFINE VARIABLE OCXFile  AS CHARACTER  NO-UNDO.

OCXFile = SEARCH( "butvarebehhode.wrx":U ).
IF OCXFile = ? THEN
  OCXFile = SEARCH(SUBSTRING(THIS-PROCEDURE:FILE-NAME, 1,
                     R-INDEX(THIS-PROCEDURE:FILE-NAME, ".":U), "CHARACTER":U) + "wrx":U).

IF OCXFile <> ? THEN
DO:
  ASSIGN
    chGrid = Grid:COM-HANDLE
    UIB_S = chGrid:LoadControls( OCXFile, "Grid":U)
    chIMAGE-Sko = IMAGE-Sko:COM-HANDLE
    UIB_S = chIMAGE-Sko:LoadControls( OCXFile, "IMAGE-Sko":U)
    chTabStrip = TabStrip:COM-HANDLE
    UIB_S = chTabStrip:LoadControls( OCXFile, "TabStrip":U)
  .
  RUN initialize-controls IN THIS-PROCEDURE NO-ERROR.
END.
ELSE MESSAGE "butvarebehhode.wrx":U SKIP(1)
             "The binary control file could not be found. The controls cannot be loaded."
             VIEW-AS ALERT-BOX TITLE "Controls Not Loaded".

&ENDIF

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE CopyRecord C-Win 
PROCEDURE CopyRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
IF iTab = 1 THEN DO:
  TabStripChanged(12).
  DYNAMIC-FUNCTION("setCurrentObject",hUpdToolbar).
END.

IF iTab = 3 AND hFieldMapLinje:AVAIL THEN DO:  
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
  RUN ArtBasVedlikehold.w (THIS-PROCEDURE,"copy",OUTPUT bOk).
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.
  IF NOT LevUke:HIDDEN IN FRAME frmLinje THEN
    APPLY "entry" TO LevUke.
  ELSE APPLY "entry" TO Grid.

  RETURN NO-APPLY.

/*   IF NOT VALID-HANDLE(hArtikkelkort) THEN                                                             */
/*     RUN w-vartkor.w  PERSIST SET hArtikkelkort                                                        */
/*         (DYNAMIC-FUNCTION("getRecId","ArtBas",hFieldMapLinje:BUFFER-FIELD("RowIdent2"):BUFFER-VALUE), */
/*          "ENDRE").                                                                                    */
/*   RUN ApplyButtonKopier IN hArtikkelkort.                                                             */
END.
ELSE RUN SUPER.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE DeselectRecord C-Win 
PROCEDURE DeselectRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
IF iTab = 3 THEN
  hBrowseLinje:DESELECT-ROWS() NO-ERROR.
ELSE IF iTab = 4 THEN
  hBrowseRegStatTrans:DESELECT-ROWS() NO-ERROR.
ELSE 
  hBrowseListe:DESELECT-ROWS() NO-ERROR.
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE disable_UI C-Win  _DEFAULT-DISABLE
PROCEDURE disable_UI :
/*------------------------------------------------------------------------------
  Purpose:     DISABLE the User Interface
  Parameters:  <none>
  Notes:       Here we clean-up the user-interface by deleting
               dynamic widgets we have created and/or hide 
               frames.  This procedure is usually called when
               we are ready to "clean-up" after running.
------------------------------------------------------------------------------*/
  /* Delete the WINDOW we created */
  IF SESSION:DISPLAY-TYPE = "GUI":U AND VALID-HANDLE(C-Win)
  THEN DELETE WIDGET C-Win.
  IF THIS-PROCEDURE:PERSISTENT THEN DELETE PROCEDURE THIS-PROCEDURE.
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE DisplayRecord C-Win 
PROCEDURE DisplayRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF VAR cDisabled AS CHAR NO-UNDO.

IF hFieldMap:AVAIL THEN DO:
  IF iTab = 3 THEN DO: 
    IF DYNAMIC-FUNCTION("getCurrentObject") = hBrowseLinje THEN DO:
      IF hFieldMap:BUFFER-FIELD("Oppdatert"):BUFFER-VALUE THEN 
        DYNAMIC-FUNCTION("setAttribute",hUpdToolbar,"disabledevents","new,copy,delete").
      ELSE
        DYNAMIC-FUNCTION("setAttribute",hUpdToolbar,"disabledevents","").
    END.
    IF DYNAMIC-FUNCTION("getCurrentObject") = hBrowseBestHode THEN DO:
      Grid:SENSITIVE = TRUE.
      IF hFieldMap:BUFFER-FIELD("Oppdatert"):BUFFER-VALUE THEN 
        cDisabled = "new,save,delete,kalkyle".

      IF hFieldMap:BUFFER-FIELD("VareBehType"):BUFFER-VALUE NE iBestVarebeh 
         OR (hFieldMapBestHode:AVAIL 
             AND hFieldMapBestHode:BUFFER-FIELD("BestNr"):BUFFER-VALUE = 0) 
         OR NOT hFieldMapBestHode:AVAIL THEN DO:
        cDisabled = TRIM(cDisabled + ",VisBest,VisInnlev",",").
        IF hFieldMap:BUFFER-FIELD("VareBehType"):BUFFER-VALUE NE iBestVarebeh 
          AND (hFieldMapBestHode:AVAIL AND hFieldMapBestHode:BUFFER-FIELD("BestNr"):BUFFER-VALUE NE 0)
               OR NOT hFieldMapBestHode:AVAIL THEN DO:
          Grid:SENSITIVE = FALSE.
          cDisabled = cDisabled + ",Delete,Kalkyle".
        END.
      END.
      ELSE IF hFieldMap:BUFFER-FIELD("VareBehType"):BUFFER-VALUE = iBestVarebeh 
         AND hFieldMapBestHode:AVAIL 
         AND hFieldMapBestHode:BUFFER-FIELD("BestStat"):BUFFER-VALUE GE 4 
          THEN 
        cDisabled = TRIM(cDisabled + ",Save,Delete",",").
      
      IF hFieldMap:BUFFER-FIELD("VareBehType"):BUFFER-VALUE NE iBestVarebeh 
         OR (hFieldMapBestHode:AVAIL AND hFieldMapBestHode:BUFFER-FIELD("BestStat"):BUFFER-VALUE < 4) THEN
        cDisabled = TRIM(cDisabled + ",VisInnlev",",").

      DYNAMIC-FUNCTION("setAttribute",hBestHodeToolbar,"disabledevents",cDisabled).
    END.

    DYNAMIC-FUNCTION("setAttribute",hBrowseAndreBest,"queryfilter",
                     " AND BestHode.VarebehNr NE DEC('" + STRING(hFieldMap:BUFFER-FIELD("VarebehNr"):BUFFER-VALUE) + "') AND BestHode.BestStat < 6").
  END.
  ELSE IF iTab = 4 OR hFieldMap:BUFFER-FIELD("Oppdatert"):BUFFER-VALUE THEN
    DYNAMIC-FUNCTION("setAttribute",hUpdToolbar,"disabledevents","delete,StartUtvalg,HentUtvalg").
  ELSE IF bUtvalgIsMaster THEN
    DYNAMIC-FUNCTION("setAttribute",hUpdToolbar,"disabledevents","HentUtvalg").
  ELSE
    DYNAMIC-FUNCTION("setAttribute",hUpdToolbar,"disabledevents","").
END.
ELSE DO:
  IF iTab > 2 THEN 
    DYNAMIC-FUNCTION("setAttribute",hUpdToolbar,"disabledevents","new,StartUtvalg").
  ELSE
    DYNAMIC-FUNCTION("setAttribute",hUpdToolbar,"disabledevents","StartUtvalg").
END.

RUN SUPER.

IF iTab = 3 THEN DO:
  IF DYNAMIC-FUNCTION("getCurrentObject") = hBrowseLinje THEN DO:
    RUN VisMiniBilde(IF hFieldMapLinje:AVAIL THEN hFieldMapLinje:BUFFER-FIELD("FilNavn"):BUFFER-VALUE 
                     ELSE "").
    IF VALID-HANDLE(hVisBilde) THEN
      RUN VisBilde IN hVisBilde (IF hFieldMapLinje:AVAIL THEN hFieldMapLinje:BUFFER-FIELD("BildNr"):BUFFER-VALUE
                                 ELSE 0).
    IF VALID-HANDLE(hArtikkelkort) AND NOT bNewArt THEN 
      RUN ByttArtikkel IN hArtikkelkort (IF hFieldMapLinje:AVAIL THEN hFieldMapLinje:BUFFER-FIELD("ArtikkelNr"):BUFFER-VALUE
                                         ELSE 0).
  END.
  ELSE IF DYNAMIC-FUNCTION("getCurrentObject") = hBrowseBestHode THEN 
    RUN InitGrid (IF hFieldMapBestHode:AVAIL THEN hFieldMapBestHode:BUFFER-FIELD("AlfaFordeling"):BUFFER-VALUE ELSE "").
END.

DO WITH FRAME {&FRAME-NAME}:
  IF hFieldMap:AVAIL THEN 
    ASSIGN KortNavn:SCREEN-VALUE           = hFieldMap:BUFFER-FIELD("KortNavn"):BUFFER-VALUE
           MesseBeskrivelse:SCREEN-VALUE   = hFieldMap:BUFFER-FIELD("MesseBeskrivelse"):BUFFER-VALUE
           MesseNr:SCREEN-VALUE            = hFieldMap:BUFFER-FIELD("MesseNr"):STRING-VALUE
           ProfilNr:SCREEN-VALUE           = hFieldMap:BUFFER-FIELD("ProfilNr"):STRING-VALUE
           Beskrivelse:SCREEN-VALUE        = hFieldMap:BUFFER-FIELD("Beskrivelse"):BUFFER-VALUE
           VarebehNr:SCREEN-VALUE          = hFieldMap:BUFFER-FIELD("VarebehNr"):STRING-VALUE
           VarebehType:SCREEN-VALUE        = hFieldMap:BUFFER-FIELD("VarebehType"):STRING-VALUE
           VarebehBeskrivelse:SCREEN-VALUE = hFieldMap:BUFFER-FIELD("VarebehBeskrivelse"):STRING-VALUE
           .
  ELSE 
    ASSIGN KortNavn:SCREEN-VALUE           = ""
           MesseBeskrivelse:SCREEN-VALUE   = ""
           MesseNr:SCREEN-VALUE            = ""
           ProfilNr:SCREEN-VALUE           = ""
           Beskrivelse:SCREEN-VALUE        = ""
           VarebehNr:SCREEN-VALUE          = ""
           Varebehtype:SCREEN-VALUE        = ""
           VarebehBeskrivelse              = ""
           .
END.

IF iTab = 3 AND DYNAMIC-FUNCTION("getCurrentObject") = hBrowseBestHode THEN
  SettLevUkeEllerDag().

IF hFieldMap:AVAIL THEN 
  SettHentUtvalgSensitive(IF VALID-HANDLE(hUtvalg) AND NOT hFieldMap:BUFFER-FIELD("Oppdatert"):BUFFER-VALUE THEN TRUE ELSE FALSE).

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE editRecord C-Win 
PROCEDURE editRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
IF iTab = 1 THEN APPLY 'default-action':U TO hBrowseListe.
ELSE IF iTab = 3 AND DYNAMIC-FUNCTION("getCurrentObject") = hUpdToolbar THEN DO:
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
  RUN ArtBasVedlikehold.w (THIS-PROCEDURE,"edit",OUTPUT bOk).
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.
  THIS-PROCEDURE:CURRENT-WINDOW:MOVE-TO-TOP().
  APPLY "entry" TO hBrowseLinje.
  IF bOK THEN DO:
    IF DYNAMIC-FUNCTION("runproc","update_varebeh_from_artbas.p",
                        STRING(hBrowseLinje:QUERY:GET-BUFFER-HANDLE(1):BUFFER-FIELD("ArtikkelNr"):BUFFER-VALUE) + "," + 
                        STRING(hBrowseLinje:QUERY:GET-BUFFER-HANDLE(1):BUFFER-FIELD("VarebehNr"):BUFFER-VALUE)
                        ,?) THEN 
      DYNAMIC-FUNCTION("refreshRowids",hBrowseLinje,hBrowseLinje:QUERY:GET-BUFFER-HANDLE(1):BUFFER-FIELD("RowIdent1"):BUFFER-VALUE).
    ELSE
      DYNAMIC-FUNCTION("DoMessage",0,0,DYNAMIC-FUNCTION("GetTransactionMessage"),"Feil","").
  END.    
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE enable_UI C-Win  _DEFAULT-ENABLE
PROCEDURE enable_UI :
/*------------------------------------------------------------------------------
  Purpose:     ENABLE the User Interface
  Parameters:  <none>
  Notes:       Here we display/view/enable the widgets in the
               user-interface.  In addition, OPEN all queries
               associated with each FRAME and BROWSE.
               These statements here are based on the "Other 
               Settings" section of the widget Property Sheets.
------------------------------------------------------------------------------*/
  RUN control_load.
  DISPLAY VarebehNr VarebehBeskrivelse VarebehType Beskrivelse MesseNr 
          MesseBeskrivelse ProfilNr KortNavn 
      WITH FRAME DEFAULT-FRAME IN WINDOW C-Win.
  ENABLE rectToolBar rectUpdToolbar rectVarebeh VarebehNr VarebehBeskrivelse 
         Beskrivelse MesseNr MesseBeskrivelse KortNavn 
      WITH FRAME DEFAULT-FRAME IN WINDOW C-Win.
  {&OPEN-BROWSERS-IN-QUERY-DEFAULT-FRAME}

  {&OPEN-QUERY-frmFilter}
  GET FIRST frmFilter.
  DISPLAY cmbVarebehType fi-fVarebehNr fi-fMesseNr fi-fProfilNr 
          fi-cVarebehBeskrivelse fi-cEkstRef ListeSokLevNr ListeSokLevNamn 
      WITH FRAME frmFilter IN WINDOW C-Win.
  ENABLE btnSokFiltMesseNr cmbVarebehType fi-fVarebehNr fi-fMesseNr 
         fi-fProfilNr fi-cVarebehBeskrivelse fi-cEkstRef ListeSokLevNr btnLev-2 
         btnBlankFilter btnSokFiltProfilNr 
      WITH FRAME frmFilter IN WINDOW C-Win.
  {&OPEN-BROWSERS-IN-QUERY-frmFilter}
  DISPLAY VarebehNr OppdatDato OppdatAv Oppdatert VarebehType Beskrivelse 
          ButikkListe ProfilNr KortNavn VarebehBeskrivelse EkstRef MesseNr 
          MesseBeskrivelse VarebehNotat 
      WITH FRAME frmDetalj IN WINDOW C-Win.
  ENABLE btnSokMesseNr RECT-1 Oppdatert VarebehType Beskrivelse ButikkListe 
         btnButikker ProfilNr KortNavn VarebehBeskrivelse EkstRef MesseNr 
         VarebehNotat btnSokProfilNr 
      WITH FRAME frmDetalj IN WINDOW C-Win.
  {&OPEN-BROWSERS-IN-QUERY-frmDetalj}
  DISPLAY tbUpdateStat sokAvdelingNr sokAvdelingNavn sokHg sokHgBeskr sokVg 
          sokVgBeskr sokAktNr sokAktBeskrivelse sokLevNr sokLevNamn sokBeskr 
          sokLinjeMerknad sokFraEdato sokTilEdato sokFraVPIdato sokTilVPIdato 
          sokFraRegDatoBestInnl sokTilRegDatoBestInnl Kode SumVarekost SumPris 
          LevUke tbRepeat fi-cAndreBestLabel 
      WITH FRAME frmLinje IN WINDOW C-Win.
  ENABLE tbUpdateStat sokAvdelingNr sokAvdelingNavn btnSplitBarY sokHg 
         sokHgBeskr sokVg sokVgBeskr sokAktNr sokAktBeskrivelse sokLevNr 
         sokLevNamn sokBeskr sokLinjeMerknad sokFraEdato sokTilEdato 
         sokFraVPIdato sokTilVPIdato sokFraRegDatoBestInnl 
         sokTilRegDatoBestInnl btnAvdeling Kode btnHuvGr SumVarekost btnVarGr 
         SumPris btnVarGr-2 LevUke btnBlankLinjeFilter tbRepeat btnLev 
         fi-cAndreBestLabel RectBrowseSearchLinje rectBrowseLinje 
         rectBrwBestHode rectBrwAndreBest rectBestHodeToolbar rectStatFields 
      WITH FRAME frmLinje IN WINDOW C-Win.
  {&OPEN-BROWSERS-IN-QUERY-frmLinje}
  ENABLE rectBrowseListe RectBrowseSearchListe 
      WITH FRAME frmListe IN WINDOW C-Win.
  {&OPEN-BROWSERS-IN-QUERY-frmListe}
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE ExcelSheetParams C-Win 
PROCEDURE ExcelSheetParams :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT PARAM ihOutputObject     AS HANDLE NO-UNDO.
DEF INPUT PARAM chExcelApplication AS COM-HANDLE NO-UNDO.
DEF INPUT PARAM chWorkbook         AS COM-HANDLE NO-UNDO.
DEF INPUT PARAM chWorksheet        AS COM-HANDLE NO-UNDO.
DEF INPUT PARAM iCount             AS INTEGER NO-UNDO.

DEF VAR cRange   AS CHAR NO-UNDO.
DEF VAR cValue   AS CHAR NO-UNDO.
DEF VAR hQuery   AS HANDLE NO-UNDO.
DEF VAR hBuffer  AS HANDLE NO-UNDO.
DEF VAR iUtskrNr AS INT NO-UNDO.
DEF VAR bNyUtskr AS LOG NO-UNDO.

IF ihOutputObject = hBrowseRegStatTrans THEN DO:

  IF bAlleTrans THEN DO:
    bAlleTrans = FALSE.
    RETURN.
  END.

  CREATE QUERY hQuery.
  CREATE BUFFER hBuffer FOR TABLE hFieldMapRegStatTrans.
  hQuery:SET-BUFFERS(hBuffer).
  hQuery:QUERY-PREPARE("FOR EACH " + hBuffer:NAME + " BY UtskrNr DESC").
  hQuery:QUERY-OPEN().
  hQuery:GET-FIRST().
  IF hBuffer:AVAIL THEN
    iUtskrNr = hBuffer:BUFFER-FIELD("UtskrNr"):BUFFER-VALUE + 1.
  DELETE OBJECT hBuffer.
  DELETE OBJECT hQuery.

  chWorkSheet:Range("A1:Z1"):rowheight = chWorkSheet:Range("A1:Z1"):rowheight * 2.
  chWorkSheet:Range("A1:A1"):WrapText = TRUE.
  chWorkSheet:Range("A:A"):columnwidth = chWorkSheet:Range("A:A"):columnwidth * .6.
  chWorkSheet:Range("D1:D1"):WrapText = TRUE.
  chWorkSheet:Range("D:D"):columnwidth = chWorkSheet:Range("A:A"):columnwidth * .6.
  chWorkSheet:Range("G1:G1"):WrapText = TRUE.
  chWorkSheet:Range("G:G"):columnwidth = chWorkSheet:Range("A:A"):columnwidth * .6.
  chWorkSheet:Range("I1:I1"):WrapText = TRUE.
  chWorkSheet:Range("I:I"):columnwidth = chWorkSheet:Range("A:A"):columnwidth * .6.
  chWorkSheet:Range("J1:J1"):WrapText = TRUE.
  chWorkSheet:Range("J:J"):columnwidth = chWorkSheet:Range("A:A"):columnwidth * .6.
  chWorkSheet:Range("K1:K1"):WrapText = TRUE.
  chWorkSheet:Range("K:K"):columnwidth = chWorkSheet:Range("A:A"):columnwidth * .6.

  chWorkSheet:Range("W1:AF" + STRING(iCount)):DELETE().

  DO ix = 2 TO iCount:
    ASSIGN cRange = "L" + STRING(ix) + ":L" + STRING(ix)
           cValue = ENTRY(1,STRING(chWorkSheet:Range(cRange):VALUE))
           cValue = FILL("0",13 - LENGTH(cValue)) + cValue
           .
    bOK = hFieldMapRegStatTrans:FIND-FIRST("WHERE Kode = '" + cValue + "'").
    IF bOK AND hFieldMapRegStatTrans:BUFFER-FIELD("UtskrNr"):BUFFER-VALUE = 0 THEN DO:
      bNyUtskr = TRUE.
      hFieldMapRegStatTrans:BUFFER-FIELD("UtskrNr"):BUFFER-VALUE = iUtskrNr.
      DYNAMIC-FUNCTION("DoUpdate","VarebehLinjeTrans",
                    "ignore",
                    "",
                    hFieldMapRegStatTrans:BUFFER-FIELD("RowIdent1"):BUFFER-VALUE,
                    "UtskrNr",
                    STRING(iUtskrNr),
                    FALSE).

    END.
    chWorkSheet:Range(cRange):VALUE = ean13bc(cValue).
  END.

  IF NOT bNyUtskr THEN iUtskrNr = iUtskrNr - 1.

  cRange = "L2:L" + STRING(iCount).
  ASSIGN chWorkSheet:Range(cRange):FONT:NAME = "EAN-13B Half Height"
         chWorkSheet:Range(cRange):FONT:SIZE = 42
         .
  chWorkSheet:Columns("L"):AutoFit().
  IF NOT hFieldMapRegStat:AVAIL THEN
    hBrowseRegStat:SELECT-ROW(hBrowseRegStat:FOCUSED-ROW).

  chWorkSheet:PageSetup:LeftHeader     = STRING(hFieldMapRegStat:BUFFER-FIELD("ButikkNr"):BUFFER-VALUE) + " " + hFieldMapRegStat:BUFFER-FIELD("ButNamn"):BUFFER-VALUE.
  chWorkSheet:PageSetup:CenterHeader   = "Ordrebekreftelse. Utskrift nr " + STRING(iUtskrNr).
  chWorkSheet:PageSetup:RightHeader    = "Signatur: ______________________________________".
  chWorkSheet:PageSetup:PrintGridLines = TRUE.
  chWorkSheet:PageSetup:Zoom           = 65.
  chWorkSheet:PageSetup:LeftMargin     = 50.
  chWorkSheet:PageSetup:RightMargin    = 40.
  chWorkSheet:PageSetup:TopMargin      = 55.
  chWorkSheet:PageSetup:BottomMargin   = 50.
  chWorkSheet:PageSetup:PrintTitleRows = "$1:$1".
  chWorkSheet:PageSetup:RightFooter    = "Side &P av &N". 
  
  chWorkSheet:Range("T" + STRING(iCount + 2)):FormulaR1C1 = "Sum ordre".
  chWorkSheet:Range("V" + STRING(iCount + 2)):FormulaR1C1 = "=SUM(R[-" + STRING(iCount) + "]C:R[-1]C)".
  chWorkSheet:Range("T" + STRING(iCount + 2) + ":V" + STRING(iCount + 2)):Font:Bold = True.
  chWorkSheet:Range("V:V"):NumberFormat = "# ##0,0".

  DYNAMIC-FUNCTION("setAttribute",ihOutputObject,"excelpreview","yeah").

  bOK = DYNAMIC-FUNCTION("DoCommit",FALSE).
  IF bOk THEN
    hBrowseRegStatTrans:REFRESH().
  ELSE
    DYNAMIC-FUNCTION("DoMessage",0,0,DYNAMIC-FUNCTION("getTransactionMessage"),"Feil i oppdatering av utskr.nr","").
END.
ELSE IF ihOutputObject = hBrowseLinje THEN DO:
  chWorkSheet:Range("H:H"):NumberFormat = "# ##0,00".
  chWorkSheet:Range("I:I"):NumberFormat = "###0,00".
  chWorkSheet:Range("J:J"):NumberFormat = "# ##0,00".
  chWorkSheet:Range("K:K"):NumberFormat = "# ##0,00".
  chWorkSheet:Range("L:L"):NumberFormat = "# ##0,00".
  chWorkSheet:Range("M:M"):NumberFormat = "# ##0,00".
  chWorkSheet:Range("N:N"):NumberFormat = "# ##0,00".
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE ExtraFlatViewRecord C-Win 
PROCEDURE ExtraFlatViewRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT  PARAM ihFlatView AS HANDLE NO-UNDO.
DEF OUTPUT PARAM obOk       AS LOG NO-UNDO INIT TRUE.

DEF VAR iReturn AS INT NO-UNDO.

IF iTab < 3 THEN
  iReturn = DYNAMIC-FUNCTION("DoMessage",0,1,"Det kan ta til å hente alle bestillinger eller varemottak for aktuelle vareh.bøker - vil du fortsette?","","").
ELSE 
  iReturn = DYNAMIC-FUNCTION("DoMessage",0,1,"Det kan ta litt tid å hente alle bestillinger eller varemottak for vareh.bok - vil du fortsette?","","").
IF iReturn NE 1 THEN DO:
  obOK = FALSE.
  APPLY "close" TO ihFlatView.
  RETURN.
END.

DYNAMIC-FUNCTION("setUseLocalData" IN ihFlatView,TRUE).
DYNAMIC-FUNCTION("setExcludeFields" IN ihFlatView,
                 (IF iBestVarebeh = 1 THEN cInnlevViewFields + ",+BatchNr" ELSE cInnlevViewFields) + ","
               + "EkstRef,Oppdatert,OppdatDato,EDato,BrukerId,+BestHodeRtid,RegistrertDato,RegistrertTid,"
               + "+BestHodeRtid"
               + ",+SumAntall,+SumVarekost,+SumPris"
                 ).

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE FlatViewRecord C-Win 
PROCEDURE FlatViewRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF VAR hFlatView AS HANDLE NO-UNDO.
DEF VAR hFlatBrw  AS HANDLE NO-UNDO.

DYNAMIC-FUNCTION("DeleteObjectLink",hBrowseLinje,hBrowseAndreBest).

IF iTab < 3 THEN
  DYNAMIC-FUNCTION("createParentLink",hBrowseLinje,hBrowseListe,'VarebehNr').
RUN SUPER.
IF iTab < 3 THEN
  DYNAMIC-FUNCTION("DeleteObjectLink",hBrowseLinje,hBrowseListe).

DYNAMIC-FUNCTION("CreateParentLink",hBrowseAndreBest,hBrowseLinje,"ArtikkelNr").

hFlatView = WIDGET-HANDLE(DYNAMIC-FUNCTION("getAttribute",hUpdToolBar,"flatviewhandle")) NO-ERROR.
IF NOT VALID-HANDLE(hFlatView) THEN RETURN.

hFlatBrw  = DYNAMIC-FUNCTION("getBrowseHandle" IN hFlatView).

{incl/dynfilterlookups_art.i}
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE genBestRecord C-Win 
PROCEDURE genBestRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
RUN JBoxSelector.w (THIS-PROCEDURE,0,
                    "LevBas;levnr;levnamn;KjedeAvtale|Kjedeavtale|J/N",
                    "where true",
                    INPUT-OUTPUT cLevBasRowIdList,
                    "Levnr",
                    INPUT-OUTPUT cLevBasIdList,
                    "","",
                    OUTPUT bOK).
THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.

/* IF bOk THEN DO:                                                                                                                  */
/*   IF NUM-ENTRIES(cLevBasRowidList) > 1 THEN                                                                                      */
/*     ASSIGN sokLevNr:SCREEN-VALUE   = "0"                                                                                         */
/*            sokLevNamn:SCREEN-VALUE = STRING(NUM-ENTRIES(cLevBasRowidList)) + " av " +                                            */
/*                                      STRING(iSelectorSourcCount)                                                                 */
/*                                      .                                                                                           */
/*   ELSE                                                                                                                           */
/*     ASSIGN sokLevNr:SCREEN-VALUE   = cLevBasIdList                                                                               */
/*            sokLevNamn:SCREEN-VALUE = DYNAMIC-FUNCTION("getFieldList","LevBas;LevNamn","WHERE LevNr = " + sokLevNr:SCREEN-VALUE). */
/*   RUN OpenQuery.                                                                                                                 */
/* END.                                                                                                                             */
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE getArtKortParam C-Win 
PROCEDURE getArtKortParam :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT  PARAM icMode   AS CHAR NO-UNDO.
DEF OUTPUT PARAM oiLevnr  AS INT NO-UNDO.
DEF OUTPUT PARAM orRecId  AS RECID NO-UNDO. 

IF icMode = "NY" THEN DO WITH FRAME frmLinje:
  orRecid = DYNAMIC-FUNCTION("getRecId","ArtBas",DYNAMIC-FUNCTION("getFieldValues","ArtBas","WHERE lager","ROWID")).
  oiLevNr = INT(sokLevNr:SCREEN-VALUE).
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE getSelectorAttributes C-Win 
PROCEDURE getSelectorAttributes :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT PARAM  ihSelectorSource AS HANDLE NO-UNDO.
DEF INPUT PARAM  ihSelectorTarget AS HANDLE NO-UNDO.
DEF INPUT PARAM  icDeSelRowidList AS CHAR NO-UNDO.
DEF OUTPUT PARAM oiReturn         AS INT NO-UNDO.

DEF VAR cTmpHuvGrList    AS CHAR NO-UNDO.
DEF VAR cTmpVarGrList    AS CHAR NO-UNDO.

cCurrSelectBuffer = ihSelectorSource:QUERY:GET-BUFFER-HANDLE(1):NAME.
iSelectorSourcCount = INT(DYNAMIC-FUNCTION("getAttribute",ihSelectorSource,"totalcount")).


/* Håndtering av avhengighet Avdeling/HuvGr: */
IF cCurrSelectBuffer = "HuvGr" THEN DO WITH FRAME frmLinje:
  cHuvGrAvdelingList = "".
  ihSelectorTarget:QUERY:GET-FIRST().
  REPEAT WHILE NOT ihSelectorTarget:QUERY:QUERY-OFF-END:
    cHuvGrAvdelingList = cHuvGrAvdelingList + STRING(ihSelectorTarget:QUERY:GET-BUFFER-HANDLE(1):BUFFER-FIELD("AvdelingNr"):BUFFER-VALUE) + ",".
    ihSelectorTarget:QUERY:GET-NEXT().
  END.  
  cHuvGrAvdelingList = TRIM(cHuvGrAvdelingList,",").

  IF cVarGrHuvGrList NE "" THEN DO:
    DO ix = 1 TO NUM-ENTRIES(cVarGrRowIdList):
      bOK = ihSelectorTarget:QUERY:GET-BUFFER-HANDLE(1):FIND-FIRST("WHERE Hg = " + ENTRY(ix,cVarGrHuvGrList)) NO-ERROR.
      IF bOk THEN
        cTmpVarGrList = cTmpVarGrList + ENTRY(ix,cVarGrRowIdList) + ",".
    END.
    IF NUM-ENTRIES(TRIM(cTmpVarGrList,",")) NE NUM-ENTRIES(cVarGrRowIdList) THEN DO:
      ASSIGN cVarGrRowIdList         = ""
             cVarGrIdList            = ""
             sokVg:SCREEN-VALUE      = "0"
             sokVgBeskr:SCREEN-VALUE = ""
             .
    END.
  END.
END.
ELSE IF cCurrSelectBuffer = "Avdeling" AND cHuvGrAvdelingList NE "" THEN DO:
  DO ix = 1 TO NUM-ENTRIES(cHuvGrRowIdList):
    bOK = ihSelectorTarget:QUERY:GET-BUFFER-HANDLE(1):FIND-FIRST("WHERE AvdelingNr = " + ENTRY(ix,cHuvGrAvdelingList)) NO-ERROR.
    IF bOk THEN
      cTmpHuvGrList = cTmpHuvGrList + ENTRY(ix,cHuvGrRowIdList) + ",".
  END.
  IF NUM-ENTRIES(TRIM(cTmpHuvGrList,",")) NE NUM-ENTRIES(cHuvGrRowIdList) THEN DO:
    ASSIGN cHuvGrRowIdList         = ""
           cHuvGrIdList            = ""
           cVarGrRowIdList         = ""
           cVarGrIdList            = ""
           sokHg:SCREEN-VALUE      = "0"
           sokHgBeskr:SCREEN-VALUE = ""
           sokVg:SCREEN-VALUE      = "0"
           sokVgBeskr:SCREEN-VALUE = ""
           .
  END.
END.

/* Håndtering av avhengighet HuvGr/VarGr: */
ELSE IF cCurrSelectBuffer = "VarGr" THEN DO:
  cVarGrHuvGrList = "".
  ihSelectorTarget:QUERY:GET-FIRST().
  REPEAT WHILE NOT ihSelectorTarget:QUERY:QUERY-OFF-END:
    cVarGrHuvGrList = cVarGrHuvGrList + STRING(ihSelectorTarget:QUERY:GET-BUFFER-HANDLE(1):BUFFER-FIELD("Hg"):BUFFER-VALUE) + ",".
    ihSelectorTarget:QUERY:GET-NEXT().
  END.  
  cVarGrHuvGrList = TRIM(cVarGrHuvGrList,",").
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE getVareSlagExceptList C-Win 
PROCEDURE getVareSlagExceptList :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF OUTPUT PARAM cExceptList AS CHAR NO-UNDO.

cExceptList = REPLACE(DYNAMIC-FUNCTION("getFieldList","SysPara;Parameter1","WHERE SysHId = 2 and SysGr = 8"),"|",",").

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE HentUtvalgRecord C-Win 
PROCEDURE HentUtvalgRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
IF hFieldMap:AVAIL AND hFieldMap:BUFFER-FIELD("oppdatert"):BUFFER-VALUE = NO AND VALID-HANDLE(hUtvalg) THEN DO:
  RUN OverfUtvalgTilVbeh IN hUtvalg (hFieldMap:BUFFER-FIELD("VarebehNr"):BUFFER-VALUE, OUTPUT bOK).
  IF bOK THEN DO: 
    IF iTab < 3 THEN
      TabStripChanged(13).
    ELSE APPLY "value-changed" TO hBrowseListe.
  END.
END.
ELSE IF NOT VALID-HANDLE(hUtvalg) THEN
  DYNAMIC-FUNCTION("DoMessage",0,0,"Utvalg ikke tilgjengelig","","").
ELSE IF hFieldMap:AVAIL THEN 
  DYNAMIC-FUNCTION("DoMessage",0,0,"Varebeh &1 er oppdatert og kan ikke tilføres flere artikler","",STRING(hFieldMap:BUFFER-FIELD("VarebehNr"):BUFFER-VALUE)).
ELSE 
  DYNAMIC-FUNCTION("DoMessage",0,0,"Ingen Varebeh valgt","","").
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE InitGrid C-Win 
PROCEDURE InitGrid :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT PARAM icStorrelser AS CHAR NO-UNDO.

DEF VAR cButiker      AS CHAR NO-UNDO.
DEF VAR iAntTmp       AS INT  NO-UNDO.   
DEF VAR iRowCount     AS INT  NO-UNDO.
DEF VAR cButikerInUse AS CHAR NO-UNDO.

ASSIGN chGrid:rows = 1
       chGrid:cols = 2.

IF icStorrelser = "clear" THEN RETURN.

IF hFieldMapBestHode:AVAIL THEN DO:

  EMPTY TEMP-TABLE ttSort.
  DO ix = 1 TO NUM-ENTRIES(hFieldMap:BUFFER-FIELD("ButikkListe"):BUFFER-VALUE):
    CREATE ttSort.
    ttSort.iSeq = INT(ENTRY(ix,hFieldMap:BUFFER-FIELD("ButikkListe"):BUFFER-VALUE)).
  END.
  FOR EACH ttSort BY iSeq:
    cButiker = cButiker + STRING(ttSort.iSeq) + ",".
  END.

  ASSIGN cButiker    = TRIM(cButiker,",")
         icStorrelser = REPLACE(icStorrelser," ","")
         chGrid:rows = 1 + NUM-ENTRIES(cButiker)
         chGrid:cols = 2 + NUM-ENTRIES(icStorrelser).

  DO ix = 1 TO NUM-ENTRIES(icStorrelser):
    ASSIGN chGrid:ColWidth(ix + 1) = 510
           chGrid:TextMatrix(0,ix + 1) = ENTRY(ix,icStorrelser) + " ".
  END.

  EMPTY TEMP-TABLE tt_VarebehBestLinje.
  DYNAMIC-FUNCTION("getTempTable","gettemptable.p","VarebehBestLinje|WHERE VarebehNr   = " + STRING(hFieldMap:BUFFER-FIELD("VarebehNr"):BUFFER-VALUE)
                                                    + " AND CLButikkNr  = " + STRING(hFieldMapBestHode:BUFFER-FIELD("CLButikkNr"):BUFFER-VALUE)
                                                    + " AND HodeLinjeId = " + STRING(hFieldMapBestHode:BUFFER-FIELD("HodeLinjeId"):BUFFER-VALUE),
                                                    hBuffTT_VarebehBestLinje).

  DO ix = 1 TO NUM-ENTRIES(cButiker):
    IF CAN-FIND(FIRST TT_VareBehBestLinje WHERE TT_VareBehBestLinje.BestiltButikkNr = INT(ENTRY(ix,cButiker))) 
       OR NOT CAN-FIND(FIRST TT_VareBehBestLinje) THEN
      ASSIGN iRowCount               = iRowCount + 1
             chGrid:TextMatrix(iRowCount,0) = ENTRY(ix,cButiker)
             chGrid:TextMatrix(iRowCount,1) = "0 "
             cButikerInUse                  = cButikerInUse + ENTRY(ix,cButiker) + ",".
  END.
  cButikerInUse = TRIM(cButikerInUse,",").

  FOR EACH TT_VareBehBestLinje:
    IF CAN-DO(cButiker,STRING(TT_VareBehBestLinje.BestiltButikkNr)) AND CAN-DO(icStorrelser,TT_VareBehBestLinje.Storl) THEN DO:
      chGrid:TextMatrix(LOOKUP(STRING(TT_VareBehBestLinje.BestiltButikkNr),cButikerInUse),LOOKUP(TT_VareBehBestLinje.Storl,icStorrelser) + 1) = STRING(TT_VareBehBestLinje.Bestilt) + " ".
      iAntTmp = INT(chGrid:TextMatrix(LOOKUP(STRING(TT_VareBehBestLinje.BestiltButikkNr),cButikerInUse),1)).
      iAntTmp = iAntTmp + TT_VareBehBestLinje.Bestilt.
      chGrid:TextMatrix(LOOKUP(STRING(TT_VareBehBestLinje.BestiltButikkNr),cButikerInUse),1) = STRING(iAntTmp) + " ".
    END.
  END.

  IF chGrid:rows > 1 AND chGrid:cols > 2 THEN
    ASSIGN chGrid:ROW = 1
           chGrid:COL = 2
           NO-ERROR.
END.


END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE initialize-controls C-Win 
PROCEDURE initialize-controls :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEFINE VAR iIdx        AS INTE NO-UNDO.
DEFINE VAR iRow        AS INTE NO-UNDO.
DEFINE VARIABLE iCount AS INTEGER    NO-UNDO.
DEFINE VARIABLE iAntTmp AS INTEGER    NO-UNDO.
ASSIGN chGrid = chGrid:vsFlexGrid.

ASSIGN chGrid:CellPictureAlignment = 1
       chGrid:Redraw = FALSE. /* disable repaint while populating */
chGrid:Clear().

ASSIGN chGrid:AllowUserResizing = 0 /* user may resize columns/rows */
       chGrid:Enabled = TRUE  /* make it an updateable Grid */
       chGrid:AllowBigSelection = FALSE 
       chGrid:AllowSelection    = FALSE 
       chGrid:Appearance = 1 
       chGrid:Rows = 2
       chGrid:Cols = 3
       chGrid:FixedRows = 1
       chGrid:FixedCols = 2
       chGrid:HonorProKeys = FALSE
       chGrid:TextStyle = 0
       chGrid:TextStyleFixed = 0
       chGrid:ColWidth(1) = 615.

/*     chGrid:Cell(6,0,0,0,chGrid:Cols - 1) = 16777215. */
ASSIGN chGrid:TextMatrix(0,0) = "Butikk "
       chGrid:TextMatrix(0,1) = "Total ".

ASSIGN iIdx = 0.
/* DO iIdx = 1 TO NUM-ENTRIES(cStorrelser):                                                                                                                                               */
/*     ASSIGN chGrid:ColWidth(iIdx + 1) = 510                                                                                                                                             */
/*            chGrid:TextMatrix(0,iIdx + 1) = ENTRY(iIdx,cStorrelser) + " ".                                                                                                              */
/* END.                                                                                                                                                                                   */
/* DO iCount = 1 TO iAntBut:                                                                                                                                                              */
/*     ASSIGN iRow = iCount                                                                                                                                                               */
/*            chGrid:TextMatrix(iRow,0) = ENTRY(iCount,cButiker)                                                                                                                          */
/*            chGrid:TextMatrix(iRow,1) = "0 ".                                                                                                                                           */
/* END.                                                                                                                                                                                   */
ASSIGN chGrid:Row = 1
       chGrid:Col = 2
       chGrid:Redraw = TRUE. /* disable repaint while populating */
/* FOR EACH TT_VareBehBestLinje: */
/*     IF CAN-DO(cButiker,STRING(TT_VareBehBestLinje.BestiltButikkNr)) AND CAN-DO(cStorrelser,TT_VareBehBestLinje.Storl) THEN DO:                                                         */
/*         chGrid:TextMatrix(LOOKUP(STRING(TT_VareBehBestLinje.BestiltButikkNr),cButiker),LOOKUP(TT_VareBehBestLinje.Storl,cStorrelser) + 1) = STRING(TT_VareBehBestLinje.Bestilt) + " ". */
/*         iAntTmp = INT(chGrid:TextMatrix(LOOKUP(STRING(TT_VareBehBestLinje.BestiltButikkNr),cButiker),1)).                                                                              */
/*         iAntTmp = iAntTmp + TT_VareBehBestLinje.Bestilt.                                                                                                                               */
/*         chGrid:TextMatrix(LOOKUP(STRING(TT_VareBehBestLinje.BestiltButikkNr),cButiker),1) = STRING(iAntTmp) + " ".                                                                     */
/*     END.                                                                                                                                                                               */
/* END.                                                                                                                                                                                   */

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE InitLinje C-Win 
PROCEDURE InitLinje :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF VAR cValidWeeks AS CHAR NO-UNDO.
DEF VAR hNewButton  AS HANDLE NO-UNDO.
DEF VAR hField      AS HANDLE NO-UNDO.

DO WITH FRAME frmLinje:
  ASSIGN cVarebehLinjeJoin    = ",FIRST ArtBas OF VarebehLinje NO-LOCK"
                                 + ",FIRST BildeRegister OF ArtBas OUTER-JOIN"
                                 + ",FIRST Farg OF ArtBas OUTER-JOIN"
         cAktivitetJoin       =  ",FIRST VgAkt WHERE VgAkt.Vg = VarebehLinje.Vg OUTER-JOIN"
                                 + ",FIRST Aktivitet OF VgAkt OUTER-JOIN"
/*          cBestHodeJoin        = ",FIRST VarebehBestHode OF VarebehLinje NO-LOCK OUTER-JOIN" */
         cVarebehLBuffAndFlds = "VarebehLinje" 
                                + ";LevNamn|Lev.navn|x(30)"
                                + ";Beskr|Art.navn|x(30)"
                                + ";LevKod|Lev.art.nr|x(20)"
                                + ";LevFargKod|Lev.farge|x(20)"
                                + ";ArtikkelNr|Art.nr"
                                + ";Vg|VgNr"
                                + ";VgBeskr|Vg.beskr"
                                + ";InnkjopsPris|Innpris"
                                + ";DB%"
                                + ";Varekost"
                                + ";Pris"
                                + ";+SumAntall|DECIMAL|->>>>9|butvarebehlinje_antall.p(ROWID)|Antall"
                                + ";+SumVarekost|DECIMAL|-><>>><>>9.99|butvarebehlinje_varekost.p(ROWID)|Sum varekost"
                                + ";+SumPris|DECIMAL|-><>>><>>9.99|butvarebehlinje_pris.p(ROWID)|Sum pris"
                                + ";+SumDB|DECIMAL|-><>>><>>9.99|butvarebehlinje_sumdb.p(ROWID)|Sum DB"
                                + ";Hg"
                                + ";HgBeskr"
                                + ";AvdelingNr"
                                + ";AvdelingNavn"
                                + ";levnr"
                                + ";ModellFarge"
                                + ";!VarebehNr"
                            
                              + ",ArtBas;!BildNr;!StrTypeId;!SalgsEnhet;!Farg" 
                                + ";LopNr|Lp.nr"
                              + ",BildeRegister;!Filnavn"
                              + ",Farg"
                                + ";FarBeskr|Farge"
                              + ",VgAkt;!ETid"
                              + ",Aktivitet;!AktNr"
/*                                 + ",VarebehBestHode;!Ordrenr" */
                                .

  hBrowseLinje = DYNAMIC-FUNCTION("NewBrowse",         
                    rectBrowseLinje:HANDLE IN FRAME frmLinje,  
                    50,                          
                    "", /* MULTIPLE,NUM-LOCKED-COLUMNS|1 */  
                    cVarebehLBuffAndFlds,
                    "WHERE false"
                      + cVarebehLinjeJoin + cAktivitetJoin + cBestHodeJoin
                      ,
                    "LevNamn").                            /* Misc - for something I might need in next version.. */
  hBrowseLinje:NAME = "brwLinje". /* This name is neccessary because the browser is due to special treatment during resize */
/*   hBrowseLinje:TOOLTIP = "CTRL-S/P lagrer og skifter til neste/forrige artikkel". */
  hBrowseLinje:GET-BROWSE-COLUMN(1):WIDTH-PIXELS = 60.
  hBrowseLinje:GET-BROWSE-COLUMN(2):WIDTH-PIXELS = 100.
  hBrowseLinje:GET-BROWSE-COLUMN(3):WIDTH-PIXELS = 60.
  hBrowseLinje:GET-BROWSE-COLUMN(4):WIDTH-PIXELS = 60.
  hBrowseLinje:GET-BROWSE-COLUMN(5):WIDTH-PIXELS = 50.
  hBrowseLinje:GET-BROWSE-COLUMN(8):WIDTH-PIXELS = 30.
  hBrowseLinje:MOVE-COLUMN(23,6).
  hBrowseLinje:GET-BROWSE-COLUMN(6):WIDTH-PIXELS = 30.

  DYNAMIC-FUNCTION("setAttribute",hBrowseLinje,"querywhere","").  
  DYNAMIC-FUNCTION("setAttribute",hBrowseLinje,"NoColumnSort","SumAntall,SumVarekost,SumPris").

  hSearchLinje = DYNAMIC-FUNCTION("NewBrowseSearchField",RectBrowseSearchLinje:HANDLE,hBrowseLinje,1).

  hFieldMapLinje = DYNAMIC-FUNCTION("NewFieldMap",
                   hBrowseLinje:QUERY,
                   FRAME frmLinje:HANDLE,
                   "","","","","").
  DYNAMIC-FUNCTION("setAttribute",hFieldMapLinje,"customDeleteValProc","=delval_butvarebehlinje.p"). 
  
  hBrowseBestHode = DYNAMIC-FUNCTION("NewBrowse",
                    rectBrwBestHode:HANDLE,
                    100,
                    "",
                    "VarebehBestHode"
                      + ";+BestHodeBestnr|INTEGER|>>>>>>>>9|varebehbesthode_bestnr.p|Bestnr"
                      + ";OrdreNr"
                      + ";LevUke"
                      + ";+BestInnlevStat|INTEGER|9|varebehbesthode_status.p|BS"
                      + ";CLButikkNr|CL"
                      + ";+Batchnr|INTEGER|>>>>>>>9|varebehbesthode_batchnr.p|Batchnr"
                      + ";AntLevert"
                      + ";VerdiLevert"
                      + ";RegistrertDato|Reg.dato"
                      + ";RegistrertAv|Reg.av"
                      + ";+BestHodeRtid|CHARACTER|x(6)|int_to_hhmm_time.p(RegistrertTid)|Reg.tid"
                      + ";!HodeLinjeId"
                      + ";!BestNr|Bestnr"
                      + ";!AlfaFordeling"
                      + ";!RegistrertTid"
                      + ";!VareBehNr"
                      + ";!ArtikkelNr"
                  + ",BestHode"
                      + ";!BestStat"
                      + ";TotAntPar|Antall"
                      + ";TotInnkjVerdi|Sum varekost"
                      + ";TotSalgsVerdi|Sum pris"
                      + ";BestType"
                      + ";SendtAv"
                      + ";SendtDato"
                      ,
                    "WHERE false,FIRST BestHode WHERE BestHode.VarebehNr = VarebehBestHode.VarebehNr AND BestHode.BestNr = VareBehBestHode.BestNr NO-LOCK OUTER-JOIN",
                    "").
  hBrowseBestHode:NAME = "brwBestHode".

  ASSIGN cInnlevViewFields = "Batchnr,AntLevert,VerdiLevert,RegistrertDato,BestHodeRtid,RegistrertAv"
         cBestViewFields   = "BestHodeBestnr,OrdreNr,LevUke,BestInnlevStat,CLButikkNr,TotAntPar,TotInnkjVerdi,TotSalgsVerdi,BestType,SendtAv,SendtDato,RegistrertDato,BestHodeRtid,RegistrertAv"
                             .
  
  DO ix = 12 TO hBrowseBestHode:NUM-COLUMNS:
    hBrowseBestHode:MOVE-COLUMN(ix,ix - 6).
  END.

  DYNAMIC-FUNCTION("setAttribute",hBrowseBestHode,"NoColumnSort","BestHodeBestnr,BestInnlevStat,Batchnr,Dummy").
  DYNAMIC-FUNCTION("setAttribute",hBrowseBestHode,"SortMap","BestHodeRtid;RegistrertTid").
  DYNAMIC-FUNCTION("CreateParentLink",hBrowseBestHode,hBrowseLinje,"VarebehNr,ArtikkelNr").


  hFieldMapBestHode = DYNAMIC-FUNCTION("NewFieldMap",
                   hBrowseBestHode:QUERY,
                   FRAME frmLinje:HANDLE,
                   "LevUke","",
                   "","",
                   "").
  DYNAMIC-FUNCTION("setAttribute",hFieldMapBestHode,"bufferextrafields","VarebehNr,ArtikkelNr,Alfafordeling,CLButikkNr").
  DYNAMIC-FUNCTION("setAttribute",hFieldMapBestHode,"customCreateProc","create_varebehbesthode.p").
  DYNAMIC-FUNCTION("setAttribute",hFieldMapBestHode,"customDeleteValProc","=delval_varebehbesthode.p"). 
  DYNAMIC-FUNCTION("setAttribute",hFieldMapBestHode,"customUpdateValProc","ignore"). 

  DYNAMIC-FUNCTION("CreateObjectLink",hFieldMapBestHode,hBrowseBestHode).

  hBestHodeToolbar = DYNAMIC-FUNCTION("NewToolbar",
                   rectBestHodeToolbar:HANDLE,
                   "",
                   "new;Ny &bestilling/innlevering (ALT-B)"
                   + ",delete;Slett bestilling (innlev kan ikke slettes her)"
                   + ",undo;Angre"
                   + ",save;Lagre bestilling/innlevering"
                   + ",excel"
                   + ",Strekkode;S&trekkoder"
                   + ",Kalkyle;Kalk&yle"
                   + ",VisBest;Vis generert bestilling"
                   + ",VisInnlev;Innleveranse",
                   "maxborder").
  hLagerBestButton = DYNAMIC-FUNCTION("getEventWidget",hBestHodeToolbar,"save","").
  hNewButton = DYNAMIC-FUNCTION("getEventWidget",hBestHodeToolbar,"new","").
  hNewButton:TOOLTIP = "Ny bestilling/innlevering (ALT-B)".
  hKalkyleButton = WIDGET-HANDLE(DYNAMIC-FUNCTION("getAttribute",hBestHodeToolbar,"buttonKalkyle")).
  hStrekkodeButton = WIDGET-HANDLE(DYNAMIC-FUNCTION("getAttribute",hBestHodeToolbar,"buttonStrekkode")).

  DYNAMIC-FUNCTION("CreateObjectLink",hBestHodeToolbar,hBrowseBestHode).
  DYNAMIC-FUNCTION("CreateObjectLink",hBestHodeToolbar,hFieldMapBestHode).

  hBrowseAndreBest = DYNAMIC-FUNCTION("NewBrowse",
                    rectBrwAndreBest:HANDLE,
                    20,
                    "",
                    "BestHode"
                      + ";BestNr"
                      + ";BestillingsDato"
                      + ";BestStat"
                      + ";TotAntPar"
                      + ";TotInnkjVerdi"
                      + ";TotSalgsVerdi"
                      + ";BestType"
                      + ";DirekteLev"
                      + ";OrdreNr"
                      + ";VarebehNr"
                      + ";!ArtikkelNr"
                      ,
                    "WHERE Bestnr < 0",
                    "SORT|BestNr DESC").
  hBrowseAndreBest:NAME = "brwAndreBest".

  DYNAMIC-FUNCTION("CreateParentLink",hBrowseAndreBest,hBrowseLinje,"ArtikkelNr").

  cStatFieldHandles = DYNAMIC-FUNCTION("getWidgetHandles",FRAME frmLinje:HANDLE,0,
                                       rectStatFields:X,
                                       rectStatFields:X + rectStatFields:WIDTH-PIXELS,
                                       rectStatFields:Y,
                                       rectStatFields:Y + rectStatFields:HEIGHT-PIXELS,
                                       "fill-in").

  DO ix = 1 TO NUM-ENTRIES(cStatFieldHandles):
    hField = WIDGET-HANDLE(ENTRY(ix,cStatFieldHandles)).
    IF INDEX(hField:NAME,"_") > 0 THEN
      ASSIGN cStatFieldNames      = cStatFieldNames + SUBSTR(hField:NAME,INDEX(hField:NAME,"_") + 1) + ","
             cStatFieldPrefixList = cStatFieldPrefixList + SUBSTR(hField:NAME,1,INDEX(hField:NAME,"_") - 1)
                                    .
    ELSE
      ASSIGN cStatFieldNames      = cStatFieldNames + hField:NAME + ","
             cStatFieldPrefixList = cStatFieldPrefixList + ","
             .
    cPrefixedStatFields = cPrefixedStatFields + hField:NAME + ",".
  END.
  APPLY "value-changed" TO tbUpdateStat.
END.


END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE InitWindow C-Win 
PROCEDURE InitWindow :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>  
  Notes:       
              ;FeilVare|Reklam  
------------------------------------------------------------------------------*/
DEF VAR cHKinst   AS CHAR NO-UNDO.

SetTabStrip().

ASSIGN cAdgang        = DYNAMIC-FUNCTION("getFieldValues","SysPara",
                            "WHERE SysHId = 16 and SysGr = 39 and ParaNr = 2","Parameter1")
       cBildeKatalog  = DYNAMIC-FUNCTION("getFieldValues","SysPara",
                            "WHERE SysHId = 10 and SysGr = 1 and ParaNr = 2","Parameter1")
       cCL            = DYNAMIC-FUNCTION("getFieldValues","SysPara",
                            "WHERE SysHId = 5 and SysGr = 1 and ParaNr = 1","Parameter1")
       cBestTypeDesc = DYNAMIC-FUNCTION("getFieldValues","SysPara",
                            "WHERE SysHId = 5 and SysGr = 6 and ParaNr = 1","Parameter1,Beskrivelse")
       iBestVarebeh   = INT(ENTRY(1,cBestTypeDesc,"|"))
       cInnlevTypeDesc = DYNAMIC-FUNCTION("getFieldValues","SysPara",
                            "WHERE SysHId = 5 and SysGr = 6 and ParaNr = 2","Parameter1,Beskrivelse")
       cAlle          = DYNAMIC-FUNCTION("getFieldValues","SysPara",
                            "WHERE SysHId = 1 and SysGr = 100 and ParaNr = 1","Parameter1")
       cHKinst        = DYNAMIC-FUNCTION("getFieldValues","SysPara",
                            "WHERE SysHId = 1 and SysGr = 1 and ParaNr = 18","Parameter1")
       bHKinst        = IF CAN-DO("1,yes,true",cHKinst) THEN TRUE ELSE FALSE
       cInitPrisProfil = DYNAMIC-FUNCTION("getFieldValues","Butiker",
                            "WHERE Butik = " + cCl,"ProfilNr")
       .  
IF cAlle = "" THEN
  ASSIGN cAlle = "[Alle]".

ASSIGN cmbVarebehType:LIST-ITEM-PAIRS IN FRAME frmFilter = cAlle + ",0,Bestilling,1,Varemottak,2"
       cmbVarebehType:SCREEN-VALUE = "0"
       .

RUN Weeknum.p (TODAY,OUTPUT iStartWeek).
/* RUN Weeknum.p (DATE(12,31,YEAR(TODAY) + 1),OUTPUT iEndWeek).  */

DO WITH FRAME frmListe:
  ASSIGN cBrwListFlds = "VarebehHode"
                      + ";VarebehNr|Vareh.nr"
                      + ";VarebehBeskrivelse"
                      + ";VarebehType|Type"
                      + ";MesseNr;ProfilNr;EkstRef;Oppdatert;OppdatDato;EDato;BrukerId"
                      + ";!VarebehNotat;!OppdatAv;!ButikkListe"
                      + ",Messe;MesseBeskrivelse"
                      + ",PrisProfil;KortNavn|Profil"
                      + ",SysPara;Beskrivelse"
         cBrwListJoin = ",FIRST Messe NO-LOCK where Messe.MesseNr = VarebehHode.MesseNr OUTER-JOIN " 
                      + ",FIRST PrisProfil NO-LOCK where PrisProfil.ProfilNr = VarebehHode.ProfilNr OUTER-JOIN"
                      + ",FIRST SysPara NO-LOCK WHERE SysHId = 5 and SysGr = 6 and ParaNr = VarebehHode.VarebehType OUTER-JOIN"
                         .

  hBrowseListe = DYNAMIC-FUNCTION("NewBrowse",                 /* Create a browse object */
                    rectBrowseListe:HANDLE IN FRAME frmListe,  /* Rectangle to define coordinates for browse */
                    50,                                       /* Rows to batch */
                    "NUM-LOCKED-COLUMNS|1",           /* Browse properties, ie MULTIPLE,NUM-LOCKED-COLUMNS, etc */
                    cBrwListFlds,
                    "WHERE true" + cBrwListJoin
                    ,"sort|VarebehNr DESC").                          /* Misc - for something I might need in next version.. */
  hBrowseListe:NAME = "brwListe". /* This name is neccessary because the browser is due to special treatment during resize */
  DYNAMIC-FUNCTION("setAttribute",hBrowseListe,"querywhere","").
  DYNAMIC-FUNCTION("setAttribute",hBrowseListe,"nocolumnsearch","MesseBeskrivelse,Kortnavn,Beskrivelse").
  
  hBrowseListe:MOVE-COLUMN(13,4).
  hBrowseListe:MOVE-COLUMN(12,6).
  hBrowseListe:MOVE-COLUMN(13,8).
  hSearchListe = DYNAMIC-FUNCTION("NewBrowseSearchField",RectBrowseSearchListe:HANDLE,hBrowseListe,1).
END.

DO WITH FRAME frmDetalj:
 
  hFieldMap = DYNAMIC-FUNCTION("NewFieldMap",      /* A fieldmap object holds extra info for display and input fields (fill-ins)
                                                       and their corresponding buffer columns return handle equals the buffer handle */
                    hBrowseListe:QUERY,
                    FRAME frmDetalj:HANDLE,         /* Frame for the input/display fields (might not be the same frame as the browse) */
                                                    /* Nb: Felt som brukes her må være hentet i Browser først.                        */
                    "ProfilNr,VarebehBeskrivelse,MesseNr,EkstRef,VarebehNotat,Oppdatert"
                    ,"",       
                    "VarebehNr,MesseBeskrivelse,KortNavn,VarebehType,ButikkListe,OppdatDato,OppdatAv", /* Additional buffer and displ.fields - not updateable*/
                    "",  
                    "").     /* Input fields other than in buffer */

  DYNAMIC-FUNCTION("setAttribute",hFieldMap,"customUpdateValProc","ignore"). 
  DYNAMIC-FUNCTION("setAttribute",hFieldMap,"customDeleteValProc","=delval_varebehhode.p"). 
  DYNAMIC-FUNCTION("setAttribute",hFieldMap,"BufferExtraFields","OppdatAv,OppdatDato,VarebehType,ButikkListe"). 
END.

RUN InitLinje.

/* Menyer: */

DYNAMIC-FUNCTION("NewMenuBand",
                  hBrowseListe,  /* parent widget */
                  "Deselect;Fjern markering av rad",
                  "").   

DYNAMIC-FUNCTION("NewMenuBand",
                  hBrowseLinje,  /* parent widget */
                  "Deselect;Fjern markering av rad"
                  + ",MultiSortBrowse;Sorter på flere kolonner" 
                  + ",|rule" 
                  + ",SkiftStrType;Bytt størrelsestype" 
                  ,
                  "").     


DO WITH FRAME {&FRAME-NAME}:
  IF CAN-DO("1",cAdgang) THEN
      hUpdToolBar = DYNAMIC-FUNCTION("NewToolBar",
                    rectUpdToolBar:HANDLE,         
                    "Fil",                         
                    "Undo;Angre,save;Lagre,FlatView,excel;Eksporter til E&xcel"
                     + ",rule,first|Naviger;Første,prev|Naviger;Forrige,next|Naviger;Neste,last|Naviger;Siste,|Innstillinger,rule"
                     + ",StartUtvalg;Utvalg"
                     + ",HentUtvalg;Hent artikler fra utvalg",
                    "maxborder").   
  ELSE
      hUpdToolBar = DYNAMIC-FUNCTION("NewToolBar",
                    rectUpdToolBar:HANDLE,     
                    "Fil",                     
                    "New;Ny,Copy;Kopier,Edit;&Endre,Undo;Angre,delete;Slett,save;Lagre,FlatView,excel;Eksporter til E&xcel"
                     + ",rule,first|Naviger;Første,prev|Naviger;Forrige,next|Naviger;Neste,last|Naviger;Siste,|Innstillinger"
                     + ",rule,StartUtvalg;Utvalg"
                     + ",HentUtvalg;Hent artikler fra utvalg",
                    "maxborder").      

  cBtnUtvalgHandles     = DYNAMIC-FUNCTION("getToolbarHandles",hUpdToolbar,"*StartUtvalg*").
  cBtnHentUtvalgHandles = DYNAMIC-FUNCTION("getToolbarHandles",hUpdToolbar,"*HentUtvalg*").

  hToolBar = DYNAMIC-FUNCTION("NewToolBar",
                    rectToolBar:HANDLE,             
                    "Fil",                          
                    "Help|Hjelp,Close;Avslutt",
                    "").   
  
  /* Link objects: */

  DYNAMIC-FUNCTION("createObjectLink",hBrowseListe,hUpdToolbar).
  DYNAMIC-FUNCTION("createObjectLink",hFieldMap,hUpdToolbar).
  DYNAMIC-FUNCTION("createObjectLink",hBrowseListe,hFieldMap).
  DYNAMIC-FUNCTION("createObjectLink",hBrowseLinje,hFieldMapLinje).
  DYNAMIC-FUNCTION("createObjectLink",hBrowseListe,hSearchListe).
  DYNAMIC-FUNCTION("createObjectLink",hBrowseLinje,hSearchLinje).

  DYNAMIC-FUNCTION("setAddMoveX",   THIS-PROCEDURE:CURRENT-WINDOW, FRAME {&FRAME-NAME}:HANDLE, "rectNavVarebeh").
  DYNAMIC-FUNCTION("setNoResizeY",  THIS-PROCEDURE:CURRENT-WINDOW, FRAME {&FRAME-NAME}:HANDLE, "rectUpdToolBar,rectVarebeh").
  DYNAMIC-FUNCTION("setNoResizeX",  THIS-PROCEDURE:CURRENT-WINDOW, FRAME {&FRAME-NAME}:HANDLE, "rectNavVarebeh").

  DYNAMIC-FUNCTION("setNoResizeY",  THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmFilter:HANDLE, "frmFilter").

  DYNAMIC-FUNCTION("setNoResizeX",  THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmListe:HANDLE, "RectBrowseSearchListe").

  DYNAMIC-FUNCTION("setNoResizeX",  THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmDetalj:HANDLE, "rect-1").
  DYNAMIC-FUNCTION("setNoResizeY",  THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmDetalj:HANDLE, "rect-1").

  DYNAMIC-FUNCTION("setNoResizeX",  THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmLinje:HANDLE, "RectBrowseSearchLinje,IMAGE-Sko,brwAndreBest,rectBrwAndreBest").
  DYNAMIC-FUNCTION("setNoResizeY",  THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmLinje:HANDLE, "IMAGE-Sko,brwLinje,rectBrowseLinje,brwLinje,brwBestHode,rectBrwBestHode,rectBestHodeToolbar,brwAndreBest,rectBrwAndreBest,rectStatFields").
  DYNAMIC-FUNCTION("setNoMoveY",    THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmLinje:HANDLE, "ButikkNr,brwTrans").
  DYNAMIC-FUNCTION("setAddResizeX", THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmLinje:HANDLE, "fi-cAnnenVarebeh,LinjeMerknad").
  DYNAMIC-FUNCTION("setAddMoveX",   THIS-PROCEDURE:CURRENT-WINDOW, FRAME frmLinje:HANDLE, "IMAGE-Sko,LevUke,rectBrwAndreBest,brwAndreBest,fi-cAndreBestLabel").

  DYNAMIC-FUNCTION("setSplitBarY" ,THIS-PROCEDURE:CURRENT-WINDOW, btnSplitBarY:HANDLE IN FRAME frmLinje,NO).
  DYNAMIC-FUNCTION("setSplitBarYlimits",btnSplitBarY:HANDLE,420,200).
  DYNAMIC-FUNCTION("setFollowSplitBarY",THIS-PROCEDURE:CURRENT-WINDOW, btnSplitBarY:HANDLE,
                    STRING(rectBrwBestHode:HANDLE) + "," +
                    STRING(hBrowseBestHode) + "," +
                    STRING(button-slett:HANDLE) + "," +
                    STRING(Grid:HANDLE) + "," + 
                    STRING(rectBrwAndreBest:HANDLE) + "," +
                    STRING(hBrowseAndreBest)
                    ).

  DYNAMIC-FUNCTION("setOrgWinSize", THIS-PROCEDURE:CURRENT-WINDOW,800,580,0,0).

  DYNAMIC-FUNCTION("initTranslation",THIS-PROCEDURE:CURRENT-WINDOW).

  DYNAMIC-FUNCTION("SetToolbar",hToolBar,"enable").

END.

SUBSCRIBE TO "ArtBasEndret" ANYWHERE.
SUBSCRIBE TO "NyArtBas" ANYWHERE.
SUBSCRIBE TO "ExcelSheetParams" ANYWHERE.
SUBSCRIBE TO "getVareSlagExceptList" ANYWHERE.

TabStripChanged(11).

THIS-PROCEDURE:CURRENT-WINDOW:HIDDEN = FALSE.

IF NOT hFieldMap:AVAIL AND hBrowseListe:QUERY:IS-OPEN THEN
  hBrowseListe:QUERY:GET-FIRST().

/* IF hBrowseListe:NUM-ITERATIONS > 0 THEN    */
/*     APPLY "value-changed" TO hBrowseListe. */

APPLY "ENTRY" TO hBrowseListe.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE InvalidateHandle C-Win 
PROCEDURE InvalidateHandle :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT PARAM ihInvalid AS HANDLE NO-UNDO.

CASE ihInvalid:
  WHEN hStrekkode THEN hStrekkode = ?.
END CASE.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE KalkyleRecord C-Win 
PROCEDURE KalkyleRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
IF hFieldMap:BUFFER-FIELD("VareBehType"):BUFFER-VALUE NE iBestVarebeh THEN DO:
  RUN d-vArtKalkyle.w (DYNAMIC-FUNCTION("getRecId","ArtBas",hFieldMapLinje:BUFFER-FIELD("RowIdent2"):BUFFER-VALUE)).
  RUN ArtBasEndret(hFieldMapLinje:BUFFER-FIELD("ArtikkelNr"):BUFFER-VALUE).
  APPLY "entry" TO Grid.
END.
ELSE
  RUN d-vBestKalkyle.w (DYNAMIC-FUNCTION("getRecId","ArtBas",hFieldMapLinje:BUFFER-FIELD("RowIdent2"):BUFFER-VALUE),
                        DYNAMIC-FUNCTION("getRecId","BestHode",hFieldMapBestHode:BUFFER-FIELD("RowIdent2"):BUFFER-VALUE)
                        ).

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE LagreBestLinje C-Win 
PROCEDURE LagreBestLinje :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEFINE VAR iRow     AS INTE NO-UNDO.
DEFINE VAR iCol     AS INTEGER    NO-UNDO.
DEF VAR iTmpLinjeId AS INT NO-UNDO.

EMPTY TEMP-TABLE TT_VareBehBestLinje.

DO iRow = 1 TO chGrid:Rows - 1:
  IF NOT Registrerat(iRow) THEN
      NEXT.
  DO iCol = 2 TO chGrid:Cols - 1:
    IF INT(chGrid:TextMatrix(iRow,iCol)) = 0 THEN NEXT.

    CREATE TT_VareBehBestLinje.
    ASSIGN TT_VareBehBestLinje.VareBehNr       = hFieldMap:BUFFER-FIELD("VarebehNr"):BUFFER-VALUE
           TT_VareBehBestLinje.CLButikkNr      = hFieldMapBestHode:BUFFER-FIELD("CLButikkNr"):BUFFER-VALUE
           TT_VareBehBestLinje.HodeLinjeId     = hFieldMapBestHode:BUFFER-FIELD("HodeLinjeId"):BUFFER-VALUE
           TT_VareBehBestLinje.BestiltButikkNr = INT(chGrid:TextMatrix(iRow,0))
           TT_VareBehBestLinje.Bestilt         = INT(chGrid:TextMatrix(iRow,iCol))
           TT_VareBehBestLinje.Storl           = TRIM(chGrid:TextMatrix(0,iCol))
           .
  END.
END.

iTmpLinjeId = hFieldMapBestHode:BUFFER-FIELD("HodeLinjeId"):BUFFER-VALUE.
IF NOT DYNAMIC-FUNCTION("runproc","varebehbest_lagrebestlinje.p",
                         STRING(hFieldMap:BUFFER-FIELD("VarebehNr"):BUFFER-VALUE) + "," +
                         STRING(hFieldMapBestHode:BUFFER-FIELD("CLButikkNr"):BUFFER-VALUE) + "," +
                         STRING(hFieldMapBestHode:BUFFER-FIELD("HodeLinjeId"):BUFFER-VALUE) + "," +
                         LevUke:SCREEN-VALUE IN FRAME frmLinje + "," +
                         (IF VarebehType:SCREEN-VALUE IN FRAME frmDetalj = ENTRY(1,cBestTypeDesc,"|") THEN "best" ELSE "innlev"),
                         hBufftt_varebehbestlinje:TABLE-HANDLE) THEN
  DYNAMIC-FUNCTION("DoMessage",0,0,DYNAMIC-FUNCTION("getTransactionMessage"),"Feil","").
ELSE DO:
  SkrivEtikett(DYNAMIC-FUNCTION("getTransactionMessage")).

  DYNAMIC-FUNCTION("RefreshRowids",hBrowseLinje,hBrowseLinje:QUERY:GET-BUFFER-HANDLE(1):BUFFER-FIELD("RowIdent1"):BUFFER-VALUE).
  APPLY "value-changed" TO hBrowseLinje.
  bOK = hFieldMapBestHode:FIND-FIRST("WHERE HodeLinjeId = " + STRING(iTmpLinjeId)) NO-ERROR.
  IF bOK THEN DO:
    hBrowseBestHode:SET-REPOSITIONED-ROW(hBrowseBestHode:DOWN,"conditional").
    hBrowseBestHode:QUERY:REPOSITION-TO-ROWID(hFieldMapBestHode:ROWID) NO-ERROR.
    IF NOT ERROR-STATUS:ERROR THEN 
      APPLY "value-changed" TO hBrowseBestHode.
  END.
  APPLY "entry" TO hBrowseLinje.
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE LeaveOfField C-Win 
PROCEDURE LeaveOfField :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT PARAM icFieldName AS CHAR NO-UNDO.

CASE icFieldName:
  WHEN "LevUke" THEN DO:
    IF INT(LevUke:SCREEN-VALUE IN FRAME frmLinje) < iStartWeek AND INT(LevUke:SCREEN-VALUE) NE 0 THEN DO:
      DYNAMIC-FUNCTION("DoMessage",0,1,"Ugyldig leveringsuke. Angi ååååuu","Feil","").
      RETURN NO-APPLY.
    END.
  END.
END CASE.
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE MoveToTop C-Win 
PROCEDURE MoveToTop :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
{&WINDOW-NAME}:WINDOW-STATE = 3.
{&WINDOW-NAME}:MOVE-TO-TOP().
/* APPLY "entry" TO hBrowse.  */
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE MyDeleteMessage C-Win 
PROCEDURE MyDeleteMessage :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF OUTPUT PARAMETER obOk AS LOG NO-UNDO.

DEF VAR hCurrObject AS HANDLE NO-UNDO.

hCurrObject = DYNAMIC-FUNCTION("getCurrentObject").

CASE hCurrObject:
  WHEN hFieldMap THEN
    MESSAGE "Er du helt sikker på at du vil slette hele varehåndteringsboken med alle artikler?"
            VIEW-AS ALERT-BOX QUESTION BUTTONS YES-NO
            UPDATE obOk.
  WHEN hFieldMapLinje THEN
    MESSAGE "Slett artikkel (med tilhørende bestillinger eller varemottak)?"
            VIEW-AS ALERT-BOX QUESTION BUTTONS YES-NO
            UPDATE obOk.
  WHEN hFieldMapBestHode THEN
    MESSAGE "Slett bestilling/varemottak?"
            VIEW-AS ALERT-BOX QUESTION BUTTONS YES-NO
            UPDATE obOk.
END CASE.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE NewRecord C-Win 
PROCEDURE NewRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF VAR rNew    AS ROWID NO-UNDO.
DEF VAR cType   AS CHAR NO-UNDO.
  
IF iTab = 1 THEN 
  TabStripChanged(12).

IF can-do("1,2",string(iTab)) THEN
DO:
  RUN SUPER.

  RUN dVarebehType.w (OUTPUT cType, OUTPUT bOK).
  IF NOT bOK THEN DO:
    RUN UndoRecord.
    RETURN.
  END.
  ELSE DO:
    RUN VelgButikker ("new", OUTPUT bOK).
    IF NOT bOk THEN DO:
      DYNAMIC-FUNCTION("setCurrentObject",hBrowseListe).
      RUN DisplayRecord.
      RETURN.
    END.
  END.

  DO WITH FRAME frmDetalj:
    ProfilNr:SCREEN-VALUE = cInitPrisProfil.
    APPLY "ENTRY" TO VarebehType.
    IF cType = ENTRY(1,cBestTypeDesc,"|") THEN
      ASSIGN VarebehType:SCREEN-VALUE = ENTRY(1,cBestTypeDesc,"|")
             Beskrivelse:SCREEN-VALUE = ENTRY(2,cBestTypeDesc,"|")
             .
    ELSE
      ASSIGN VarebehType:SCREEN-VALUE = ENTRY(1,cInnlevTypeDesc,"|")
             Beskrivelse:SCREEN-VALUE = ENTRY(2,cInnlevTypeDesc,"|")
             .
  END.
END.
ELSE IF iTab = 3 THEN DO:
  IF DYNAMIC-FUNCTION("getCurrentObject") = hUpdToolbar THEN DO:
    THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
    RUN ArtBasVedlikehold.w (THIS-PROCEDURE,"new",OUTPUT bOK).
    THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.
    THIS-PROCEDURE:CURRENT-WINDOW:MOVE-TO-TOP().

    IF bOK THEN DO:
      IF hFieldMap:BUFFER-FIELD("VareBehType"):BUFFER-VALUE = iBestVarebeh THEN 
        APPLY "entry" TO LevUke IN FRAME frmLinje.
      ELSE APPLY "entry" TO Grid.
    END.
    
/*     IF NOT VALID-HANDLE(hArtikkelkort) THEN                                                                                         */
/*       RUN w-vartkor.w  PERSIST SET hArtikkelkort                                                                                    */
/*           (IF hFieldMapLinje:AVAIL THEN DYNAMIC-FUNCTION("getRecId","ArtBas",hFieldMapLinje:BUFFER-FIELD("RowIdent2"):BUFFER-VALUE) */
/*            ELSE ?,                                                                                                                  */
/*            "NY").                                                                                                                   */
/*     ELSE                                                                                                                            */
/*       RUN ApplyButtonNy IN hArtikkelkort.                                                                                           */
  END.
  ELSE DO: 
    DYNAMIC-FUNCTION("setAttribute",hBestHodeToolbar,"disabledevents","").
    RUN InitGrid("clear").
    RUN SUPER.
    RUN SaveRecord.
/*     hKalkyleButton:SENSITIVE = FALSE.    */
/*     hStrekkodeButton:SENSITIVE = FALSE.  */
    IF hFieldMap:BUFFER-FIELD("VarebehType"):BUFFER-VALUE NE iBestVarebeh THEN DO:
      Grid:SENSITIVE = TRUE.
      APPLY "entry" TO Grid.
    END.
    ELSE Grid:SENSITIVE = TRUE.
  END.
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE newVarebehLinje C-Win 
PROCEDURE newVarebehLinje :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT PARAM ifArtikkelNr AS HANDLE NO-UNDO.

DEF VAR phBuffer AS HANDLE NO-UNDO.
DEF VAR rRepos   AS ROWID NO-UNDO.

ASSIGN
    rRowIdLinje = ?
    .

/* Via AppServer */
IF DYNAMIC-FUNCTION("getAppserviceHandle") <> ? THEN DO:
  RUN newVarebehlinje.p ON DYNAMIC-FUNCTION("getAppserviceHandle") 
      (ifArtikkelNr,dec(VarebehNr:SCREEN-VALUE IN FRAME frmDetalj),OUTPUT rRowIdLinje) NO-ERROR.
  IF ERROR-STATUS:ERROR THEN
  DO:
      IF DYNAMIC-FUNCTION("reConnectServer") THEN
          run newVarebehLinje.p ON DYNAMIC-FUNCTION("getAppserviceHandle") 
              (ifArtikkelNr,dec(VarebehNr:SCREEN-VALUE IN FRAME frmDetalj),OUTPUT rRowIdLinje) NO-ERROR.
  END.       
END.
/* Direkte */
ELSE
  RUN newVarebehlinje.p (ifArtikkelNr,dec(VarebehNr:SCREEN-VALUE IN FRAME frmDetalj),OUTPUT rRowIdLinje) NO-ERROR.

IF rRowIdLinje <> ? THEN DO:
  IF hBrowseLinje:FOCUSED-ROW NE ? THEN
    hBrowseLinje:SELECT-ROW(hBrowseLinje:FOCUSED-ROW).
  hFieldMapLinje:BUFFER-CREATE().
  hFieldMapLinje:BUFFER-FIELD("Rowident1"):BUFFER-VALUE = STRING(rRowIdLinje).
  rRepos = hFieldMapLinje:ROWID.

  hBrowseLinje:QUERY:QUERY-OPEN().
  hBrowseLinje:SET-REPOSITIONED-ROW(hBrowseLinje:FOCUSED-ROW,"conditional").
  hBrowseLinje:QUERY:REPOSITION-TO-ROWID(rRepos).

  IF DYNAMIC-FUNCTION("refreshRowids",hBrowseLinje,STRING(rRowIdLinje)) = 0 THEN
    hBrowseLinje:DELETE-CURRENT-ROW().

  DYNAMIC-FUNCTION("setCurrentObject",hBrowseLinje).
  RUN DisplayRecord.
END.
ELSE DO:
    MESSAGE RETURN-VALUE
        VIEW-AS ALERT-BOX WARNING BUTTONS OK.
    APPLY "ENTRY":U TO hBrowseLinje.
    RETURN NO-APPLY.
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE NyArtBas C-Win 
PROCEDURE NyArtBas :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT PARAM ifArtikkelNr AS DEC NO-UNDO.

DEF VAR bTmpAlt-S AS LOG NO-UNDO.

bOK = hFieldMapLinje:FIND-FIRST("WHERE VarebehNr = " + STRING(hFieldMap:BUFFER-FIELD("VarebehNr"):BUFFER-VALUE) 
                               + " AND ArtikkelNr = " + STRING(ifArtikkelNr)
                                ,NO-LOCK) NO-ERROR.
ASSIGN bNewArt   = TRUE
       bTmpAlt-S = bAlt-S
       bAlt-S    = FALSE
       .

IF bOK THEN DO:
  hBrowseLinje:QUERY:REPOSITION-TO-ROWID(hFieldMapLinje:ROWID) NO-ERROR.
  IF NOT ERROR-STATUS:ERROR THEN 
    APPLY "value-changed" TO hBrowseLinje.
END.
ELSE DO:
  RUN newVarebehLinje (ifArtikkelNr).
  IF rRowIdLinje <> ? THEN DO:
    DYNAMIC-FUNCTION("setCurrentObject",hBestHodeToolbar).
    RUN NewRecord.
    RUN SaveRecord.

    DYNAMIC-FUNCTION("setToolbar",hBrowseLinje,"enable").

    bAlt-S = bTmpAlt-S.
    APPLY "entry" TO LevUke IN FRAME frmLinje.
  END.
END.

bNewArt = FALSE.
FreezeWin (FALSE).

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE NyVarebeh C-Win 
PROCEDURE NyVarebeh :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT PARAM icType   AS CHAR NO-UNDO.

DEF VAR cFieldList AS CHAR NO-UNDO.
DEF VAR cValueList AS CHAR NO-UNDO.
DEF VAR cLevNr     AS CHAR NO-UNDO.
DEF VAR rRepos     AS ROWID NO-UNDO.

THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.

cmbVarebehType:SCREEN-VALUE IN FRAME frmFilter = icType.

RUN NyButVarebeh.w (icType,OUTPUT cFieldList, OUTPUT cValueList, OUTPUT cLevNr).

THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.

IF cFieldList NE "" THEN DO:
  DYNAMIC-FUNCTION("DoLockWindow",THIS-PROCEDURE:CURRENT-WINDOW).
  IF DYNAMIC-FUNCTION("DoCreate","VarebehHode","ignore",
                             cFieldList,
                             cValueList,
                             TRUE) THEN DO:

    hBrowseListe:QUERY:GET-BUFFER-HANDLE(1):BUFFER-CREATE.

    rRepos = hBrowseListe:QUERY:GET-BUFFER-HANDLE(1):ROWID.
    DYNAMIC-FUNCTION("DoRefetchTrans",hBrowseListe:QUERY:GET-BUFFER-HANDLE(1),"FIRST","").
    DYNAMIC-FUNCTION("refreshRow",hBrowseListe,
                      DYNAMIC-FUNCTION("getAttribute",hBrowseListe,"buffersandfields"),
                      DYNAMIC-FUNCTION("getAttribute",hBrowseListe,"queryjoin")).

    hBrowseListe:QUERY:QUERY-OPEN().
    hBrowseListe:SET-REPOSITIONED-ROW(hBrowseListe:DOWN,"conditional").
    hBrowseListe:QUERY:REPOSITION-TO-ROWID(rRepos).

    APPLY "value-changed" TO hBrowseListe.
    hBrowseListe:QUERY:REPOSITION-TO-ROWID(rRepos).


    TabStripChanged(13).

    IF cLevNr NE "" THEN DO:
      sokLevNr:SCREEN-VALUE IN FRAME frmLinje = cLevnr.
      APPLY "tab" TO sokLevNr.
    END.
    ELSE RUN OpenQuery.

  END.
  ELSE DYNAMIC-FUNCTION("DoMessage",0,0,DYNAMIC-FUNCTION("getTransactionMessage"),"","").
  DYNAMIC-FUNCTION("DoLockWindow",?).
END.
ELSE RUN OpenQuery.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE OpenQuery C-Win 
PROCEDURE OpenQuery :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF VAR iUtskrNr                  AS INT NO-UNDO.
DEF VAR cThisAktivitetJoin        AS CHAR NO-UNDO.
DEF VAR cThisBestHodeJoin         AS CHAR NO-UNDO INIT ",FIRST VarebehBestHode OF VarebehLinje WHERE ".
DEF VAR cBestHodeFilter           AS CHAR NO-UNDO.

IF iTab = 1 THEN DO WITH FRAME frmFilter:
  DYNAMIC-FUNCTION("SetCurrentObject",hBrowseListe).
  DYNAMIC-FUNCTION("SetAttribute",hBrowseListe,"queryfilter",
                   (IF fi-fProfilNr:SCREEN-VALUE NE "0" THEN
                     " where ProfilNr = " + fi-fProfilNr:SCREEN-VALUE
                    ELSE "where true") +
                   (IF fi-fVarebehNr:SCREEN-VALUE NE "0" THEN
                     " AND VarebehNr = " + fi-fVarebehNr:SCREEN-VALUE
                    ELSE "") +
                   (IF cmbVarebehType:SCREEN-VALUE NE "0" THEN
                     " AND VarebehType = " + cmbVarebehType:SCREEN-VALUE
                    ELSE "") +
                   (IF fi-fMesseNr:SCREEN-VALUE NE "0" THEN
                     " AND MesseNr = " + fi-fMesseNr:SCREEN-VALUE
                    ELSE "") +
                   (IF fi-cVarebehBeskrivelse:SCREEN-VALUE NE "" THEN
                      IF fi-cVarebehBeskrivelse:SCREEN-VALUE BEGINS "*" THEN
                       " AND VarebehBeskrivelse MATCHES '" + fi-cVarebehBeskrivelse:SCREEN-VALUE + "*'"
                      ELSE
                       " AND VarebehBeskrivelse BEGINS '" + fi-cVarebehBeskrivelse:SCREEN-VALUE + "'"
                    ELSE "") +
                   (IF fi-cEkstRef:SCREEN-VALUE NE "" THEN
                      IF fi-cEkstRef:SCREEN-VALUE BEGINS "*" THEN
                       " AND EkstRef MATCHES '" + fi-cEkstRef:SCREEN-VALUE + "*'"
                      ELSE
                       " AND EkstRef BEGINS '" + fi-cEkstRef:SCREEN-VALUE + "'"
                    ELSE "")
                   ).
  DYNAMIC-FUNCTION("setAttribute",hBrowseListe,"buffersandfields",cBrwListFlds
                 + (IF ListeSokLevnr:SCREEN-VALUE IN FRAME frmFilter NE "0" THEN
                      ",VarebehLinje;"
                    ELSE "")
                   ).  
  DYNAMIC-FUNCTION("setAttribute",hBrowseListe,"queryjoin",cBrwListJoin
                 + (IF ListeSokLevnr:SCREEN-VALUE IN FRAME frmFilter NE "0" THEN
                      ",FIRST VarebehLinje OF VarebehHode WHERE LevNr = " + ListeSokLevnr:SCREEN-VALUE
                    ELSE "")
                   ).  
  DYNAMIC-FUNCTION("setAttribute",hBrowseLinje,"queryfilter"," and false").
END.

ELSE IF iTab = 3 THEN DO WITH FRAME frmLinje:
  ASSIGN sokFraEdato sokFraVPIdato sokTilEdato sokTilVPIdato sokFraRegDatoBestInnl sokTilRegDatoBestInnl
         sokAvdelingNavn:MODIFIED       = FALSE
         sokAvdelingNr:MODIFIED         = FALSE
         sokHg:MODIFIED                 = FALSE
         sokHgBeskr:MODIFIED            = FALSE
         sokVg:MODIFIED                 = FALSE
         sokVgBeskr:MODIFIED            = FALSE
         sokAktNr:MODIFIED              = FALSE
         sokAktBeskrivelse:MODIFIED     = FALSE
         sokBeskr:MODIFIED              = FALSE
         sokLinjeMerknad:MODIFIED       = FALSE
         sokFraEdato:MODIFIED           = FALSE
         sokFraVPIdato:MODIFIED         = FALSE
         sokTilEdato:MODIFIED           = FALSE
         sokTilVPIdato:MODIFIED         = FALSE
         sokFraRegDatoBestInnl:MODIFIED = FALSE
         sokTilRegDatoBestInnl:MODIFIED = FALSE
         .
  DYNAMIC-FUNCTION("SetCurrentObject",hBrowseLinje).
  DYNAMIC-FUNCTION("setAttribute",hBrowseLinje,"queryfilter","").

  DYNAMIC-FUNCTION("setAttribute",hBrowseLinje,"QueryFilter",
                   (IF sokAvdelingNr:SCREEN-VALUE NE "0" THEN
                     " AND AvdelingNr = " + sokAvdelingNr:SCREEN-VALUE
                    ELSE IF sokAvdelingNavn:SCREEN-VALUE NE "" AND NUM-ENTRIES(cAvdelingRowIdList) < 2 THEN
                      " AND " +
                      (IF INDEX(sokAvdelingNavn:SCREEN-VALUE,"*") > 0 THEN 
                        "AvdelingNavn MATCHES '" + sokAvdelingNavn:SCREEN-VALUE + "*'"
                       ELSE
                        "AvdelingNavn BEGINS '" + sokAvdelingNavn:SCREEN-VALUE + "'")
                    ELSE IF sokAvdelingNavn:SCREEN-VALUE NE "" AND NUM-ENTRIES(cAvdelingRowIdList) > 1 THEN
                      " AND CAN-DO('" + REPLACE(cAvdelingIdList,"|",",") + "',STRING(AvdelingNr))"
                    ELSE "")
                 + (IF sokHg:SCREEN-VALUE NE "0" THEN
                     " AND Hg = " + sokHg:SCREEN-VALUE
                    ELSE IF sokHgBeskr:SCREEN-VALUE NE "" AND NUM-ENTRIES(cHuvGrRowIdList) < 2 THEN
                     " AND " +
                     (IF INDEX(sokHgBeskr:SCREEN-VALUE,"*") > 0 THEN
                       "HgBeskr MATCHES '" + sokHgBeskr:SCREEN-VALUE + "*'"
                      ELSE
                       "HgBeskr BEGINS '" + sokHgBeskr:SCREEN-VALUE + "'")
                    ELSE IF sokHgBeskr:SCREEN-VALUE NE "" AND NUM-ENTRIES(cHuvGrRowIdList) > 1 THEN
                      " AND CAN-DO('" + REPLACE(cHuvGrIdList,"|",",") + "',STRING(Hg))"
                    ELSE "") 
                 + (IF sokVg:SCREEN-VALUE NE "0" THEN
                     " AND Vg = " + sokVg:SCREEN-VALUE
                    ELSE IF sokVgBeskr:SCREEN-VALUE NE "" AND NUM-ENTRIES(cVarGrRowIdList) < 2 THEN
                      " AND " +
                     (IF INDEX(sokVgBeskr:SCREEN-VALUE,"*") > 0 THEN
                       "VgBeskr MATCHES '" + sokVgBeskr:SCREEN-VALUE + "*'"
                      ELSE
                       "VgBeskr BEGINS '" + sokVgBeskr:SCREEN-VALUE + "'")
                    ELSE IF sokVgBeskr:SCREEN-VALUE NE "" AND NUM-ENTRIES(cVarGrRowIdList) > 1 THEN
                      " AND CAN-DO('" + REPLACE(cVarGrIdList,"|",",") + "',STRING(Vg))"
                    ELSE "") 
                 + (IF sokLevNr:SCREEN-VALUE NE "0" THEN
                     " AND LevNr = " + sokLevNr:SCREEN-VALUE
                    ELSE IF sokLevNamn:SCREEN-VALUE NE "" AND NUM-ENTRIES(cLevBasRowIdList) < 2 THEN
                      " AND " +
                     (IF INDEX(sokLevNamn:SCREEN-VALUE,"*") > 0 THEN
                       "LevNamn MATCHES '" + sokLevNamn:SCREEN-VALUE + "*'"
                      ELSE
                       "LevNamn BEGINS '" + sokLevNamn:SCREEN-VALUE + "'")
                    ELSE IF sokLevNamn:SCREEN-VALUE NE "" AND NUM-ENTRIES(cLevBasRowIdList) > 1 THEN
                      " AND CAN-DO('" + REPLACE(cLevBasIdList,"|",",") + "',STRING(LevNr))"
                    ELSE "")
                 + (IF sokBeskr:SCREEN-VALUE NE "" THEN
                     " AND Beskr " + 
                     (IF INDEX(sokBeskr:SCREEN-VALUE,"*") > 0 THEN 
                       "MATCHES '" + sokBeskr:SCREEN-VALUE + "*'"
                      ELSE 
                       "BEGINS '" + sokBeskr:SCREEN-VALUE + "'")
                    ELSE "") 
                 + (IF sokLinjeMerknad:SCREEN-VALUE NE "" THEN
                     " AND LinjeMerknad " + 
                     (IF INDEX(sokLinjeMerknad,"*") > 0 THEN 
                       "MATCHES '" + sokLinjeMerknad:SCREEN-VALUE + "*'"
                      ELSE 
                       "BEGINS '" + sokLinjeMerknad:SCREEN-VALUE + "'")
                    ELSE "") 
                 + (IF sokFraEdato NE ? THEN
                     " AND Edato GE DATE('" + sokFraEdato:SCREEN-VALUE + "')"
                    ELSE "")
                 + (IF sokTilEdato NE ? THEN
                     " AND Edato LE DATE('" + sokTilEdato:SCREEN-VALUE + "')"
                    ELSE "")
                 + (IF sokFraVPIdato NE ? THEN
                     " AND VPIdato GE DATE('" + sokFraVPIdato:SCREEN-VALUE + "')"
                    ELSE "")
                 + (IF sokTilVPIdato NE ? THEN
                     " AND VPIdato LE DATE('" + sokTilVPIdato:SCREEN-VALUE + "')"
                    ELSE "")
                    ).

  IF sokAktNr:SCREEN-VALUE NE "0" THEN 
    cThisAktivitetJoin = ",first VgAkt WHERE VgAkt.Vg = VarebehLinje.Vg AND AktNr = " + sokAktNr:SCREEN-VALUE 
                       + ",first Aktivitet OF VgAkt".
  ELSE IF sokAktBeskrivelse:SCREEN-VALUE NE "" THEN
    cThisAktivitetJoin = ",EACH VgAkt WHERE VgAkt.Vg = VarebehLinje.Vg" 
                       + ",first Aktivitet OF VgAkt WHERE Beskrivelse " 
                       + (IF INDEX(sokAktBeskrivelse:SCREEN-VALUE,"*") > 0 THEN 
                           "MATCHES '" + sokAktBeskrivelse:SCREEN-VALUE + "*'"
                          ELSE
                           "BEGINS '" + sokAktBeskrivelse:SCREEN-VALUE + "'").
  ELSE
    cThisAktivitetJoin = cAktivitetJoin.

  IF sokFraRegDatoBestInnl NE ? AND sokTilRegDatoBestInnl NE ? THEN
    cBestHodeFilter = " VarebehBestHode.RegistrertDato GE DATE('" + sokFraRegDatoBestInnl:SCREEN-VALUE + "') " +
                        " AND VarebehBestHode.RegistrertDato LE DATE('" + sokTilRegDatoBestInnl:SCREEN-VALUE + "')".
  ELSE IF sokFraRegDatoBestInnl NE ? THEN
    cBestHodeFilter = " VarebehBestHode.RegistrertDato GE DATE('" + sokFraRegDatoBestInnl:SCREEN-VALUE + "')".
  ELSE IF sokTilRegDatoBestInnl NE ? THEN
    cBestHodeFilter = " VarebehBestHode.RegistrertDato LE DATE('" + sokTilRegDatoBestInnl:SCREEN-VALUE + "')".
  ELSE 
    cBestHodeFilter = "".

  DYNAMIC-FUNCTION("setAttribute",hBrowseBestHode,"queryfilter","").

  IF cBestHodeFilter NE "" THEN DO:
    cThisBestHodeJoin = cThisBestHodeJoin + cBestHodeFilter. 
    IF DYNAMIC-FUNCTION("getCurrentObject") = hBrowseLinje THEN 
      DYNAMIC-FUNCTION("setAttribute",hBrowseLinje,"buffersandfields",
                             "VarebehLinje" 
                             + ";LevNamn|Lev.navn|x(30)"
                             + ";ArtikkelNr"
                             + ";LevKod|Lev.art.nr|x(20)"
                             + ";Beskr|Art.navn|x(30)"
                             + ";LevFargKod|Lev.farge|x(20)"
                             + ";Vg|VgNr"
                             + ";VgBeskr|Beskr"
                             + ";Varekost"
                             + ";Pris"
                             + ";+SumAntall|DECIMAL|>>>>>9|butvarebehlinje_antall.p(ROWID" +
                                 (IF sokFraRegDatoBestInnl NE ? THEN STRING(sokFraRegDatoBestInnl,"99/99/99") ELSE "        ") +
                                 (IF sokTilRegDatoBestInnl NE ? THEN STRING(sokTilRegDatoBestInnl,"99/99/99") ELSE "") +
                                ")|Antall"
                             + ";+SumVarekost|DECIMAL|>><>>><>>9.99|butvarebehlinje_varekost.p(ROWID" + 
                                 (IF sokFraRegDatoBestInnl NE ? THEN STRING(sokFraRegDatoBestInnl,"99/99/99") ELSE "        ") +
                                 (IF sokTilRegDatoBestInnl NE ? THEN STRING(sokTilRegDatoBestInnl,"99/99/99") ELSE "") +
                                ")|Sum varekost"
                             + ";+SumPris|DECIMAL|>><>>><>>9.99|butvarebehlinje_pris.p(ROWID" + 
                                 (IF sokFraRegDatoBestInnl NE ? THEN STRING(sokFraRegDatoBestInnl,"99/99/99") ELSE "        ") +
                                 (IF sokTilRegDatoBestInnl NE ? THEN STRING(sokTilRegDatoBestInnl,"99/99/99") ELSE "") +
                                ")|Sum pris"
                             + ";!VarebehNr"

                             + ",ArtBas;!BildNr;!StrTypeId" 
                             + ";LopNr"
                             + ";!SalgsEnhet"
                             + ",BildeRegister;!Filnavn"
                             + ",VgAkt;!EDato"
                             + ",Aktivitet;!Edato"
                             + ",VarebehBestHode;!Edato"
                             ).
    IF DYNAMIC-FUNCTION("getCurrentObject") = hBrowseBestHode THEN 
      DYNAMIC-FUNCTION("setAttribute",hBrowseBestHode,"queryfilter"," AND " + cBestHodeFilter).
  END.
  ELSE DO:
    cThisBestHodeJoin = cBestHodeJoin.
    DYNAMIC-FUNCTION("setAttribute",hBrowseLinje,"buffersandfields",cVarebehLBuffAndFlds).
  END.

  DYNAMIC-FUNCTION("setAttribute",hBrowseLinje,"queryjoin",cVarebehlinjeJoin + cThisAktivitetJoin + cThisBestHodeJoin).

  IF tbUpdateStat AND DYNAMIC-FUNCTION("getCurrentObject") = hBrowseLinje THEN
    DYNAMIC-FUNCTION("setQueryStatFields",cStatFieldNames).
  ELSE
    DYNAMIC-FUNCTION("setQueryStatFields","").
END.

IF DYNAMIC-FUNCTION("getQueryStatFieldValues") NE "" THEN ViewStat(TRUE).

RUN SUPER.

RUN SettSensitive.

IF iTab = 1 THEN DO:
  IF NOT hFieldMap:AVAIL AND hBrowseListe:QUERY:IS-OPEN THEN
    hBrowseListe:QUERY:GET-FIRST().
  hBrowseListe:HELP = DYNAMIC-FUNCTION("getAttribute",hBrowseListe,"TotalCount").
  APPLY "entry" TO hBrowseListe.
END.
ELSE IF iTab = 3 THEN DO:
  IF NOT tbUpdateStat THEN DO:
    hBrowseLinje:HELP = DYNAMIC-FUNCTION("getAttribute",hBrowseLinje,"TotalCount").
    IF DYNAMIC-FUNCTION("getAttribute",hBrowseLinje,"lastrowid") = "" THEN
      hBrowseLinje:HELP = "Minst " + hBrowseLinje:HELP.
  END.
  APPLY "entry" TO hBrowseLinje.
END.
ELSE IF iTab = 4 THEN DO:
  hBrowseRegStat:HELP      = DYNAMIC-FUNCTION("getAttribute",hBrowseRegStat,"TotalCount").
  hBrowseRegStatTrans:HELP = DYNAMIC-FUNCTION("getAttribute",hBrowseRegStatTrans,"TotalCount").
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE PrevNext C-Win 
PROCEDURE PrevNext :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEFINE INPUT  PARAMETER cRettning AS CHARACTER  NO-UNDO.

IF CAN-DO("Prev,Next",cRettning) THEN DO:
  CASE cRettning:
      WHEN "Prev" THEN
          hBrowseLinje:SELECT-PREV-ROW().
      WHEN "Next" THEN
        hBrowseLinje:SELECT-NEXT-ROW().
  END CASE.
  APPLY "value-changed" TO hBrowseLinje.
END.
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE resetLinjeBrowse C-Win 
PROCEDURE resetLinjeBrowse :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
    APPLY "VALUE-CHANGED":U TO hBrowseListe.
    APPLY "ENTRY":U TO hBrowseLinje.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE ReturnOfWidget C-Win 
PROCEDURE ReturnOfWidget :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
IF FOCUS = LevUke:HANDLE IN FRAME frmLinje THEN DO:
  APPLY "entry" TO Grid.
  RETURN NO-APPLY.
END.
ELSE RUN SUPER.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE SaveRecord C-Win 
PROCEDURE SaveRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF VAR hCurrObject AS HANDLE NO-UNDO.
DEF VAR iAntReg     AS INT    NO-UNDO.

IF iTab = 2 THEN DO WITH FRAME frmDetalj:

  IF int(ProfilNr:screen-value) = 0 THEN
  DO:
      MESSAGE "Prisprofil ikke angitt."
          VIEW-AS ALERT-BOX WARNING BUTTONS OK.
      APPLY "ENTRY" TO ProfilNr.
      RETURN NO-APPLY.
  END.
  IF DYNAMIC-FUNCTION("getFieldValues","PrisProfil","WHERE ProfilNr = int(" + ProfilNr:SCREEN-VALUE + ")","KortNavn") = ? THEN
  DO:
      MESSAGE "Ukjent prisprofil " + ProfilNr:SCREEN-VALUE + "."
          VIEW-AS ALERT-BOX WARNING BUTTONS OK  TITLE "Lagringskontroll".
      APPLY "ENTRY" TO ProfilNr.
      RETURN NO-APPLY.
  END.
  IF (VarebehBeskrivelse:screen-value) = "" THEN
  DO:
      MESSAGE "Varebeh mangler beskrivelse."
          VIEW-AS ALERT-BOX WARNING BUTTONS OK.
      APPLY "ENTRY" TO VarebehBeskrivelse.
      RETURN NO-APPLY.
  END.
        
  IF Oppdatert:CHECKED THEN
    DYNAMIC-FUNCTION("setAttribute",hFieldMap,"BufferExtraValues",
                      DYNAMIC-FUNCTION("getASuserid") + "|" + STRING(TODAY) + "|" + VarebehType:SCREEN-VALUE + "|" + ButikkListe:SCREEN-VALUE). 
  ELSE
    DYNAMIC-FUNCTION("setAttribute",hFieldMap,"BufferExtraValues","||" + VarebehType:SCREEN-VALUE + "|" + ButikkListe:SCREEN-VALUE).

  RUN SUPER.
END.
ELSE IF iTab = 3 AND DYNAMIC-FUNCTION("getCurrentObject") = hBestHodeToolbar THEN DO:
  DYNAMIC-FUNCTION("setAttribute",hFieldMapBestHode,"bufferextravalues",
                   STRING(hFieldMap:BUFFER-FIELD("VarebehNr"):BUFFER-VALUE) + "|" +
                   STRING(hFieldMapLinje:BUFFER-FIELD("ArtikkelNr"):BUFFER-VALUE) + "|" +
                   DYNAMIC-FUNCTION("getFieldValues","StrType","WHERE StrTypeId = " + STRING(hFieldMapLinje:BUFFER-FIELD("StrTypeId"):BUFFER-VALUE),"Alfafordeling") + "|" +
                   cCL).
  hCurrObject = hBestHodeToolbar.

  IF DYNAMIC-FUNCTION("getToolbarState",hBestHodeToolbar) NE "new" THEN DO:

    RUN SjekkReg (OUTPUT bOK,OUTPUT iAntReg).
    IF NOT bOk THEN RETURN.

    IF iAntReg > 0 THEN DO:
      IF DYNAMIC-FUNCTION("DoMessage",0,4,"Vil du registrere strekkoder?","","") = 6 THEN DO:
        THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
        RUN Strekkode.w (THIS-PROCEDURE).
        THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.
      END.
message "Gurre var her" view-as alert-box.      
    END.
    RUN LagreBestLinje.
  END.
  ELSE RUN SUPER.

END.
ELSE RUN SUPER.

IF iTab = 3 AND hBestHodeToolbar = hCurrObject AND tbRepeat:INPUT-VALUE IN FRAME frmLinje AND bAlt-S THEN
  APPLY "alt-s" TO hWindow.
ELSE bAlt-S = FALSE.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE SetAltS-param C-Win 
PROCEDURE SetAltS-param :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT PARAM ihAltS AS HANDLE NO-UNDO.

DYNAMIC-FUNCTION("InitScreen" IN ihAltS,"LevNr," + sokLevNr:SCREEN-VALUE IN FRAME frmLinje + ",LevKod").
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE SettGodkjenningRecord C-Win 
PROCEDURE SettGodkjenningRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
IF hFieldMapRegStat:AVAIL AND hFieldMapRegStat:BUFFER-FIELD("Godkjent"):BUFFER-VALUE = FALSE THEN DO:
  iReturn = DYNAMIC-FUNCTION("DoMessage",0,1,"Godkjenn registreringer for butikk &1" + CHR(10) +
                                             "Godkjenning innebærer at ingen flere registreringer kan gjøres for vareboken på denne butikken",
                                             "Godkjenn registrering",hFieldMapRegStat:BUFFER-FIELD("ButNamn"):BUFFER-VALUE).
  IF iReturn = 1 THEN DO:
    hFieldMapRegStat:BUFFER-FIELD("Godkjent"):BUFFER-VALUE = TRUE.
    DYNAMIC-FUNCTION("DoUpdate","VarebehLinjeThode",
                  "ignore",
                  "",
                  hFieldMapRegStat:BUFFER-FIELD("RowIdent1"):BUFFER-VALUE,
                  "Godkjent",
                  STRING(TRUE),
                  TRUE).
    hBrowseRegStat:REFRESH().
  END.
END.
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE SettSensitive C-Win 
PROCEDURE SettSensitive :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DO WITH FRAME frmLinje:
  IF Oppdatert:SCREEN-VALUE IN FRAME frmDetalj = "yes" THEN DO:
    SettUtvalgSensitive(FALSE).
    IF VALID-HANDLE(hUtvalg) THEN
      DYNAMIC-FUNCTION("setEnableBtnSendUtvalg" IN hUtvalg,FALSE).
  END.
  ELSE DO:
    SettUtvalgSensitive(TRUE).
    IF VALID-HANDLE(hUtvalg) THEN
      DYNAMIC-FUNCTION("setEnableBtnSendUtvalg" IN hUtvalg,TRUE).
  END.
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE SjekkReg C-Win 
PROCEDURE SjekkReg :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF OUTPUT PARAM obReg AS LOG NO-UNDO.
DEF OUTPUT PARAM oiAnt AS INT NO-UNDO.

DEF VAR wRow AS INT NO-UNDO.
DEF VAR wCol AS INT NO-UNDO.
DEF VAR iAnt AS INT NO-UNDO.

DO wRow = chGrid:FixedRows TO chGrid:Rows - 1:
  DO wCol = chGrid:FixedCols TO chGrid:Cols - 1:
    IF INT(chGrid:TextMatrix(wRow,wCol)) NE 0 THEN
      ASSIGN oiAnt = oiAnt + INT(chGrid:TextMatrix(wRow,wCol))
             obReg = TRUE
             .
  END.
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE SkiftStrTypeRecord C-Win 
PROCEDURE SkiftStrTypeRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF VAR iocColValues AS CHAR NO-UNDO.

RUN gstrtype.w (INPUT-OUTPUT iocColValues,
                "", /* cFelt */
                "", /* cVerdier */
                "", /*cStart */
                0,  /* iAvdelingNr */
                0,   /* iHg */
                "").

IF iocColValues NE "" THEN DO:
  IF NOT DYNAMIC-FUNCTION("DoUpdate","ArtBas","=artbas_sjekk_skift_strtype.p",
                          "ArtikkelNr",
                          STRING(hBrowseLinje:QUERY:GET-BUFFER-HANDLE(1):BUFFER-FIELD("ArtikkelNr"):BUFFER-VALUE),
                          "StrTypeId",
                          ENTRY(2,iocColValues,CHR(1)),
                          TRUE) THEN 
    DYNAMIC-FUNCTION("DoMessage",0,0,DYNAMIC-FUNCTION("getTransactionMessage"),"Feil","").
END.
END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE SlettFraUtvalg C-Win 
PROCEDURE SlettFraUtvalg :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DO ix = 1 TO hBrowseLinje:NUM-SELECTED-ROWS:
  IF hBrowseLinje:FETCH-SELECTED-ROW(ix) THEN 
      DYNAMIC-FUNCTION('doDelete','VarebehLinje','ignore','',hBrowseLinje:QUERY:GET-BUFFER-HANDLE(1):BUFFER-FIELD('RowIdent1'):BUFFER-VALUE,FALSE).
END.
DYNAMIC-FUNCTION('doCommit',FALSE).

APPLY "VALUE-CHANGED":U TO hBrowseListe.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE StartUtvalgRecord C-Win 
PROCEDURE StartUtvalgRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
SESSION:SET-WAIT-STATE("general").
IF NOT VALID-HANDLE(hUtvalg) THEN DO:
  RUN wtmpartbas.w PERSIST SET hUtvalg.
  DYNAMIC-FUNCTION("setTellingIsMaster" IN hUtvalg,TRUE).
  RUN InitializeObject IN hUtvalg.
/*     InitUtvalgToTelling(hUtvalg,NO). /* NO: Utvalg er IKKE master */  */
END.
DYNAMIC-FUNCTION("InitFromVarebeh" IN hUtvalg, THIS-PROCEDURE).

SESSION:SET-WAIT-STATE("").

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE StrekkodeRecord C-Win 
PROCEDURE StrekkodeRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
IF NOT VALID-HANDLE(hStrekkode) THEN
  RUN Strekkode.w PERSIST SET hStrekkode (THIS-PROCEDURE).

RUN MoveToTop IN hStrekkode.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE undoRecord C-Win 
PROCEDURE undoRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
IF DYNAMIC-FUNCTION("getCurrentObject") = hBestHodeToolbar THEN 
  RUN DeleteRecord.
ELSE RUN SUPER.

/*   IF iTab < 3 THEN DO WITH FRAME frmDetalj:       */
/*       ASSIGN                                      */
/*           VarebehNr:SENSITIVE      = FALSE        */
/* /*           ProfilNr:SENSITIVE       = FALSE  */ */
/* /*           btnSokProfilNr:SENSITIVE = FALSE  */ */
/*           .                                       */
/*   END.                                            */

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE VelgButikker C-Win 
PROCEDURE VelgButikker :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF INPUT  PARAM icMode AS CHAR NO-UNDO.
DEF OUTPUT PARAM obOk   AS LOG NO-UNDO.

DEF VAR cMineButikker AS CHAR NO-UNDO.
DEF VAR cRowIdList    AS CHAR NO-UNDO.
DEF VAR cIdList       AS CHAR NO-UNDO.

DO WITH FRAME frmDetalj:
  IF DYNAMIC-FUNCTION("runproc","mine_butikker.p",DYNAMIC-FUNCTION("getASuserId") + ",2",?) THEN
    cMineButikker = DYNAMIC-FUNCTION("getTransactionMessage").

  IF icMode NE "new" 
     AND hFieldMap:AVAIL 
     AND hFieldMap:BUFFER-FIELD("ButikkListe"):BUFFER-VALUE NE "" THEN
    ASSIGN cRowIdList = DYNAMIC-FUNCTION("getRowIdList","Butiker","","WHERE CAN-DO('" + hFieldMap:BUFFER-FIELD("ButikkListe"):BUFFER-VALUE + "',STRING(butik))")
           cIdList    = REPLACE(hFieldMap:BUFFER-FIELD("ButikkListe"):BUFFER-VALUE,",","|").
  
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.
  RUN JBoxSelector.w (THIS-PROCEDURE,0,
                      "Butiker;Butik;Butnamn",
                      "WHERE CAN-DO('" + cMineButikker + "',STRING(Butik))",
                      INPUT-OUTPUT cRowIdList,
                      "Butik",
                      INPUT-OUTPUT cIdList,
                      "","",
                      OUTPUT bOK).
  THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.

  IF bOk THEN DO:
    DO ix = 1 TO NUM-ENTRIES(ButikkListe:SCREEN-VALUE):
      IF NOT CAN-DO(REPLACE(cIdList,"|",","),ENTRY(ix,ButikkListe:SCREEN-VALUE)) THEN 
        bOK = FALSE.
    END.
    IF NOT bOK AND DYNAMIC-FUNCTION("getToolbarState",hUpdToolbar) NE "new" THEN DO:
      IF DYNAMIC-FUNCTION("DoMessage",0,1,"Hvis du fjerner en butikk så slettes alle bestillinger for denne (disse)" + CHR(10) +
                                          "Er du sikker på at du vil gjøre dette?","Advarsel","") = 1 THEN DO:
        IF NOT DYNAMIC-FUNCTION("runproc","varebehbest_sjekk_mot_butikkliste.p",
                                 ButikkListe:SCREEN-VALUE + ";" + cIdList + ";" + STRING(hFieldMap:BUFFER-FIELD("ButikkListe"):BUFFER-VALUE),?) THEN
          DYNAMIC-FUNCTION("DoMessage",0,0,DYNAMIC-FUNCTION("getTransactionMessage"),"Feil","").
      END.
      ELSE RETURN NO-APPLY.
    END.
    ButikkListe:SCREEN-VALUE = REPLACE(cIdList,"|",",").
    APPLY "any-printable" TO VarebehBeskrivelse.
    obOK = TRUE.
  END.
  ELSE obOK = FALSE.   
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE VisBestRecord C-Win 
PROCEDURE VisBestRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEF VAR ioRecId AS RECID NO-UNDO.

ioRecId = DYNAMIC-FUNCTION("getRecId","BestHode",hFieldMapBestHode:BUFFER-FIELD("RowIdent2"):BUFFER-VALUE).

THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.

RUN w-gridord.w (DYNAMIC-FUNCTION("getRecId","ArtBas",hFieldMapLinje:BUFFER-FIELD("RowIdent2"):BUFFER-VALUE),
                 INPUT-OUTPUT ioRecId,
                 "").

IF hFieldMapBestHode:AVAIL THEN
  DYNAMIC-FUNCTION("refreshRowids",hBrowseBestHode,hFieldMapBestHode:BUFFER-FIELD("Rowident1"):BUFFER-VALUE).

THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE VisInnlevRecord C-Win 
PROCEDURE VisInnlevRecord :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/

DEF VAR ioRecId AS RECID NO-UNDO.

ioRecId = DYNAMIC-FUNCTION("getRecId","BestHode",hFieldMapBestHode:BUFFER-FIELD("RowIdent2"):BUFFER-VALUE).

THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = FALSE.

RUN w-gridinnlev.w  
                (DYNAMIC-FUNCTION("getRecId","ArtBas",hFieldMapLinje:BUFFER-FIELD("RowIdent2"):BUFFER-VALUE),
                 INPUT-OUTPUT ioRecId,
                 "").

IF hFieldMapBestHode:AVAIL THEN
  DYNAMIC-FUNCTION("refreshRowids",hBrowseBestHode,hFieldMapBestHode:BUFFER-FIELD("Rowident1"):BUFFER-VALUE).

THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = TRUE.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE VisMiniBilde C-Win 
PROCEDURE VisMiniBilde :
/*------------------------------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
------------------------------------------------------------------------------*/
DEFINE INPUT  PARAMETER cBildeFil AS CHARACTER  NO-UNDO.

chIMAGE-Sko:Picbuf:CLEAR(2).

IF cBildeFil = "" OR cBildeFil = ? THEN
  RETURN.
ELSE 
  cBildeFil = TRIM(cBildeKatalog,"/") + "/mini" + cBildeFil.
RUN BildeTilDisk (INPUT-OUTPUT cBildeFil).

IF SEARCH(cBildeFil) <> ? AND cBildeFil NE "" THEN DO:
  ASSIGN chIMAGE-Sko:Picbuf:FILENAME = cBildeFil
         chIMAGE-Sko:Picbuf:AutoScale = TRUE.
         chIMAGE-Sko:Picbuf:LOAD.
END.

END PROCEDURE.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

/* ************************  Function Implementations ***************** */

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION FiksStorl C-Win 
FUNCTION FiksStorl RETURNS CHARACTER
  ( input wStorl as char ) :
/*------------------------------------------------------------------------------
  Purpose:  Formaterer størrelsen korrekt etter SkoTex standard.
    Notes:  
------------------------------------------------------------------------------*/
 assign
    wStorl = trim(wStorl)
    wStorl = caps(wStorl)
    wStorl = if (length(wStorl) = 1 or 
                 length(wStorl) = 3
                 ) 
                then " " + wStorl
                else wStorl.          

  /* Bytter ut eventuelle comma med punkt. */
  if index(wStorl,",") <> 0 then
    OVERLAY(wStorl, index(wStorl,","), 1, "CHARACTER") = ".".

  RETURN wStorl.   /* Function return value. */

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION FreezeWin C-Win 
FUNCTION FreezeWin RETURNS LOGICAL
  ( INPUT ibFreeze AS LOG ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
THIS-PROCEDURE:CURRENT-WINDOW:SENSITIVE = NOT ibFreeze.
  
RETURN TRUE.

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION getArtNr C-Win 
FUNCTION getArtNr RETURNS DECIMAL
  ( /* parameter-definitions */ ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
IF hFieldMapLinje:AVAIL THEN
  RETURN hFieldMapLinje:BUFFER-FIELD("ArtikkelNr"):BUFFER-VALUE.
ELSE
  RETURN 0.00. 

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION getLevNr C-Win 
FUNCTION getLevNr RETURNS CHARACTER
  ( /* parameter-definitions */ ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
IF sokLevNr:SCREEN-VALUE IN FRAME frmLinje NE "0" THEN
  RETURN sokLevNr:SCREEN-VALUE IN FRAME frmLinje. 
ELSE 
  RETURN ListeSokLevNr:SCREEN-VALUE IN FRAME frmFilter. 

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION getStorl C-Win 
FUNCTION getStorl RETURNS CHARACTER
  ( /* parameter-definitions */ ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
DEF VAR iRow      AS INT  NO-UNDO.
DEF VAR iCol      AS INT  NO-UNDO.
DEF VAR cTmpStorl AS CHAR NO-UNDO.

DO iRow = 1 TO chGrid:Rows - 1:
  IF NOT Registrerat(iRow) THEN
      NEXT.
  DO iCol = 2 TO chGrid:Cols - 1:
    IF INT(chGrid:TextMatrix(iRow,iCol)) = 0 THEN NEXT.

    cTmpStorl = IF NOT CAN-DO(cTmpStorl,TRIM(chGrid:TextMatrix(0,iCol))) THEN
                  cTmpStorl + TRIM(chGrid:TextMatrix(0,iCol)) + ","
                ELSE cTmpStorl.
  END.
END.

IF cTmpStorl = "" AND hBrowseBestHode:QUERY:GET-BUFFER-HANDLE(1):AVAIL THEN
  cTmpStorl = REPLACE(REPLACE(hBrowseBestHode:QUERY:GET-BUFFER-HANDLE(1):BUFFER-FIELD("AlfaFordeling"):BUFFER-VALUE," ",""),"  ","").
          
RETURN TRIM(cTmpStorl,",").

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION getVarebehNr C-Win 
FUNCTION getVarebehNr RETURNS DECIMAL
  ( /* parameter-definitions */ ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
  DO WITH FRAME frmDetalj:
      RETURN dec(VarebehNr:SCREEN-VALUE).   /* Function return value. */
  END.

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION InitUtvalgToVarebeh C-Win 
FUNCTION InitUtvalgToVarebeh RETURNS LOGICAL
  ( INPUT ihUtvalg         AS HANDLE,
    INPUT ibUtvalgIsMaster AS LOG ) :
/*------------------------------------------------------------------------------
  Purpose: Enable / disable buttons according to who is master
    Notes:  
------------------------------------------------------------------------------*/
DO WITH FRAME frmLinje:
  ASSIGN hUtvalg                    = ihUtvalg
         bUtvalgIsMaster            = ibUtvalgIsMaster
         .
  SettUtvalgSensitive(IF bUtvalgIsMaster THEN FALSE ELSE TRUE).
  SettHentUtvalgSensitive(IF VALID-HANDLE(hUtvalg) THEN TRUE ELSE FALSE).
END.
IF NOT ibUtvalgIsMaster THEN
  APPLY "value-changed" TO hBrowseListe.
  
RETURN TRUE.   /* Function return value. */

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION Registrerat C-Win 
FUNCTION Registrerat RETURNS LOGICAL
  ( INPUT ipRow AS INTEGER ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
DEF VAR wRow AS INT NO-UNDO.
DEF VAR wCol AS INT NO-UNDO.
DEF VAR iAnt AS INT NO-UNDO.


IF ipRow = ? THEN DO wRow = chGrid:FixedRows TO chGrid:Rows - 1:
  DO wCol = chGrid:FixedCols TO chGrid:Cols - 1:
    IF INT(chGrid:TextMatrix(wRow,wCol)) NE 0 THEN
       RETURN TRUE.
  END.
END.
ELSE DO wCol = chGrid:FixedCols TO chGrid:Cols - 1:
    IF INT(chGrid:TextMatrix(ipRow,wCol)) > 0 OR INT(chGrid:TextMatrix(ipRow,wCol)) < 0 THEN
       RETURN TRUE.
END.


RETURN FALSE.   /* Function return value. */

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION SetTabStrip C-Win 
FUNCTION SetTabStrip RETURNS LOGICAL
  ( /* parameter-definitions */ ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
DEF VAR iy            AS INT NO-UNDO.
DEF VAR cTabStripList AS CHAR NO-UNDO.

/* cTabStripList = DYNAMIC-FUNCTION("getFieldList","JBoxGenCode;cCodeValue;cMisc1;cMisc2",               */
/*                                   "WHERE cCodeType = 'JBoxQueryTabs'" +                               */
/*                                   "  AND cLanguage = '" + DYNAMIC-FUNCTION("getLanguageCode") + "'" + */
/*                                   " BY cMisc1") NO-ERROR.                                             */

/* cTabStripList = "Liste|Detalj|Registrering|Statistikk". */
cTabStripList = "Liste|Detalj|Registrering".

IF cTabStripList NE "" THEN DO:
  DO ix = 9 TO 1 BY -1:
    chTabStrip:TabStrip:Tabs:Remove(ix) NO-ERROR.
  END.
  DO ix = 1 TO NUM-ENTRIES(cTabStripList,"|"):
    iy = iy + 1.
    chTabStrip:TabStrip:Tabs:ADD(iy).
    chTabStrip:TabStrip:Tabs:Item(iy):Caption = ENTRY(ix,cTabStripList,"|").
  END.
END.

RETURN TRUE.

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION SettHentUtvalgSensitive C-Win 
FUNCTION SettHentUtvalgSensitive RETURNS LOGICAL
  ( INPUT ibSensitive AS LOG ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
DEF VAR hWidget  AS HANDLE NO-UNDO.
DO ix = 1 TO NUM-ENTRIES(cBtnHentUtvalgHandles):
  hWidget = WIDGET-HANDLE(ENTRY(ix,cBtnHentUtvalgHandles)).
  IF hWidget:TYPE = "button" THEN DO:
    hWidget:HIDDEN = NOT ibSensitive.
    IF NOT hWidget:HIDDEN THEN
      hWidget:SENSITIVE = TRUE.
  END.
  ELSE
    hWidget:SENSITIVE = ibSensitive.
END.
RETURN TRUE.   /* Function return value. */

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION SettLevUkeEllerDag C-Win 
FUNCTION SettLevUkeEllerDag RETURNS LOGICAL
  ( /* parameter-definitions */ ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
DO WITH FRAME frmLinje:
  IF hFieldMap:AVAIL THEN DO:
    IF hFieldMap:BUFFER-FIELD("VareBehType"):BUFFER-VALUE = iBestVarebeh THEN DO:
      ASSIGN levUke:HIDDEN             = FALSE
             fi-cAndreBestLabel:HIDDEN = FALSE
             hBrowseAndreBest:HIDDEN   = FALSE
             rectBrwAndreBest:HIDDEN   = FALSE
             .
      DO ix = 1 TO hBrowseBestHode:NUM-COLUMNS:
        hBrowseBestHode:GET-BROWSE-COLUMN(ix):VISIBLE = CAN-DO(cBestViewFields,hBrowseBestHode:GET-BROWSE-COLUMN(ix):NAME).
      END.        
      Grid:MOVE-AFTER(LevUke:HANDLE).
    END.
    ELSE DO:
      ASSIGN levUke:HIDDEN             = TRUE
             fi-cAndreBestLabel:HIDDEN = TRUE
             hBrowseAndreBest:HIDDEN   = TRUE
             rectBrwAndreBest:HIDDEN   = TRUE
             .
      DO ix = 1 TO hBrowseBestHode:NUM-COLUMNS:
        hBrowseBestHode:GET-BROWSE-COLUMN(ix):VISIBLE = CAN-DO(cInnlevViewFields,hBrowseBestHode:GET-BROWSE-COLUMN(ix):NAME).
      END.
    END.
  END.
  IF hFieldMapBestHode:AVAIL AND hFieldMapBestHode:BUFFER-FIELD("BestNr"):BUFFER-VALUE NE 0 THEN
    levUke:SENSITIVE  = FALSE.

END.

RETURN TRUE.

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION SettUtvalgSensitive C-Win 
FUNCTION SettUtvalgSensitive RETURNS LOGICAL
  ( INPUT ibSensitive AS LOG ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
DEF VAR hWidget  AS HANDLE NO-UNDO.
DO ix = 1 TO NUM-ENTRIES(cBtnUtvalgHandles):
  hWidget = WIDGET-HANDLE(ENTRY(ix,cBtnUtvalgHandles)).
  hWidget:SENSITIVE = ibSensitive.
END.
RETURN TRUE.   /* Function return value. */

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION SkrivEtikett C-Win 
FUNCTION SkrivEtikett RETURNS LOGICAL
  ( INPUT icListe AS CHAR ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
DEF VAR cArtikkelEti    AS CHAR NO-UNDO.
DEF VAR cEtiketter      AS CHAR NO-UNDO.
DEF VAR cAntallEti      AS CHAR NO-UNDO.
DEF VAR cIndividNr      AS CHAR NO-UNDO.
DEF VAR iCount          AS INT  NO-UNDO.
DEF VAR cArtEANlist     AS CHAR NO-UNDO.
DEF VAR cArtANTlist     AS CHAR NO-UNDO.
DEF VAR cArtINDlist     AS CHAR NO-UNDO.
DEF VAR iTotAnt         AS INT  NO-UNDO.

IF NUM-ENTRIES(icListe,"|") < 4 THEN RETURN FALSE.

ASSIGN icListe      = SUBSTR(icListe,8)
       cArtikkelEti = ENTRY(1,icListe,"|")
       cEtiketter   = ENTRY(2,icListe,"|")
       cAntallEti   = ENTRY(3,icListe,"|")
       cIndividNr   = ENTRY(4,icListe,"|")
       .

IF cArtikkelEti <> "" THEN DO:
  DO ix = 1 TO NUM-ENTRIES(cArtikkelEti,CHR(1)):
    ASSIGN cArtEANlist = ENTRY(ix,cEtiketter,CHR(1))
           cArtANTlist = ENTRY(ix,cAntallEti,CHR(1))
           cArtINDlist = ENTRY(ix,cIndividNr,CHR(1))
           .
    IF cArtEANlist <> "" THEN 
      DO iCount = 1 TO NUM-ENTRIES(cArtANTlist):
        IF ENTRY(iCount,cArtEANlist) <> "" AND INT(ENTRY(iCount,cArtANTlist)) > 0 THEN
          iTotAnt = iTotAnt + INT(ENTRY(iCount,cArtANTlist)).
      END.
  END.

  IF iTotAnt LE 0 THEN RETURN FALSE.

  DO ix = 1 TO NUM-ENTRIES(cArtikkelEti,CHR(1)):
    ASSIGN cArtEANlist = ENTRY(ix,cEtiketter,CHR(1))
           cArtANTlist = ENTRY(ix,cAntallEti,CHR(1))
           cArtINDlist = ENTRY(ix,cIndividNr,CHR(1))
           .
    IF cArtEANlist <> "" THEN DO:
      IF NOT VALID-HANDLE(hEtikettVindu) THEN
          RUN w-TmpEtikett.w PERSISTENT SET hEtikettVindu (THIS-PROCEDURE:CURRENT-WINDOW).
      IF VALID-HANDLE(hEtikettVindu) THEN 
        DO iCount = 1 TO NUM-ENTRIES(cArtANTlist):
          IF ENTRY(iCount,cArtEANlist) <> "" AND INT(ENTRY(iCount,cArtANTlist)) > 0 THEN
            RUN NyEtikett IN hEtikettVindu (ENTRY(iCount,cArtEANlist),INT(ENTRY(iCount,cArtANTlist)),INT(ENTRY(iCount,cArtINDlist))).
        END.
    END.
  END.
END.


RETURN TRUE.

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION TabStripChanged C-Win 
FUNCTION TabStripChanged RETURNS LOGICAL
  ( INPUT iiTab AS INT ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
cState = DYNAMIC-FUNCTION('getToolbarState',hUpdToolBar).

DO WITH FRAME {&FRAME-NAME}:

  IF iiTab > 10 THEN DO:
    iiTab = iiTab - 10.
    chTabStrip:TabStrip:Tabs:ITEM(iiTab):SELECTED = TRUE.
  END.

  iTab = iiTab.

  IF iTab < 3 THEN DO:
    DYNAMIC-FUNCTION("ReplaceObjectLink",hUpdToolbar,hFieldMap).
    DYNAMIC-FUNCTION("ReplaceObjectLink",hUpdToolbar,hBrowseListe).
    DYNAMIC-FUNCTION("DeleteObjectLink",hBrowseListe,hBrowseLinje).
    DYNAMIC-FUNCTION("setCurrentObject",hBrowseListe).
    RUN DisplayRecord.

    IF VALID-HANDLE(hNavVarebehToolBar) THEN DO:
      DYNAMIC-FUNCTION("DeleteObject",hNavVarebehToolBar).
      hNavVarebehToolBar = ?.
    END.
  END.

  IF iiTab = 1 THEN
  DO:
      FRAME frmListe:MOVE-TO-TOP().
      FRAME frmFilter:MOVE-TO-TOP().
      APPLY "entry" TO hBrowseListe.
  END.
  ELSE IF iiTab = 2 THEN DO:
    FRAME frmDetalj:MOVE-TO-TOP().
    IF CAN-DO('new',cstate) THEN
      ASSIGN ProfilNr:SENSITIVE       = TRUE 
             btnSokProfilNr:SENSITIVE = TRUE
            .
  END.
  ELSE IF iiTab = 3 THEN DO:
    FRAME frmLinje:MOVE-TO-TOP().

    DYNAMIC-FUNCTION("replaceObjectLink",hBrowseLinje,hUpdToolbar).
    DYNAMIC-FUNCTION("replaceObjectLink",hFieldMapLinje,hUpdToolbar).

    DYNAMIC-FUNCTION("createParentLink",hBrowseLinje,hBrowseListe,'VarebehNr').
    SettLevUkeEllerDag().

    IF NOT hFieldMap:AVAIL THEN 
      hBrowseListe:SELECT-ROW(hBrowseListe:FOCUSED-ROW) NO-ERROR.

    APPLY "value-changed" TO hBrowseListe.

    APPLY "ENTRY":U TO hBrowseLinje.

  END.

  IF iiTab > 2 AND hFieldMap:AVAIL AND NOT VALID-HANDLE(hNavVarebehToolBar) THEN DO:
    hNavVarebehToolBar = DYNAMIC-FUNCTION("NewToolBar",
                      rectNavVarebeh:HANDLE,            /* Rectangle to define coordinates for toolbar */
                      "Naviger",                          /* Corresponding menu label - no menu if blank */
                      "Last;Siste Vareh.bok,Next;Neste Vareh.bok,Prev;Forrige Vareh.bok,First;Første Vareh.bok",
                                                      /* Buttons / Menu items: action;label;tooltip;Method;image,action;label.. 
                                                         Any number of properties accepted (one ok - if predef. action) */
                      "right").                       /* Misc - for something I might need in next version.. */

    DYNAMIC-FUNCTION("CreateObjectLink",hNavVarebehToolBar,hBrowseListe).
    DYNAMIC-FUNCTION("CreateObjectLink",hNavVarebehToolBar,hFieldMap).
    DYNAMIC-FUNCTION("setToolbar",hNavVarebehToolBar,"enable").
    DYNAMIC-FUNCTION("setAddMoveX",THIS-PROCEDURE:CURRENT-WINDOW, FRAME {&FRAME-NAME}:HANDLE, 
                                  "rectNavVarebeh," +
                                  DYNAMIC-FUNCTION("getToolbarNames",hNavVarebehToolBar,"")    
                                  ).

    IF hFieldMapLinje:AVAIL AND STRING(hFieldMapLinje:ROWID) = DYNAMIC-FUNCTION("getAttribute",hBrowseLinje,"firstrowid") THEN
      DYNAMIC-FUNCTION("setToolbar",hUpdToolbar,"first").
    ELSE IF hFieldMapLinje:AVAIL AND STRING(hFieldMapLinje:ROWID) = DYNAMIC-FUNCTION("getAttribute",hBrowseLinje,"lastrowid") THEN
      DYNAMIC-FUNCTION("setToolbar",hUpdToolbar,"last").

    IF hFieldMap:AVAIL AND STRING(hFieldMap:ROWID) = DYNAMIC-FUNCTION("getAttribute",hBrowseListe,"firstrowid") THEN
      DYNAMIC-FUNCTION("setToolbar",hNavVarebehToolBar,"first").
    ELSE IF hFieldMap:AVAIL AND STRING(hFieldMap:ROWID) = DYNAMIC-FUNCTION("getAttribute",hBrowseListe,"lastrowid") THEN
      DYNAMIC-FUNCTION("setToolbar",hNavVarebehToolBar,"last").

  END.

  RETURN TRUE.
END.
END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION UtvalgIsMaster C-Win 
FUNCTION UtvalgIsMaster RETURNS LOGICAL
  ( /* parameter-definitions */ ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/

  RETURN bUtvalgIsMaster.

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _FUNCTION ViewStat C-Win 
FUNCTION ViewStat RETURNS LOGICAL
  ( INPUT ibView AS LOG ) :
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
DEF VAR cStatFieldValues  AS CHAR NO-UNDO.
DEF VAR hField            AS HANDLE NO-UNDO.
DEF VAR iCount            AS INT NO-UNDO.

IF ibView THEN DO:
  cStatFieldValues = DYNAMIC-FUNCTION("getQueryStatFieldValues").
  
  DO ix = 1 TO NUM-ENTRIES(cStatFieldValues,";"):
    IF ENTRY(1,ENTRY(ix,cStatFieldValues,";"),"|") = "rowcount" THEN
      ASSIGN iCount            = INT(ENTRY(2,ENTRY(ix,cStatFieldValues,";"),"|"))
             hBrowseLinje:HELP = ENTRY(2,ENTRY(ix,cStatFieldValues,";"),"|").
    ELSE IF CAN-DO(cPrefixedStatFields,"tot_" + ENTRY(1,ENTRY(ix,cStatFieldValues,";"),"|")) THEN 
      ASSIGN hField = WIDGET-HANDLE(ENTRY(LOOKUP(ENTRY(1,ENTRY(ix,cStatFieldValues,";"),"|"),cStatFieldNames),cStatFieldHandles))
             hField:SCREEN-VALUE = ENTRY(2,ENTRY(ix,cStatFieldValues,";"),"|")
             .
    ELSE IF CAN-DO(cPrefixedStatFields,"avg_" + ENTRY(1,ENTRY(ix,cStatFieldValues,";"),"|")) THEN DO:
      ASSIGN hField = WIDGET-HANDLE(ENTRY(LOOKUP(ENTRY(1,ENTRY(ix,cStatFieldValues,";"),"|"),cStatFieldNames),cStatFieldHandles))
             hField:SCREEN-VALUE = STRING(DEC(ENTRY(2,ENTRY(ix,cStatFieldValues,";"),"|")) / iCount)
             .
    END.
    ELSE IF CAN-DO(cStatFieldNames,ENTRY(1,ENTRY(ix,cStatFieldValues,";"),"|")) THEN 
      ASSIGN hField = WIDGET-HANDLE(ENTRY(LOOKUP(ENTRY(1,ENTRY(ix,cStatFieldValues,";"),"|"),cStatFieldNames),cStatFieldHandles))
             hField:SCREEN-VALUE = ENTRY(2,ENTRY(ix,cStatFieldValues,";"),"|")
             .
  END.
END.
ELSE 
  DO ix = 1 TO NUM-ENTRIES(cStatFieldHandles):
    ASSIGN hField = WIDGET-HANDLE(ENTRY(ix,cStatFieldHandles))
           hField:SCREEN-VALUE = "".
  END.

RETURN TRUE.

END FUNCTION.

/* _UIB-CODE-BLOCK-END */
&ANALYZE-RESUME

